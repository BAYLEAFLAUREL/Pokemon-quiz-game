<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Knowledge Quest</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  html,body{
    width:100%;height:100%;overflow:hidden;background:#0a0a1a;touch-action:none;
    /* Support safe areas for notch/home-bar devices */
    padding-top:env(safe-area-inset-top);
    padding-bottom:env(safe-area-inset-bottom);
    padding-left:env(safe-area-inset-left);
    padding-right:env(safe-area-inset-right);
  }
  #gameCanvas{
    display:block;position:fixed;top:0;left:0;
    width:100vw;height:100vh;
    image-rendering:pixelated;image-rendering:crisp-edges;
  }
  #ui{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;}

  /* D-PAD ‚Äî always anchored to actual visible bottom-left using JS-set vars */
  #dpad{
    position:fixed;
    bottom:max(20px, calc(20px + env(safe-area-inset-bottom)));
    left:max(16px, calc(16px + env(safe-area-inset-left)));
    pointer-events:all;touch-action:none;z-index:1000;
    width:132px;height:132px;
  }
  #dpad-center{position:absolute;top:44px;left:44px;width:44px;height:44px;background:rgba(60,50,120,0.5);border-radius:50%;}
  .dpad-btn{
    position:absolute;width:44px;height:44px;
    background:rgba(40,35,80,0.85);border:2px solid rgba(120,100,200,0.7);
    border-radius:8px;display:flex;align-items:center;justify-content:center;
    font-size:18px;color:rgba(200,180,255,0.9);user-select:none;cursor:pointer;
    transition:background 0.1s;
    /* Larger touch target */
    -webkit-touch-callout:none;
  }
  .dpad-btn:active,.dpad-btn.pressed{background:rgba(100,80,200,0.9);}
  #dpad-up{top:0;left:44px;}
  #dpad-down{top:88px;left:44px;}
  #dpad-left{top:44px;left:0;}
  #dpad-right{top:44px;left:88px;}

  #action-btns{
    position:fixed;
    bottom:max(20px, calc(20px + env(safe-area-inset-bottom)));
    right:max(16px, calc(16px + env(safe-area-inset-right)));
    display:grid;grid-template-columns:1fr 1fr;gap:8px;
    pointer-events:all;z-index:1000;
  }
  .action-btn{width:68px;height:68px;border-radius:12px;border:2px solid rgba(120,100,200,0.7);background:rgba(30,25,60,0.9);color:#fff;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;transition:all 0.1s;text-align:center;line-height:1.3;}
  .action-btn:active{transform:scale(0.93);}
  .btn-atk{border-color:#dd5555;color:#ff8888;}
  .btn-heavy{border-color:#ffaa00;color:#ffcc44;}
  .btn-dodge{border-color:#44dd88;color:#88ffaa;}
  .btn-block{border-color:#4488ff;color:#88bbff;}

  #answer-panel{
    position:fixed;bottom:0;left:0;width:100%;
    padding-bottom:max(10px, env(safe-area-inset-bottom));
    background:rgba(8,6,22,0.97);border-top:2px solid rgba(80,60,160,0.8);
    padding:10px;padding-bottom:max(14px,calc(10px + env(safe-area-inset-bottom)));
    z-index:200;display:none;pointer-events:all;
    max-height:65vh;overflow-y:auto;
  }
  .answer-btn{width:100%;padding:12px 12px;margin:4px 0;background:rgba(25,20,50,0.9);border:2px solid rgba(80,60,160,0.6);border-radius:8px;color:#e0d8ff;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;text-align:left;line-height:1.6;transition:all 0.15s;}
  .answer-btn:active{background:rgba(80,60,180,0.9);border-color:#ffd700;}
  #q-text{color:#ffd700;font-family:'Press Start 2P',monospace;font-size:8px;line-height:1.7;margin-bottom:8px;padding:8px;background:rgba(20,15,40,0.8);border-radius:6px;border-left:3px solid #ffd700;}
  #q-label{font-family:'Press Start 2P',monospace;font-size:7px;color:#888;margin-bottom:6px;}

  #battle-actions{
    position:fixed;bottom:0;left:0;width:100%;
    background:rgba(8,6,22,0.97);border-top:2px solid rgba(80,60,160,0.8);
    padding:10px;padding-bottom:max(14px,calc(10px + env(safe-area-inset-bottom)));
    z-index:200;display:none;pointer-events:all;
  }
  .battle-action-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;}
  .battle-action-btn{padding:12px 6px;border-radius:8px;border:2px solid rgba(80,60,160,0.6);background:rgba(20,15,45,0.9);color:#fff;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;text-align:center;line-height:1.5;transition:all 0.15s;}
  .battle-action-btn:active{transform:scale(0.95);}
  .ba-attack{border-color:#dd5555;}
  .ba-heavy{border-color:#ffaa00;}
  .ba-dodge{border-color:#44dd88;}
  .ba-block{border-color:#4488ff;}

  #notif{
    position:fixed;
    top:max(12px, calc(12px + env(safe-area-inset-top)));
    left:50%;transform:translateX(-50%);
    background:rgba(10,8,25,0.92);border:1px solid rgba(100,80,200,0.6);
    border-radius:8px;padding:8px 16px;font-family:'Press Start 2P',monospace;
    font-size:8px;color:#ffd700;z-index:500;display:none;pointer-events:none;
    text-align:center;max-width:90%;
  }
  #battle-result-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:300;display:none;align-items:center;justify-content:center;pointer-events:all;}
  #battle-result-box{background:rgba(12,10,30,0.98);border:3px solid #ffd700;border-radius:12px;padding:24px;text-align:center;max-width:320px;width:90%;}
  #battle-result-box h2{font-family:'Press Start 2P',monospace;font-size:14px;margin-bottom:12px;}
  #battle-result-box p{font-family:'Press Start 2P',monospace;font-size:8px;color:#aaa;line-height:1.8;margin-bottom:16px;}
  #btn-continue{padding:12px 24px;background:rgba(60,50,120,0.9);border:2px solid #ffd700;border-radius:8px;color:#ffd700;font-family:'Press Start 2P',monospace;font-size:10px;cursor:pointer;width:100%;}

  #minimap-canvas{
    position:fixed;
    top:max(8px, calc(8px + env(safe-area-inset-top)));
    right:max(8px, calc(8px + env(safe-area-inset-right)));
    border:2px solid rgba(80,60,160,0.7);border-radius:4px;image-rendering:pixelated;z-index:50;
  }
  #hud{
    position:fixed;
    top:max(8px, calc(8px + env(safe-area-inset-top)));
    left:max(8px, calc(8px + env(safe-area-inset-left)));
    pointer-events:none;z-index:50;
  }
  #hud-name{font-family:'Press Start 2P',monospace;font-size:7px;color:#ffd700;margin-bottom:4px;}
  #hud-hp-wrap,#hud-xp-wrap{display:flex;align-items:center;gap:5px;margin-bottom:3px;}
  #hud-hp-label,#hud-xp-label{font-family:'Press Start 2P',monospace;font-size:6px;color:#aaa;width:16px;}
  #hud-hp-bar,#hud-xp-bar{height:8px;border-radius:2px;border:1px solid rgba(80,60,160,0.7);}
  #hud-hp-bar{width:90px;background:linear-gradient(90deg,#dc3c3c var(--hp),#3c1010 var(--hp));}
  #hud-xp-bar{width:90px;background:linear-gradient(90deg,#4af var(--xp),#102040 var(--xp));}
  #hud-stats{font-family:'Press Start 2P',monospace;font-size:6px;color:#888;margin-top:2px;}

  #biome-label{
    position:fixed;
    /* sits above the dpad ‚Äî recalculated by JS */
    bottom:170px;
    left:max(12px, calc(12px + env(safe-area-inset-left)));
    font-family:'Press Start 2P',monospace;font-size:7px;padding:4px 8px;
    border-radius:4px;background:rgba(0,0,0,0.7);z-index:50;pointer-events:none;
  }
  canvas{touch-action:none;}
</style>
</head>
<body>
<div id="safe-probe" style="position:fixed;top:0;left:0;width:0;height:0;overflow:hidden;pointer-events:none;padding-top:env(safe-area-inset-top,0px);padding-bottom:env(safe-area-inset-bottom,0px);padding-left:env(safe-area-inset-left,0px);padding-right:env(safe-area-inset-right,0px);"></div>
<button id="fs-btn" onclick="toggleFullscreen()" style="position:fixed;top:8px;right:110px;z-index:2000;background:rgba(20,18,40,0.85);border:1px solid rgba(100,80,200,0.6);border-radius:6px;padding:6px 10px;color:rgba(180,160,255,0.9);font-family:monospace;font-size:11px;cursor:pointer;pointer-events:all;">‚õ∂FS</button>
<canvas id="gameCanvas"></canvas>
<canvas id="minimap-canvas" width="90" height="90"></canvas>
<div id="hud" style="display:none;">
  <div id="hud-name"></div>
  <div id="hud-hp-wrap"><span id="hud-hp-label">HP</span><div id="hud-hp-bar" style="--hp:100%"></div></div>
  <div id="hud-xp-wrap"><span id="hud-xp-label">XP</span><div id="hud-xp-bar" style="--xp:0%"></div></div>
  <div id="hud-stats"></div>
</div>
<div id="biome-label"></div>
<div id="dpad" style="display:none;">
  <div class="dpad-btn" id="dpad-up">‚ñ≤</div>
  <div class="dpad-btn" id="dpad-left">‚óÄ</div>
  <div id="dpad-center"></div>
  <div class="dpad-btn" id="dpad-right">‚ñ∂</div>
  <div class="dpad-btn" id="dpad-down">‚ñº</div>
</div>
<div id="action-btns" style="display:none;">
  <button class="action-btn btn-atk" id="btn-atk">‚öîÔ∏è<br>ATTACK</button>
  <button class="action-btn btn-heavy" id="btn-heavy">üí•<br>HEAVY</button>
  <button class="action-btn btn-dodge" id="btn-dodge">üí®<br>DODGE</button>
  <button class="action-btn btn-block" id="btn-block">üõ°<br>BLOCK</button>
</div>
<div id="notif"></div>
<div id="answer-panel">
  <div id="q-label"></div>
  <div id="q-text"></div>
  <div id="answer-options"></div>
</div>
<div id="battle-actions">
  <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#ffd700;margin-bottom:8px;">‚öîÔ∏è YOUR TURN</div>
  <div class="battle-action-row">
    <button class="battle-action-btn ba-attack" id="ba-attack">‚öîÔ∏è ATTACK<br><span style="color:#888;font-size:6px">Medium Q ‚Üí damage</span></button>
    <button class="battle-action-btn ba-heavy" id="ba-heavy">üí• HEAVY<br><span style="color:#888;font-size:6px">Hard Q ‚Üí 2.5x CRIT</span></button>
    <button class="battle-action-btn ba-dodge" id="ba-dodge">üí® DODGE<br><span style="color:#888;font-size:6px">Hard Q ‚Üí evade+counter</span></button>
    <button class="battle-action-btn ba-block" id="ba-block">üõ° BLOCK<br><span style="color:#888;font-size:6px">Hard Q ‚Üí -75% dmg</span></button>
  </div>
</div>
<div id="battle-result-overlay">
  <div id="battle-result-box">
    <h2 id="result-title">VICTORY!</h2>
    <p id="result-msg"></p>
    <button id="btn-continue">CONTINUE</button>
  </div>
</div>

<script>
// ============================================================
// KNOWLEDGE QUEST - Mobile HTML5
// ============================================================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;

// Responsive sizing ‚Äî use visualViewport when available (fullscreen/PWA accurate)
function resize(){
  const vv = window.visualViewport;
  const w = vv ? Math.floor(vv.width)  : window.innerWidth;
  const h = vv ? Math.floor(vv.height) : window.innerHeight;
  canvas.width  = w;
  canvas.height = h;
  canvas.style.width  = w + 'px';
  canvas.style.height = h + 'px';
  repositionUI();
}

// Dynamically reposition UI using the safe-area probe element
function repositionUI(){
  const probe = document.getElementById('safe-probe');
  const cs = getComputedStyle(probe);
  const safeB = parseInt(cs.paddingBottom) || 0;
  const safeL = parseInt(cs.paddingLeft)   || 0;
  const safeR = parseInt(cs.paddingRight)  || 0;
  const safeT = parseInt(cs.paddingTop)    || 0;

  const dpad = document.getElementById('dpad');
  dpad.style.bottom = (20 + safeB) + 'px';
  dpad.style.left   = (16 + safeL) + 'px';

  const abtns = document.getElementById('action-btns');
  abtns.style.bottom = (20 + safeB) + 'px';
  abtns.style.right  = (16 + safeR) + 'px';

  const hud = document.getElementById('hud');
  hud.style.top  = (8 + safeT) + 'px';
  hud.style.left = (8 + safeL) + 'px';

  const mm = document.getElementById('minimap-canvas');
  mm.style.top   = (8 + safeT) + 'px';
  mm.style.right = (8 + safeR) + 'px';

  const biome = document.getElementById('biome-label');
  biome.style.bottom = (20 + safeB + 152) + 'px';
  biome.style.left   = (12 + safeL) + 'px';

  const notif = document.getElementById('notif');
  notif.style.top = (12 + safeT) + 'px';
}

resize();
window.addEventListener('resize', resize);
window.addEventListener('orientationchange', ()=>setTimeout(resize, 250));
if(window.visualViewport){
  window.visualViewport.addEventListener('resize', resize);
  window.visualViewport.addEventListener('scroll', resize);
}
document.addEventListener('fullscreenchange',       ()=>setTimeout(resize,150));
document.addEventListener('webkitfullscreenchange', ()=>setTimeout(resize,150));

// ============================================================
// QUESTION BANK
// ============================================================
const QUESTIONS = {
  EASY: [
    {q:"What planet is closest to the Sun?",o:["Venus","Mercury","Mars","Earth"],a:1,cat:"Science"},
    {q:"What gas do plants absorb from air?",o:["Oxygen","Nitrogen","CO‚ÇÇ","Hydrogen"],a:2,cat:"Science"},
    {q:"How many legs does a spider have?",o:["6","8","10","12"],a:1,cat:"Science"},
    {q:"Chemical symbol for water?",o:["WA","HO","H‚ÇÇO","OX"],a:2,cat:"Science"},
    {q:"Largest planet in our solar system?",o:["Saturn","Neptune","Jupiter","Uranus"],a:2,cat:"Science"},
    {q:"Powerhouse of the cell?",o:["Nucleus","Ribosome","Mitochondria","Vacuole"],a:2,cat:"Science"},
    {q:"Who was the first US President?",o:["Jefferson","Lincoln","Washington","Adams"],a:2,cat:"History"},
    {q:"World War II ended in what year?",o:["1943","1944","1945","1946"],a:2,cat:"History"},
    {q:"Who built the pyramids of Giza?",o:["Romans","Egyptians","Greeks","Persians"],a:1,cat:"History"},
    {q:"Which country gave the USA the Statue of Liberty?",o:["England","Spain","France","Italy"],a:2,cat:"History"},
    {q:"Capital of France?",o:["Lyon","Paris","Marseille","Bordeaux"],a:1,cat:"Geography"},
    {q:"Longest river in the world?",o:["Amazon","Mississippi","Congo","Nile"],a:3,cat:"Geography"},
    {q:"Smallest country in the world?",o:["Monaco","Nauru","Vatican City","San Marino"],a:2,cat:"Geography"},
    {q:"Capital of Japan?",o:["Osaka","Kyoto","Tokyo","Hiroshima"],a:2,cat:"Geography"},
    {q:"What is 12 √ó 12?",o:["132","144","124","148"],a:1,cat:"Math"},
    {q:"Square root of 64?",o:["6","7","8","9"],a:2,cat:"Math"},
    {q:"How many sides in a hexagon?",o:["5","6","7","8"],a:1,cat:"Math"},
    {q:"Who sang 'Thriller'?",o:["Prince","Michael Jackson","Elvis","Bowie"],a:1,cat:"Culture"},
    {q:"Batman lives in which fictional city?",o:["Metropolis","Star City","Gotham","Central City"],a:2,cat:"Culture"},
    {q:"Who wrote Harry Potter?",o:["Tolkien","C.S. Lewis","J.K. Rowling","Dahl"],a:2,cat:"Culture"},
  ],
  MEDIUM: [
    {q:"Speed of light (approx)?",o:["150,000 km/s","300,000 km/s","450,000 km/s","600,000 km/s"],a:1,cat:"Science"},
    {q:"Element with atomic number 79?",o:["Silver","Platinum","Gold","Copper"],a:2,cat:"Science"},
    {q:"Process by which plants make food?",o:["Respiration","Photosynthesis","Fermentation","Digestion"],a:1,cat:"Science"},
    {q:"Hardest natural substance on Earth?",o:["Steel","Quartz","Diamond","Titanium"],a:2,cat:"Science"},
    {q:"Chemical symbol for iron?",o:["Ir","Fe","In","Io"],a:1,cat:"Science"},
    {q:"How many chromosomes do humans have?",o:["23","44","46","48"],a:2,cat:"Science"},
    {q:"Empire ruled by Genghis Khan?",o:["Ottoman","Mongol","Roman","Byzantine"],a:1,cat:"History"},
    {q:"French Revolution began in what year?",o:["1779","1783","1789","1795"],a:2,cat:"History"},
    {q:"Who wrote the Communist Manifesto?",o:["Lenin","Stalin","Marx & Engels","Trotsky"],a:2,cat:"History"},
    {q:"What year did the Berlin Wall fall?",o:["1987","1988","1989","1990"],a:2,cat:"History"},
    {q:"Largest country by area?",o:["Canada","USA","China","Russia"],a:3,cat:"Geography"},
    {q:"Deepest lake in the world?",o:["Lake Superior","Lake Baikal","Caspian Sea","Lake Tanganyika"],a:1,cat:"Geography"},
    {q:"Capital of Australia?",o:["Sydney","Melbourne","Brisbane","Canberra"],a:3,cat:"Geography"},
    {q:"Value of œÄ to 2 decimal places?",o:["3.12","3.14","3.16","3.18"],a:1,cat:"Math"},
    {q:"Sum of angles in a triangle?",o:["90¬∞","120¬∞","180¬∞","360¬∞"],a:2,cat:"Math"},
    {q:"Next prime after 23?",o:["25","27","29","31"],a:2,cat:"Math"},
    {q:"Best-selling video game of all time?",o:["Tetris","Minecraft","GTA V","Wii Sports"],a:0,cat:"Culture"},
    {q:"Which company owns Android?",o:["Apple","Microsoft","Google","Samsung"],a:2,cat:"Culture"},
    {q:"Year the World Wide Web was invented?",o:["1985","1987","1989","1991"],a:2,cat:"Culture"},
    {q:"What programming language did Guido van Rossum create?",o:["Java","Ruby","Python","Perl"],a:2,cat:"Culture"},
  ],
  HARD: [
    {q:"What is the Heisenberg Uncertainty Principle about?",o:["Speed of light","Quantum position/momentum","Atomic mass","Wave frequency"],a:1,cat:"Science"},
    {q:"Half-life of Carbon-14?",o:["1,430 years","5,730 years","14,300 years","57,300 years"],a:1,cat:"Science"},
    {q:"Particle responsible for the strong nuclear force?",o:["Photon","Graviton","Gluon","Boson"],a:2,cat:"Science"},
    {q:"Formula for kinetic energy?",o:["KE=mgh","KE=¬Ωmv¬≤","KE=mv","KE=F√ód"],a:1,cat:"Science"},
    {q:"Derivative of sin(x)?",o:["sin(x)","-cos(x)","cos(x)","-sin(x)"],a:2,cat:"Math"},
    {q:"Euler's number (e) approximately?",o:["2.718","2.518","2.918","3.018"],a:0,cat:"Math"},
    {q:"Integral of 1/x dx?",o:["x","1/x¬≤","ln(x)","-1/x¬≤"],a:2,cat:"Math"},
    {q:"Last Byzantine Emperor?",o:["Constantine XI","Justinian II","Basil II","Alexios V"],a:0,cat:"History"},
    {q:"Peace of Westphalia ended which war?",o:["Hundred Years War","Thirty Years War","Seven Years War","Napoleonic Wars"],a:1,cat:"History"},
    {q:"First female pharaoh of Egypt?",o:["Nefertiti","Cleopatra","Hatshepsut","Ankhesenamun"],a:2,cat:"History"},
    {q:"Roman Empire fell in the West in?",o:["410 AD","455 AD","476 AD","493 AD"],a:2,cat:"History"},
    {q:"Least densely populated country?",o:["Iceland","Mongolia","Greenland","Australia"],a:1,cat:"Geography"},
    {q:"Country with the most time zones?",o:["Russia","USA","China","France"],a:3,cat:"Geography"},
    {q:"Highest waterfall in the world?",o:["Niagara Falls","Angel Falls","Victoria Falls","Iguazu Falls"],a:1,cat:"Geography"},
    {q:"Chandrasekhar limit describes max mass of?",o:["Neutron star","White dwarf","Black hole","Galaxy"],a:1,cat:"Science"},
  ]
};

function getQuestion(diff){
  const pool = QUESTIONS[diff];
  return pool[Math.floor(Math.random()*pool.length)];
}

// ============================================================
// WORLD
// ============================================================
const TILE = 32, WW = 80, WH = 80;
const TILES = {
  GRASS:{c:'#228B22',solid:false}, WATER:{c:'#1E64C8',solid:true},
  TREE:{c:'#006400',solid:true}, SAND:{c:'#D2B48C',solid:false},
  ROCK:{c:'#808080',solid:true}, SNOW:{c:'#E6F0FF',solid:false},
  ICE:{c:'#B4DCF5',solid:false}, LAVA:{c:'#FF3C00',solid:true},
  VROCK:{c:'#503020',solid:true}, DFLOOR:{c:'#3C3248',solid:false},
  DWALL:{c:'#281E32',solid:true}, PATH:{c:'#B49664',solid:false},
  CACTUS:{c:'#329632',solid:true}, TGRASS:{c:'#32B432',solid:false}
};
const BIOMES = {FOREST:'#22883355',DESERT:'#D2B48C55',TUNDRA:'#B4DCF555',VOLCANO:'#FF3C0055',DUNGEON:'#A064FF55'};

let worldTiles = [], worldBiome = [];

function generateWorld(){
  worldTiles = Array.from({length:WW},()=>Array(WH).fill('GRASS'));
  worldBiome = Array.from({length:WW},()=>Array(WH).fill('FOREST'));
  const r=(seed)=>{let s=seed;return()=>{s=(s*16807+0)%2147483647;return(s-1)/2147483646;}};
  // Forest top-left
  const rf=r(42);
  for(let x=0;x<42;x++)for(let y=0;y<42;y++){
    worldBiome[x][y]='FOREST';
    const v=rf();
    worldTiles[x][y]=v<.18?'TREE':v<.22?'WATER':v<.28?'TGRASS':'GRASS';
  }
  // Desert top-right
  const rd=r(123);
  for(let x=44;x<WW;x++)for(let y=0;y<42;y++){
    worldBiome[x][y]='DESERT';
    const v=rd();
    worldTiles[x][y]=v<.08?'CACTUS':v<.14?'ROCK':'SAND';
  }
  // Tundra bottom-left
  const rt=r(77);
  for(let x=0;x<42;x++)for(let y=44;y<WH;y++){
    worldBiome[x][y]='TUNDRA';
    const v=rt();
    worldTiles[x][y]=v<.12?'ROCK':v<.22?'ICE':'SNOW';
  }
  // Volcano bottom-right
  const rv=r(99);
  for(let x=44;x<WW;x++)for(let y=44;y<WH;y++){
    worldBiome[x][y]='VOLCANO';
    const v=rv();
    worldTiles[x][y]=v<.22?'LAVA':v<.38?'VROCK':'ROCK';
  }
  // Center lava pool
  for(let x=57;x<=65;x++)for(let y=57;y<=65;y++)worldTiles[x][y]='LAVA';
  // Dungeon center
  for(let x=33;x<=47;x++)for(let y=33;y<=47;y++){
    worldBiome[x][y]='DUNGEON';
    if(x===33||x===47||y===33||y===47)worldTiles[x][y]='DWALL';
    else worldTiles[x][y]='DFLOOR';
  }
  // Paths
  for(let y=0;y<WH;y++){if(y>=0&&y<WH){worldTiles[21][y]='PATH';if(!worldBiome[21][y])worldBiome[21][y]='FOREST';}}
  for(let x=0;x<WW;x++){worldTiles[x][21]='PATH';worldTiles[x][58]='PATH';}
  for(let y=0;y<WH;y++)worldTiles[58][y]='PATH';
}

function isSolid(wx,wy){
  const tx=Math.floor(wx/TILE),ty=Math.floor(wy/TILE);
  if(tx<0||ty<0||tx>=WW||ty>=WH)return true;
  return TILES[worldTiles[tx][ty]].solid;
}
function getBiome(wx,wy){
  const tx=Math.floor(wx/TILE),ty=Math.floor(wy/TILE);
  if(tx<0||ty<0||tx>=WW||ty>=WH)return 'FOREST';
  return worldBiome[tx][ty]||'FOREST';
}

// Healing fountains
const FOUNTAINS=[[21*TILE,21*TILE],[58*TILE,21*TILE],[21*TILE,58*TILE],[58*TILE,58*TILE],[40*TILE,40*TILE]];

// ============================================================
// ENEMIES
// ============================================================
const ENEMY_TYPES={
  SLIME:{name:'Slime',hp:40,atk:8,def:4,color:'#44cc44',diff:'EASY',xp:30,biome:'FOREST',size:18},
  GOBLIN:{name:'Goblin',hp:60,atk:12,def:6,color:'#b46432',diff:'EASY',xp:50,biome:'FOREST',size:18},
  ORC:{name:'Orc',hp:100,atk:18,def:10,color:'#649650',diff:'MEDIUM',xp:80,biome:'FOREST',size:22},
  SKELETON:{name:'Skeleton',hp:70,atk:15,def:5,color:'#dcdcc8',diff:'MEDIUM',xp:70,biome:'DUNGEON',size:18},
  VAMPIRE:{name:'Vampire',hp:90,atk:20,def:8,color:'#8c0032',diff:'MEDIUM',xp:90,biome:'DUNGEON',size:20},
  GOLEM:{name:'Golem',hp:150,atk:22,def:18,color:'#968264',diff:'HARD',xp:120,biome:'DESERT',size:26},
  SAND_WITCH:{name:'Sand Witch',hp:80,atk:25,def:6,color:'#c8b464',diff:'HARD',xp:110,biome:'DESERT',size:20},
  ICE_WOLF:{name:'Ice Wolf',hp:85,atk:20,def:12,color:'#96c8ff',diff:'MEDIUM',xp:85,biome:'TUNDRA',size:20},
  FROST_GIANT:{name:'Frost Giant',hp:160,atk:25,def:14,color:'#6496dc',diff:'HARD',xp:140,biome:'TUNDRA',size:28},
  LAVA_BEAST:{name:'Lava Beast',hp:130,atk:30,def:8,color:'#dc5000',diff:'HARD',xp:130,biome:'VOLCANO',size:24},
  QUIZ_MASTER:{name:'QUIZ MASTER',hp:200,atk:35,def:15,color:'#ffd700',diff:'HARD',xp:500,biome:'DUNGEON',size:32}
};

let enemies=[];

function spawnEnemies(){
  enemies=[];
  const rng=(seed)=>{let s=seed;return(lo,hi)=>{s=(s*16807)%2147483647;return lo+Math.floor((s/2147483647)*(hi-lo));}};
  const rr=rng(55);
  const spawn=(type,x1,y1,x2,y2,n)=>{
    for(let i=0;i<n;i++){
      const tx=rr(x1,x2),ty=rr(y1,y2);
      if(tx<WW&&ty<WH&&!TILES[worldTiles[tx][ty]].solid){
        const lvl=rr(1,4);
        const et=ENEMY_TYPES[type];
        const scale=1+(lvl-1)*0.1;
        enemies.push({type,name:et.name,maxHp:Math.floor(et.hp*scale),hp:Math.floor(et.hp*scale),
          atk:Math.floor(et.atk*scale),def:Math.floor(et.def*scale),
          x:tx*TILE+8,y:ty*TILE+8,lvl,alive:true,aggro:false,color:et.color,size:et.size,
          diff:et.diff,xp:Math.floor(et.xp*(1+(lvl-1)*0.2)),animF:0});
      }
    }
  };
  spawn('SLIME',1,1,41,41,10);spawn('GOBLIN',1,1,41,41,8);spawn('ORC',1,1,41,41,5);
  spawn('GOLEM',45,1,78,41,7);spawn('SAND_WITCH',45,1,78,41,8);
  spawn('ICE_WOLF',1,45,41,78,8);spawn('FROST_GIANT',1,45,41,78,5);
  spawn('LAVA_BEAST',45,45,78,78,8);
  spawn('SKELETON',35,35,46,46,6);spawn('VAMPIRE',35,35,46,46,4);
  const qm=ENEMY_TYPES['QUIZ_MASTER'];
  enemies.push({type:'QUIZ_MASTER',name:'QUIZ MASTER',maxHp:200,hp:200,atk:35,def:15,
    x:40*TILE,y:40*TILE,lvl:5,alive:true,aggro:false,color:'#ffd700',size:32,
    diff:'HARD',xp:500,animF:0});
}

// ============================================================
// PLAYER
// ============================================================
const CLASSES={
  Scholar:{name:'Scholar',desc:'Bonus XP from correct answers',hp:100,atk:15,def:10,color:'#3c78dc'},
  Warrior:{name:'Warrior',desc:'High HP & defense',hp:140,atk:10,def:15,color:'#dc3c3c'},
  Mage:{name:'Mage',desc:'High attack, magic power',hp:80,atk:22,def:6,color:'#9632c8'}
};
let player={
  name:'Hero',cls:'Scholar',hp:100,maxHp:100,atk:15,def:10,
  x:400,y:400,lvl:1,xp:0,xpNext:100,wins:0,correct:0,facing:0,moving:false
};
function gainXp(amt){
  if(player.cls==='Scholar')amt=Math.floor(amt*1.25);
  player.xp+=amt;
  while(player.xp>=player.xpNext){player.xp-=player.xpNext;levelUp();}
  updateHUD();
}
function levelUp(){
  player.lvl++;player.xpNext=Math.floor(player.xpNext*1.4);
  player.maxHp+=10;player.hp=Math.min(player.hp+20,player.maxHp);
  player.atk+=2;player.def+=1;
  showNotif('Level Up! Now Lv.'+player.lvl,'#ffd700');
}

// ============================================================
// GAME STATE
// ============================================================
let STATE='MENU'; // MENU|CHARSELECT|OVERWORLD|BATTLE|GAMEOVER|WIN
let selectedChar=0;
let playerName='Hero';
let battleState=null;
let currentEnemy=null;
let camX=0,camY=0;
let input={up:false,down:false,left:false,right:false};
let animTimer=0;
let playerAnimF=0;
let lastTime=0;
let charNames=Object.keys(CLASSES);
let menuSel=0;
let particles=[];
let fountainHealTimer=0;

// ============================================================
// PARTICLE SYSTEM
// ============================================================
function spawnParticles(x,y,color,n=12){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=1+Math.random()*4;
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2,life:25+Math.random()*15,color});
  }
}
function updateParticles(){
  particles=particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.12;p.life--;return p.life>0;
  });
}
function drawParticles(){
  particles.forEach(p=>{
    const a=Math.min(1,p.life/15);
    ctx.globalAlpha=a;
    ctx.fillStyle=p.color;
    ctx.fillRect(Math.floor(p.x),Math.floor(p.y),4,4);
  });
  ctx.globalAlpha=1;
}

// ============================================================
// HUD
// ============================================================
function updateHUD(){
  if(STATE!=='OVERWORLD')return;
  document.getElementById('hud').style.display='block';
  document.getElementById('hud-name').textContent=player.name+' ['+player.cls+'] Lv.'+player.lvl;
  document.getElementById('hud-hp-bar').style.setProperty('--hp',Math.floor(player.hp/player.maxHp*100)+'%');
  document.getElementById('hud-xp-bar').style.setProperty('--xp',Math.floor(player.xp/player.xpNext*100)+'%');
  document.getElementById('hud-stats').textContent='ATK:'+player.atk+' DEF:'+player.def+' W:'+player.wins;
}

let notifTO=null;
function showNotif(msg,color='#ffd700'){
  const el=document.getElementById('notif');
  el.textContent=msg;el.style.color=color;el.style.display='block';
  if(notifTO)clearTimeout(notifTO);
  notifTO=setTimeout(()=>el.style.display='none',2500);
}

// ============================================================
// DRAWING HELPERS
// ============================================================
function px(font){ctx.font=`${font}px 'Press Start 2P',monospace`;}
function shadow(){ctx.shadowColor='#000';ctx.shadowBlur=4;}
function noShadow(){ctx.shadowBlur=0;}
function drawBox(x,y,w,h,fill,border,radius=0){
  ctx.fillStyle=fill;
  if(radius){
    ctx.beginPath();ctx.roundRect(x,y,w,h,radius);ctx.fill();
    ctx.strokeStyle=border;ctx.lineWidth=2;ctx.stroke();
  } else {
    ctx.fillRect(x,y,w,h);
    ctx.strokeStyle=border;ctx.lineWidth=2;ctx.strokeRect(x,y,w,h);
  }
  // Corner pixels
  ctx.fillStyle=border;
  ctx.fillRect(x,y,4,4);ctx.fillRect(x+w-4,y,4,4);
  ctx.fillRect(x,y+h-4,4,4);ctx.fillRect(x+w-4,y+h-4,4,4);
}
function drawText(text,x,y,color,font,align='left'){
  px(font);ctx.textAlign=align;
  shadow();ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillText(text,x+2,y+2);
  noShadow();ctx.fillStyle=color;ctx.fillText(text,x,y);
}
function drawHpBar(x,y,w,h,cur,max,label){
  const pct=Math.max(0,Math.min(1,cur/max));
  ctx.fillStyle='#3c1010';ctx.fillRect(x,y,w,h);
  ctx.fillStyle=pct>.5?'#dc3c3c':pct>.25?'#dc8c28':'#ff2020';
  ctx.fillRect(x,y,Math.floor(w*pct),h);
  ctx.strokeStyle='rgba(80,60,160,0.7)';ctx.lineWidth=1.5;ctx.strokeRect(x,y,w,h);
  if(label){px(8);ctx.fillStyle='#fff';ctx.textAlign='left';ctx.fillText(label+': '+cur+'/'+max,x+3,y+h-2);}
}

// ============================================================
// SPRITE DRAWING
// ============================================================
function drawPlayer(cx,cy,facing,frame,cls){
  const bob=frame%2===0?0:1;
  const color=CLASSES[cls].color;
  const skin='#dcb48c';
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(cx,cy+18+bob,10,4,0,0,Math.PI*2);ctx.fill();
  // Body
  ctx.fillStyle=color;ctx.fillRect(cx-8,cy-4+bob,16,16);
  // Head
  ctx.fillStyle=skin;ctx.fillRect(cx-7,cy-18+bob,14,14);
  // Hair
  ctx.fillStyle=cls==='Scholar'?'#283050':cls==='Warrior'?'#503218':'#641464';
  ctx.fillRect(cx-7,cy-18+bob,14,4);
  // Eyes
  if(facing!==1){ctx.fillStyle='#000';ctx.fillRect(cx-3,cy-10+bob,3,3);ctx.fillRect(cx+1,cy-10+bob,3,3);}
  // Accessory
  if(cls==='Scholar'){ctx.fillStyle='#c8a028';ctx.fillRect(cx+9,cy-2+bob,5,8);}
  else if(cls==='Warrior'){ctx.fillStyle='#c8c8dc';ctx.fillRect(cx+9,cy-14+bob,3,20);ctx.fillStyle='#a06428';ctx.fillRect(cx+6,cy-6+bob,9,3);}
  else{ctx.fillStyle='#6432b4';ctx.fillRect(cx+9,cy-18+bob,2,20);ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(cx+10,cy-20+bob,4,0,Math.PI*2);ctx.fill();}
}

function drawEnemy(e,sx,sy){
  const bob=Math.floor(animTimer/20)%2===0?0:1;
  const c=e.color;
  const s=e.size;
  ctx.fillStyle='rgba(0,0,0,0.25)';ctx.beginPath();ctx.ellipse(sx,sy+s+bob,s*0.8,4,0,0,Math.PI*2);ctx.fill();
  
  if(e.type==='SLIME'){
    ctx.fillStyle=c;ctx.beginPath();ctx.ellipse(sx,sy+bob,s,s*0.65,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=lighten(c,40);ctx.beginPath();ctx.ellipse(sx-2,sy-4+bob,s*0.5,s*0.35,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';ctx.fillRect(sx-4,sy+1+bob,3,3);ctx.fillRect(sx+2,sy+1+bob,3,3);
  } else if(e.type==='ICE_WOLF'||e.type==='LAVA_BEAST'){
    ctx.fillStyle=c;ctx.fillRect(sx-s,sy-s/2+bob,s*2,s);
    ctx.fillRect(sx-s+2,sy+s/2+bob,5,8);ctx.fillRect(sx+s-7,sy+s/2+bob,5,8);
    ctx.fillRect(sx-s/2,sy-s-4+bob,s,s/2+6);
    ctx.fillStyle='#000';ctx.fillRect(sx-5,sy-s+bob,4,4);ctx.fillRect(sx+2,sy-s+bob,4,4);
    if(e.type==='LAVA_BEAST'){ctx.fillStyle='rgba(255,200,0,0.5)';ctx.beginPath();ctx.arc(sx,sy+bob,s*0.7,0,Math.PI*2);ctx.fill();}
  } else if(e.type==='QUIZ_MASTER'){
    ctx.fillStyle='#1e1432';ctx.fillRect(sx-s,sy-s+bob,s*2,s*2);
    ctx.strokeStyle=c;ctx.lineWidth=3;ctx.strokeRect(sx-s,sy-s+bob,s*2,s*2);
    ctx.fillStyle=c;ctx.fillRect(sx-s/2,sy-s-10+bob,s,s/2+6);
    for(let i=-s;i<=s;i+=s/2)ctx.fillRect(sx+i-4,sy-s-22+bob,8,14);
    ctx.fillStyle='#ff0000';ctx.beginPath();ctx.arc(sx-8,sy-s-5+bob,5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(sx+8,sy-s-5+bob,5,0,Math.PI*2);ctx.fill();
    px(18);ctx.fillStyle=c;ctx.textAlign='center';ctx.fillText('?',sx,sy+8+bob);
    ctx.textAlign='left';
  } else if(e.type==='SKELETON'){
    ctx.fillStyle=c;ctx.fillRect(cx-s/2+2,cy-s+bob,s-4,s*2);
    ctx.fillRect(cx-s/2,cy-s-6+bob,s,s/2+4);
    ctx.fillStyle='#000';ctx.fillRect(cx-5,cy-s-2+bob,4,4);ctx.fillRect(cx+2,cy-s-2+bob,4,4);
    for(let i=0;i<3;i++){ctx.strokeStyle='#000';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(cx-s/2+4,cy+i*4+bob);ctx.lineTo(cx+s/2-4,cy+i*4+bob);ctx.stroke();}
  } else {
    // Generic humanoid
    ctx.fillStyle=c;
    ctx.fillRect(sx-s/2+2,sy-s*0.3+bob,s-4,s);
    ctx.fillStyle=lighten(c,30);
    ctx.fillRect(sx-s/2+2,sy-s-2+bob,s-4,s*0.7+4);
    ctx.fillStyle=darken(c,20);
    ctx.fillRect(sx-s/2+2,sy-s-2+bob,s-4,4);
    ctx.fillStyle='#000';ctx.fillRect(sx-4,sy-s+4+bob,3,3);ctx.fillRect(sx+2,sy-s+4+bob,3,3);
    if(e.type==='VAMPIRE'){ctx.fillStyle='rgba(180,0,0,0.7)';ctx.fillRect(sx-s/2-2,sy-s-3+bob,s+4,s*0.35);}
    if(e.type==='FROST_GIANT'||e.type==='GOLEM'){ctx.fillStyle=lighten(c,20);ctx.fillRect(sx-s,sy-s*0.5+bob,s*2,s*2);}
  }
  // HP bar
  const pw=s*2+4,pct=e.hp/e.maxHp;
  ctx.fillStyle='#3c1010';ctx.fillRect(sx-pw/2,sy-s-18+bob,pw,5);
  ctx.fillStyle=pct>.5?'#32c832':pct>.25?'#e08020':'#ff2020';
  ctx.fillRect(sx-pw/2,sy-s-18+bob,Math.floor(pw*pct),5);
  ctx.strokeStyle='rgba(80,60,160,0.6)';ctx.lineWidth=1;ctx.strokeRect(sx-pw/2,sy-s-18+bob,pw,5);
  px(7);ctx.fillStyle='rgba(255,255,255,0.8)';ctx.textAlign='center';ctx.fillText('Lv'+e.lvl,sx,sy-s-22+bob);
  ctx.textAlign='left';
}
// dummy cx/cy for skeleton‚Äîuse sx,sy properly
var cx=0,cy=0;

function lighten(hex,amt){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return '#'+[r,g,b].map(v=>Math.min(255,v+amt).toString(16).padStart(2,'0')).join('');
}
function darken(hex,amt){return lighten(hex,-amt);}

function drawFountain(x,y){
  ctx.fillStyle='#968264';ctx.fillRect(x-8,y+4,16,8);ctx.fillRect(x-3,y-6,6,10);
  ctx.fillStyle='rgba(64,160,255,0.85)';ctx.beginPath();ctx.arc(x,y,7,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(120,200,255,0.7)';ctx.beginPath();ctx.arc(x-1,y-2+Math.sin(Date.now()/300)*2,4,0,Math.PI*2);ctx.fill();
  px(7);ctx.fillStyle='#4af';ctx.textAlign='center';ctx.fillText('HP',x,y-10);ctx.textAlign='left';
}

// ============================================================
// TILE RENDERING
// ============================================================
function drawTile(type,px_,py_){
  const t=TILES[type];
  ctx.fillStyle=t.c;ctx.fillRect(px_,py_,TILE,TILE);
  const ts=TILE,t2=Date.now();
  if(type==='TREE'){
    ctx.fillStyle='#005000';ctx.fillRect(px_,py_,ts,ts);
    ctx.fillStyle='#3c7828';ctx.beginPath();ctx.arc(px_+ts/2,py_+ts*0.45,ts*0.42,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#6432140';ctx.fillRect(px_+ts/2-3,py_+ts-8,6,8);
  } else if(type==='WATER'){
    const w=Math.sin(t2/500+px_*0.1)*2;
    ctx.fillStyle='rgba(30,100,220,0.7)';ctx.fillRect(px_,py_+w,ts,4);
  } else if(type==='LAVA'){
    ctx.fillStyle='rgba(255,120,0,0.7)';
    ctx.beginPath();ctx.arc(px_+ts/2+Math.sin(t2/300+py_)*4,py_+ts/2+Math.cos(t2/300+px_)*4,7,0,Math.PI*2);ctx.fill();
  } else if(type==='TGRASS'){
    ctx.fillStyle='#32b432';
    for(let i=0;i<5;i++)ctx.fillRect(px_+i*6+2,py_+8,2,ts-10);
  } else if(type==='CACTUS'){
    ctx.fillStyle='#d2b48c';ctx.fillRect(px_,py_,ts,ts);
    ctx.fillStyle='#329632';ctx.fillRect(px_+ts/2-3,py_+4,6,ts-4);
    ctx.fillRect(px_+ts/2-8,py_+8,8,4);
  } else if(type==='ICE'){
    ctx.fillStyle='rgba(180,220,255,0.5)';ctx.fillRect(px_+4,py_+4,ts-8,ts-8);
  } else if(type==='DFLOOR'){
    ctx.strokeStyle='rgba(50,40,70,0.6)';ctx.lineWidth=1;ctx.strokeRect(px_,py_,ts/2,ts/2);
  } else if(type==='PATH'){
    ctx.fillStyle='rgba(160,130,80,0.8)';ctx.fillRect(px_+2,py_+2,ts-4,ts-4);
  }
  ctx.strokeStyle='rgba(0,0,0,0.12)';ctx.lineWidth=1;ctx.strokeRect(px_,py_,TILE,TILE);
}

// ============================================================
// MINIMAP
// ============================================================
function drawMinimap(){
  const mm=document.getElementById('minimap-canvas');
  const mc=mm.getContext('2d');
  const S=mm.width,scale=S/WW;
  mc.fillStyle='#0a0a1a';mc.fillRect(0,0,S,S);
  for(let x=0;x<WW;x++)for(let y=0;y<WH;y++){
    const t=worldTiles[x][y];
    mc.fillStyle=TILES[t].c;
    mc.fillRect(Math.floor(x*scale),Math.floor(y*scale),Math.max(1,Math.ceil(scale)),Math.max(1,Math.ceil(scale)));
  }
  // Enemies
  enemies.forEach(e=>{
    if(!e.alive)return;
    mc.fillStyle=e.aggro?'#ff2020':'rgba(200,60,60,0.8)';
    mc.fillRect(Math.floor(e.x/(WW*TILE)*S)-1,Math.floor(e.y/(WH*TILE)*S)-1,2,2);
  });
  // Player
  mc.fillStyle='#fff';
  mc.fillRect(Math.floor(player.x/(WW*TILE)*S)-2,Math.floor(player.y/(WH*TILE)*S)-2,5,5);
}

// ============================================================
// MENU SCREENS (drawn on canvas)
// ============================================================
function drawStars(){
  for(let i=0;i<60;i++){
    const sx=(i*137)%canvas.width,sy=(i*89)%canvas.height;
    const b=Math.floor((Math.sin(Date.now()*0.002+i)+1)*80+100);
    ctx.fillStyle=`rgb(${b},${b},${b})`;ctx.fillRect(sx,sy,2,2);
  }
}

function drawMainMenu(){
  const W=canvas.width,H=canvas.height;
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,W,H);
  drawStars();
  // Title
  const ts=Math.min(28,W/16);
  drawText('KNOWLEDGE',W/2,-1+ts*1.8,'#ffd700',ts,'center');
  drawText('QUEST',W/2,ts*3.0,'#ffd700',ts,'center');
  px(9);ctx.fillStyle='#4a8aff';ctx.textAlign='center';ctx.fillText('~ Educational Adventure RPG ~',W/2,ts*4.2);
  // Preview sprites
  const sp=['Scholar','Warrior','Mage'];
  sp.forEach((c,i)=>{drawPlayer(W/2-60+i*60,H*0.38,0,Math.floor(animTimer/20)%4,c);});
  // Menu
  const opts=['START GAME','HOW TO PLAY','QUIT'];
  opts.forEach((o,i)=>{
    const oy=H*0.55+i*58;
    const sel=menuSel===i;
    drawBox(W/2-130,oy-26,260,46,sel?'rgba(60,50,120,0.9)':'rgba(20,18,40,0.9)',sel?'#ffd700':'rgba(80,60,160,0.7)',6);
    const s=Math.min(13,W/40);
    drawText((sel?'> ':'')+o+(sel?' <':''),W/2,oy+4,sel?'#ffd700':'#e0d8ff',s,'center');
  });
  ctx.textAlign='left';
  px(7);ctx.fillStyle='rgba(140,130,160,0.8)';ctx.textAlign='center';
  ctx.fillText('Tap an option to select',W/2,H-14);ctx.textAlign='left';
}

function drawCharSelect(){
  const W=canvas.width,H=canvas.height;
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,W,H);
  drawStars();
  drawText('CHOOSE YOUR HERO',W/2,40,'#ffd700',Math.min(14,W/22),'center');
  // Name display
  drawBox(W/2-120,52,240,34,'rgba(20,18,40,0.9)','rgba(80,60,160,0.7)',6);
  px(9);ctx.fillStyle='#e0d8ff';ctx.textAlign='center';ctx.fillText('Name: '+playerName,W/2,74);ctx.textAlign='left';

  const cls=charNames[selectedChar];
  const info=CLASSES[cls];
  const cardW=Math.min(200,W-40),cx_=W/2;
  drawBox(cx_-cardW/2,95,cardW,H*0.45,'rgba(30,25,60,0.9)','#ffd700',8);
  drawPlayer(cx_,140,0,Math.floor(animTimer/20)%4,cls);
  drawText(info.name,cx_,195,info.color,Math.min(12,W/28),'center');
  px(8);ctx.fillStyle='#888';ctx.textAlign='center';ctx.fillText(info.desc,cx_,216);
  // Stat bars
  const bw=cardW-30,bx=cx_-bw/2;
  const stats=[['HP',info.hp,140,'#dc3c3c'],['ATK',info.atk,22,'#e0c030'],['DEF',info.def,15,'#4488ff']];
  stats.forEach(([l,v,m,c],i)=>{
    const by=230+i*24;
    ctx.fillStyle='#1e183c';ctx.fillRect(bx,by,bw,12);
    ctx.fillStyle=c;ctx.fillRect(bx,by,Math.floor(bw*v/m),12);
    ctx.strokeStyle='rgba(80,60,160,0.5)';ctx.lineWidth=1;ctx.strokeRect(bx,by,bw,12);
    px(7);ctx.fillStyle='#ccc';ctx.textAlign='left';ctx.fillText(l,bx-2,by+10);
  });
  ctx.textAlign='left';
  // Navigation buttons
  const btnY=H*0.58;
  drawBox(20,btnY,70,44,'rgba(20,18,40,0.9)','rgba(80,60,160,0.7)',6);
  drawText('‚óÄ',55,btnY+28,'#e0d8ff',18,'center');
  drawBox(W-90,btnY,70,44,'rgba(20,18,40,0.9)','rgba(80,60,160,0.7)',6);
  drawText('‚ñ∂',W-55,btnY+28,'#e0d8ff',18,'center');
  // Class pills
  charNames.forEach((n,i)=>{
    const px_=W/2-60+i*60,py_=btnY+54;
    ctx.fillStyle=i===selectedChar?'#ffd700':'rgba(80,60,160,0.5)';
    ctx.beginPath();ctx.arc(px_,py_,7,0,Math.PI*2);ctx.fill();
  });
  // Start button
  const sy=btnY+80;
  drawBox(W/2-100,sy,200,50,'rgba(60,50,120,0.9)','#ffd700',8);
  drawText('[ PLAY! ]',W/2,sy+31,'#ffd700',Math.min(13,W/26),'center');
  px(7);ctx.fillStyle='rgba(140,130,160,0.8)';ctx.textAlign='center';
  ctx.fillText('‚óÄ‚ñ∂ to change class  |  Tap PLAY to start',W/2,H-10);ctx.textAlign='left';
}

// ============================================================
// OVERWORLD RENDERING
// ============================================================
function drawOverworld(){
  const W=canvas.width,H=canvas.height;
  const VW=W,VH=H;

  // Camera
  camX=player.x-VW/2;camY=player.y-VH/2;
  camX=Math.max(0,Math.min(WW*TILE-VW,camX));
  camY=Math.max(0,Math.min(WH*TILE-VH,camY));

  // Draw tiles
  const stx=Math.floor(camX/TILE),sty=Math.floor(camY/TILE);
  const etx=Math.min(WW-1,stx+Math.ceil(VW/TILE)+1);
  const ety=Math.min(WH-1,sty+Math.ceil(VH/TILE)+1);
  for(let tx=stx;tx<=etx;tx++)for(let ty=sty;ty<=ety;ty++){
    drawTile(worldTiles[tx][ty],Math.floor(tx*TILE-camX),Math.floor(ty*TILE-camY));
  }

  // Fountains
  FOUNTAINS.forEach(([fx,fy])=>{
    const sx=Math.floor(fx-camX),sy=Math.floor(fy-camY);
    if(sx>-30&&sx<W+30&&sy>-30&&sy<H+30)drawFountain(sx,sy);
  });

  // Enemies
  enemies.forEach(e=>{
    if(!e.alive)return;
    const sx=Math.floor(e.x-camX),sy=Math.floor(e.y-camY);
    if(sx<-50||sx>W+50||sy<-50||sy>H+50)return;
    if(e.aggro){
      ctx.fillStyle='rgba(255,0,0,0.6)';ctx.beginPath();ctx.arc(sx,sy-e.size-22,6,0,Math.PI*2);ctx.fill();
      px(8);ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText('!',sx,sy-e.size-18);ctx.textAlign='left';
    }
    drawEnemy(e,sx,sy);
  });

  // Player
  drawPlayer(Math.floor(VW/2),Math.floor(VH/2),player.facing,playerAnimF,player.cls);

  // Particles
  drawParticles();

  // Biome label
  const biome=getBiome(player.x,player.y);
  const biomeEl=document.getElementById('biome-label');
  const bColors={FOREST:'#32c864',DESERT:'#c8a828',TUNDRA:'#96dcff',VOLCANO:'#ff6420',DUNGEON:'#a064ff'};
  biomeEl.textContent=biome;biomeEl.style.color=bColors[biome]||'#fff';

  // Update minimap & HUD
  drawMinimap();
  updateHUD();
}

// ============================================================
// BATTLE SCREEN
// ============================================================
function drawBattle(){
  const W=canvas.width,H=canvas.height;
  // Background by biome
  const biome=getBiome(player.x,player.y);
  const bgColors={FOREST:['#143c1e','#228B22'],DESERT:['#503c14','#a08040'],TUNDRA:['#1e283c','#b4d0e8'],VOLCANO:['#3c0a00','#50201a'],DUNGEON:['#0a0818','#281e3c']};
  const [sky,gnd]=bgColors[biome]||bgColors.FOREST;
  const grad=ctx.createLinearGradient(0,0,0,H*0.65);
  grad.addColorStop(0,sky);grad.addColorStop(1,darken(sky,10));
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);
  ctx.fillStyle=gnd;ctx.fillRect(0,H*0.65,W,H*0.35);
  ctx.strokeStyle=lighten(gnd,20);ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(0,H*0.65);ctx.lineTo(W,H*0.65);ctx.stroke();

  if(!battleState||!currentEnemy)return;
  const e=currentEnemy;

  // Enemy
  const esx=W*0.72,esy=H*0.38;
  drawEnemy(e,esx,esy);

  // Player
  drawPlayer(W*0.25,H*0.45,3,playerAnimF,player.cls);

  // Enemy info
  const eInfoH=60;
  drawBox(W*0.42,10,W*0.56-2,eInfoH,'rgba(10,8,25,0.9)',e.color,6);
  px(Math.min(9,W/55));ctx.fillStyle=e.color;ctx.textAlign='left';
  ctx.fillText(e.name+' Lv.'+e.lvl,W*0.44,30);
  drawHpBar(W*0.44,36,W*0.52-2,12,e.hp,e.maxHp,'HP');

  // Player info
  drawBox(2,10,W*0.4,eInfoH,'rgba(10,8,25,0.9)','rgba(80,60,160,0.7)',6);
  px(Math.min(9,W/55));ctx.fillStyle='#ffd700';ctx.textAlign='left';
  ctx.fillText(player.name+' Lv.'+player.lvl,10,30);
  drawHpBar(10,36,W*0.38,12,player.hp,player.maxHp,'HP');

  // Battle log
  const logY=H*0.62;
  drawBox(2,logY,W-4,H*0.08,'rgba(6,4,18,0.95)','rgba(80,60,160,0.5)',4);
  const msgs=(battleState.log||'').split('\n');
  px(Math.min(8,W/70));ctx.fillStyle='#e0d8ff';ctx.textAlign='left';
  msgs.slice(-2).forEach((m,i)=>ctx.fillText(m,10,logY+14+i*14));

  // Particles
  drawParticles();
  ctx.textAlign='left';
}

// ============================================================
// GAME OVER / WIN
// ============================================================
function drawGameOver(){
  const W=canvas.width,H=canvas.height;
  ctx.fillStyle='#1e0000';ctx.fillRect(0,0,W,H);
  drawStars();
  drawText('GAME OVER',W/2,H/2-30,'#cc1010',Math.min(22,W/15),'center');
  px(8);ctx.fillStyle='#888';ctx.textAlign='center';
  ctx.fillText('Lv.'+player.lvl+' | '+player.wins+' victories',W/2,H/2+10);
  drawBox(W/2-90,H/2+30,180,44,'rgba(40,10,10,0.9)','#cc1010',8);
  drawText('MAIN MENU',W/2,H/2+58,'#ff4444',9,'center');ctx.textAlign='left';
}
function drawWinScreen(){
  const W=canvas.width,H=canvas.height;
  ctx.fillStyle='#0a0a1e';ctx.fillRect(0,0,W,H);
  drawStars();
  spawnParticles(W/2,H/2,'#ffd700',3);
  drawText('YOU WIN!',W/2,H/2-60,'#ffd700',Math.min(24,W/14),'center');
  drawText('QUIZ MASTER DEFEATED!',W/2,H/2-20,'#fff',Math.min(10,W/30),'center');
  px(8);ctx.fillStyle='#aaa';ctx.textAlign='center';
  ctx.fillText('Lv.'+player.lvl+' | '+player.wins+' W | '+player.correct+' correct',W/2,H/2+20);
  drawBox(W/2-90,H/2+45,180,44,'rgba(20,18,40,0.9)','#ffd700',8);
  drawText('MAIN MENU',W/2,H/2+73,'#ffd700',9,'center');ctx.textAlign='left';
}

// ============================================================
// MAIN LOOP
// ============================================================
function gameLoop(ts){
  const dt=Math.min(32,ts-lastTime);lastTime=ts;
  animTimer++;
  if(animTimer%15===0)playerAnimF=(playerAnimF+1)%4;
  updateParticles();

  if(STATE==='OVERWORLD')updateOverworld(dt);

  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(STATE==='MENU')drawMainMenu();
  else if(STATE==='CHARSELECT')drawCharSelect();
  else if(STATE==='OVERWORLD')drawOverworld();
  else if(STATE==='BATTLE')drawBattle();
  else if(STATE==='GAMEOVER')drawGameOver();
  else if(STATE==='WIN')drawWinScreen();

  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(t=>{lastTime=t;requestAnimationFrame(gameLoop);});

// ============================================================
// OVERWORLD UPDATE
// ============================================================
function updateOverworld(dt){
  const speed=2.8;
  let nx=player.x,ny=player.y;
  player.moving=false;
  if(input.up){ny-=speed;player.facing=1;player.moving=true;}
  if(input.down){ny+=speed;player.facing=0;player.moving=true;}
  if(input.left){nx-=speed;player.facing=2;player.moving=true;}
  if(input.right){nx+=speed;player.facing=3;player.moving=true;}

  if(!isSolid(nx+10,player.y+16)&&!isSolid(nx-10,player.y+16))player.x=Math.max(8,Math.min(WW*TILE-8,nx));
  if(!isSolid(player.x+10,ny+16)&&!isSolid(player.x-10,ny+16))player.y=Math.max(8,Math.min(WH*TILE-8,ny));

  // Healing fountains
  fountainHealTimer++;
  if(fountainHealTimer%30===0){
    FOUNTAINS.forEach(([fx,fy])=>{
      const dx=player.x-fx,dy=player.y-fy;
      if(Math.sqrt(dx*dx+dy*dy)<35&&player.hp<player.maxHp){
        player.hp=Math.min(player.maxHp,player.hp+1);
        updateHUD();
      }
    });
  }

  // Enemy AI
  if(animTimer%25===0){
    enemies.forEach(e=>{
      if(!e.alive)return;
      const dx=player.x-e.x,dy=player.y-e.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<40&&e.alive){startBattle(e);return;}
      if(dist<220){
        e.aggro=true;
        const s=1.3;const nx=e.x+(dx/dist)*s,ny=e.y+(dy/dist)*s;
        if(!isSolid(nx,ny)){e.x=nx;e.y=ny;}
      } else {
        e.aggro=false;
        if(Math.random()<0.3){const mx=(Math.random()-.5)*18,my=(Math.random()-.5)*18;if(!isSolid(e.x+mx,e.y+my)){e.x+=mx;e.y+=my;}}
      }
    });
  }
}

// ============================================================
// BATTLE LOGIC
// ============================================================
function startBattle(enemy){
  if(STATE==='BATTLE')return;
  currentEnemy=enemy;
  battleState={log:'A wild '+enemy.name+' (Lv.'+enemy.lvl+') appeared!',phase:'PLAYER_TURN',pendingAction:null,enemySpecial:false,question:null,playerHP:player.hp};
  STATE='BATTLE';
  hideDpad();hideActionBtns();
  document.getElementById('answer-panel').style.display='none';
  document.getElementById('battle-actions').style.display='block';
  spawnParticles(canvas.width/2,canvas.height/2,'#ffd700',20);
  document.getElementById('biome-label').style.display='none';
}

function doPlayerAction(action){
  if(!battleState||battleState.phase!=='PLAYER_TURN')return;
  battleState.pendingAction=action;
  const diff=action==='ATTACK'?'MEDIUM':'HARD';
  const q=getQuestion(diff);
  battleState.question=q;
  battleState.phase='QUESTION';
  battleState.enemySpecial=false;
  document.getElementById('battle-actions').style.display='none';
  showQuestionPanel(q,getActionHint(action),false);
}

function getActionHint(a){
  if(a==='ATTACK')return'‚öîÔ∏è Answer to deal damage! Wrong = backlash!';
  if(a==='HEAVY_ATTACK')return'üí• HARD Q ‚Üí CRIT 2.5√ó damage! Wrong = big backlash!';
  if(a==='DODGE')return'üí® HARD Q ‚Üí Evade & counter! Wrong = extra damage!';
  if(a==='BLOCK')return'üõ° HARD Q ‚Üí Block 75% damage! Wrong = full hit!';
}

function showQuestionPanel(q,hint,isEnemySpecial){
  const panel=document.getElementById('answer-panel');
  const label=document.getElementById('q-label');
  const qtext=document.getElementById('q-text');
  const opts=document.getElementById('answer-options');
  label.textContent=(isEnemySpecial?'‚ö†Ô∏è ENEMY SPECIAL ‚Äî ':'')+q.cat+' | '+getDiffName(q)+(hint?' | '+hint:'');
  qtext.textContent=q.q;
  opts.innerHTML='';
  q.o.forEach((opt,i)=>{
    const btn=document.createElement('button');
    btn.className='answer-btn';
    btn.textContent=String.fromCharCode(65+i)+') '+opt;
    btn.onclick=()=>submitAnswer(i,isEnemySpecial);
    opts.appendChild(btn);
  });
  panel.style.display='block';
}
function getDiffName(q){return q?((QUESTIONS.HARD.includes(q)?'HARD':QUESTIONS.MEDIUM.includes(q)?'MEDIUM':'EASY')):'?';}

function submitAnswer(idx,isEnemySpecial){
  document.getElementById('answer-panel').style.display='none';
  const q=battleState.question;
  const correct=idx===q.a;
  if(correct)player.correct++;

  if(isEnemySpecial){resolveEnemySpecialAnswer(correct);return;}

  const a=battleState.pendingAction;
  let log='';
  if(a==='ATTACK'){
    if(correct){const d=Math.max(1,Math.floor(player.atk-currentEnemy.def/2)*randV());currentEnemy.hp-=d;log='‚úì Correct! '+d+' damage!';player.wins;gainXp(15);spawnParticles(canvas.width*0.7,canvas.height*0.4,'#ff4444');}
    else{const d=Math.max(1,Math.floor(player.atk/3));player.hp-=d;log='‚úó Wrong! Backlash: '+d+' dmg!';spawnParticles(canvas.width*0.25,canvas.height*0.45,'#4488ff');}
  } else if(a==='HEAVY_ATTACK'){
    if(correct){const d=Math.max(1,Math.floor(player.atk*2.5-currentEnemy.def/3)*randV());currentEnemy.hp-=d;log='‚òÖ CRITICAL HIT! '+d+' damage!';gainXp(25);spawnParticles(canvas.width*0.7,canvas.height*0.4,'#ffd700',20);}
    else{const d=Math.floor(player.atk/2+5);player.hp-=d;log='‚úó Heavy failed! Backlash: '+d+'!';}
  } else if(a==='DODGE'){
    if(correct){const d=Math.floor(player.atk/2);currentEnemy.hp-=d;log='‚úì Dodged & countered for '+d+'!';gainXp(20);spawnParticles(canvas.width*0.25,canvas.height*0.45,'#44ff88');proceedToPlayerTurn(log);return;}
    else{const d=enemyDmg()+5;player.hp-=d;log='‚úó Dodge failed! '+d+' dmg!';}
  } else if(a==='BLOCK'){
    if(correct){const d=Math.max(0,Math.floor(enemyDmg()/4));player.hp-=d;log='‚úì Blocked! Only '+d+' dmg!';gainXp(15);proceedToPlayerTurn(log);return;}
    else{const d=enemyDmg();player.hp-=d;log='‚úó Block broke! '+d+' dmg!';}
  }
  battleState.log=log;
  checkBattleEnd(log,()=>proceedEnemyTurn(log));
}

function enemyDmg(){return Math.max(1,Math.floor((currentEnemy.atk-player.def/2)*randV()));}
function randV(){return 0.85+Math.random()*0.3;}

function proceedEnemyTurn(prevLog){
  if(Math.random()<0.28){
    // Enemy special
    const q=getQuestion(currentEnemy.diff);
    battleState.question=q;battleState.phase='QUESTION';battleState.enemySpecial=true;
    battleState.log=prevLog;
    showQuestionPanel(q,'Resist the special attack!',true);
  } else {
    const d=enemyDmg();player.hp-=d;
    const log=(prevLog?prevLog+'\n':'')+currentEnemy.name+' attacks for '+d+'!';
    battleState.log=log;
    checkBattleEnd(log,()=>proceedToPlayerTurn(log));
  }
}

function resolveEnemySpecialAnswer(correct){
  let log=battleState.log||'';
  if(correct){const d=Math.max(0,Math.floor(enemyDmg()/2));player.hp-=d;log+='\n‚úì Resisted! '+d+' dmg!';gainXp(10);}
  else{const d=enemyDmg()*2;player.hp-=d;log+='\n‚úó SPECIAL hits for '+d+'!';}
  battleState.log=log;
  updateHUD();
  checkBattleEnd(log,()=>proceedToPlayerTurn(log));
}

function proceedToPlayerTurn(log){
  updateHUD();player.hp=Math.max(0,player.hp);currentEnemy.hp=Math.max(0,currentEnemy.hp);
  battleState.phase='PLAYER_TURN';battleState.pendingAction=null;battleState.enemySpecial=false;
  battleState.log=log||battleState.log;
  document.getElementById('battle-actions').style.display='block';
}

function checkBattleEnd(log,onContinue){
  updateHUD();player.hp=Math.max(0,player.hp);
  if(currentEnemy.hp<=0){
    currentEnemy.alive=false;player.wins++;
    const xp=currentEnemy.xp;gainXp(xp);
    showBattleResult(true,log+'\n\nVictory! +'+xp+' XP!');
  } else if(player.hp<=0){
    player.hp=0;updateHUD();
    showBattleResult(false,log+'\n\nYou were defeated...');
  } else {onContinue();}
}

function showBattleResult(won,msg){
  document.getElementById('battle-actions').style.display='none';
  document.getElementById('answer-panel').style.display='none';
  const overlay=document.getElementById('battle-result-overlay');
  const title=document.getElementById('result-title');
  const msgEl=document.getElementById('result-msg');
  const box=document.getElementById('battle-result-box');
  title.textContent=won?'‚òÖ VICTORY! ‚òÖ':'‚úó DEFEATED';
  title.style.color=won?'#ffd700':'#cc2020';
  box.style.borderColor=won?'#ffd700':'#cc2020';
  msgEl.textContent=msg.replace(/\n/g,' ‚Ä¢ ');
  overlay.style.display='flex';
  spawnParticles(canvas.width/2,canvas.height/2,won?'#ffd700':'#cc2020',won?30:10);
}

document.getElementById('btn-continue').onclick=()=>{
  document.getElementById('battle-result-overlay').style.display='none';
  const won=currentEnemy&&!currentEnemy.alive;
  if(won&&currentEnemy.type==='QUIZ_MASTER'){STATE='WIN';return;}
  if(!won){player.hp=Math.floor(player.maxHp/2);showNotif('You respawn with half HP','#ff4444');}
  player.x=Math.max(50,player.x+70);
  STATE='OVERWORLD';showDpad();
  document.getElementById('hud').style.display='block';
  document.getElementById('biome-label').style.display='block';
  updateHUD();
};

// ============================================================
// INPUT
// ============================================================
// D-Pad touch
function setupDpad(){
  const dirs={up:'up',down:'down',left:'left',right:'right'};
  Object.entries(dirs).forEach(([id,dir])=>{
    const el=document.getElementById('dpad-'+id);
    el.addEventListener('touchstart',e=>{e.preventDefault();input[dir]=true;el.classList.add('pressed');},{passive:false});
    el.addEventListener('touchend',e=>{e.preventDefault();input[dir]=false;el.classList.remove('pressed');},{passive:false});
    el.addEventListener('touchcancel',e=>{input[dir]=false;el.classList.remove('pressed');});
  });
}
setupDpad();

function showDpad(){document.getElementById('dpad').style.display='block';}
function hideDpad(){document.getElementById('dpad').style.display='none';}
function showActionBtns(){document.getElementById('action-btns').style.display='none';} // Not used in overworld
function hideActionBtns(){document.getElementById('action-btns').style.display='none';}

// Battle action buttons
document.getElementById('ba-attack').onclick=()=>doPlayerAction('ATTACK');
document.getElementById('ba-heavy').onclick=()=>doPlayerAction('HEAVY_ATTACK');
document.getElementById('ba-dodge').onclick=()=>doPlayerAction('DODGE');
document.getElementById('ba-block').onclick=()=>doPlayerAction('BLOCK');

// Keyboard support
document.addEventListener('keydown',e=>{
  if(STATE==='OVERWORLD'){
    if(e.key==='ArrowUp'||e.key==='w')input.up=true;
    if(e.key==='ArrowDown'||e.key==='s')input.down=true;
    if(e.key==='ArrowLeft'||e.key==='a')input.left=true;
    if(e.key==='ArrowRight'||e.key==='d')input.right=true;
  }
});
document.addEventListener('keyup',e=>{
  if(e.key==='ArrowUp'||e.key==='w')input.up=false;
  if(e.key==='ArrowDown'||e.key==='s')input.down=false;
  if(e.key==='ArrowLeft'||e.key==='a')input.left=false;
  if(e.key==='ArrowRight'||e.key==='d')input.right=false;
});

// Canvas tap handler for menus
canvas.addEventListener('click',e=>{handleCanvasTap(e.clientX,e.clientY);});
canvas.addEventListener('touchend',e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  handleCanvasTap(t.clientX,t.clientY);
},{passive:false});

function handleCanvasTap(tx,ty){
  const W=canvas.width,H=canvas.height;
  if(STATE==='MENU'){
    const opts=['START GAME','HOW TO PLAY','QUIT'];
    opts.forEach((_,i)=>{
      const oy=H*0.55+i*58;
      if(tx>W/2-130&&tx<W/2+130&&ty>oy-26&&ty<oy+20){
        menuSel=i;
        if(i===0){STATE='CHARSELECT';}
        else if(i===1){showHowToPlay();}
        else{/* cant quit in browser */showNotif('Close the tab to quit','#888');}
      }
    });
  } else if(STATE==='CHARSELECT'){
    const btnY=H*0.58;
    // Left arrow
    if(tx>20&&tx<90&&ty>btnY&&ty<btnY+44)selectedChar=(selectedChar-1+3)%3;
    // Right arrow
    if(tx>W-90&&tx<W-20&&ty>btnY&&ty<btnY+44)selectedChar=(selectedChar+1)%3;
    // Start button
    const sy=btnY+80;
    if(tx>W/2-100&&tx<W/2+100&&ty>sy&&ty<sy+50)beginGame();
  } else if(STATE==='GAMEOVER'){
    if(tx>canvas.width/2-90&&tx<canvas.width/2+90&&ty>canvas.height/2+30){
      resetToMenu();
    }
  } else if(STATE==='WIN'){
    if(tx>canvas.width/2-90&&tx<canvas.width/2+90&&ty>canvas.height/2+45){
      resetToMenu();
    }
  }
}

function resetToMenu(){
  STATE='MENU';menuSel=0;
  document.getElementById('hud').style.display='none';
  hideDpad();
  document.getElementById('biome-label').style.display='none';
  document.getElementById('battle-actions').style.display='none';
}

function showHowToPlay(){
  alert(
    'HOW TO PLAY\n\n'+
    'MOVE: D-Pad (mobile) or WASD (desktop)\n'+
    'BATTLE: Walk into enemies\n\n'+
    'ACTIONS:\n'+
    '‚öîÔ∏è ATTACK - Medium Q ‚Üí damage\n'+
    'üí• HEAVY - Hard Q ‚Üí CRIT 2.5x (fail=backlash)\n'+
    'üí® DODGE - Hard Q ‚Üí evade+counter (fail=extra dmg)\n'+
    'üõ° BLOCK - Hard Q ‚Üí -75% dmg (fail=full hit)\n\n'+
    'BIOMES: Forest‚ÜíDesert‚ÜíTundra‚ÜíVolcano\n'+
    'DUNGEON: Center of map (boss here!)\n'+
    'FOUNTAINS: Stand near blue HP fountains to heal\n'+
    'GOAL: Defeat the QUIZ MASTER!'
  );
}

function beginGame(){
  const cls=charNames[selectedChar];
  const info=CLASSES[cls];
  player={
    name:playerName,cls,hp:info.hp,maxHp:info.hp,atk:info.atk,def:info.def,
    x:400,y:400,lvl:1,xp:0,xpNext:100,wins:0,correct:0,facing:0,moving:false
  };
  generateWorld();
  spawnEnemies();
  STATE='OVERWORLD';
  showDpad();
  document.getElementById('hud').style.display='block';
  document.getElementById('biome-label').style.display='block';
  document.getElementById('battle-actions').style.display='none';
  updateHUD();
  showNotif('Welcome, '+player.name+'! Explore the world!','#ffd700');
}

// ============================================================
// NAME INPUT
// ============================================================
// Tap name area in charselect
canvas.addEventListener('touchstart',e=>{
  const t=e.touches[0];
  if(STATE==='CHARSELECT'){
    const W=canvas.width,H=canvas.height;
    if(t.clientX>W/2-120&&t.clientX<W/2+120&&t.clientY>52&&t.clientY<86){
      e.preventDefault();
      const n=prompt('Enter your name (max 12 chars):',playerName);
      if(n)playerName=n.slice(0,12)||'Hero';
    }
  }
},{passive:false});


// ============================================================
// FULLSCREEN HELPER
// ============================================================
function toggleFullscreen(){
  const el=document.documentElement;
  const isFs=document.fullscreenElement||document.webkitFullscreenElement;
  if(!isFs){
    const req=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen;
    if(req)req.call(el,{navigationUI:'hide'}).then(()=>setTimeout(resize,200)).catch(()=>{});
  } else {
    const ex=document.exitFullscreen||document.webkitExitFullscreen;
    if(ex)ex.call(document);
  }
}
function handleFsChange(){
  const isFs=!!(document.fullscreenElement||document.webkitFullscreenElement);
  const btn=document.getElementById('fs-btn');
  if(btn)btn.textContent=isFs?'‚úïFS':'‚õ∂FS';
  setTimeout(resize,200);
}
document.addEventListener('fullscreenchange',handleFsChange);
document.addEventListener('webkitfullscreenchange',handleFsChange);

// Init
generateWorld();
spawnEnemies();
</script>
</body>
</html>
