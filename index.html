<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>QuizMon: Legends of Knowledge</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;}
body{display:flex;align-items:center;justify-content:center;}
#game{width:100vw;height:100vh;position:relative;overflow:hidden;user-select:none;-webkit-user-select:none;font-family:monospace;}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;}
.screen.active{display:flex;flex-direction:column;align-items:center;justify-content:center;}
#charsel.active{display:block;}
#charsel-inner{display:flex;flex-direction:column;align-items:center;min-height:100%;}
.pf{font-family:'Press Start 2P',monospace;}
.pbtn{font-family:'Press Start 2P',monospace;border:3px solid;cursor:pointer;padding:12px 28px;font-size:11px;background:transparent;letter-spacing:1px;transition:transform .1s,box-shadow .1s;}
.pbtn:hover{transform:translateY(-2px);}
.pbtn-sm{font-size:8px;padding:7px 14px;border-width:2px;}
.hpwrap{width:100%;margin-bottom:4px;}
.hplabel{font-family:'Press Start 2P',monospace;font-size:8px;color:#bbb;margin-bottom:3px;}
.hpbg{background:#111;border:2px solid #444;height:13px;}
.hpfill{height:100%;transition:width .3s,background .3s;}
#menu{background:linear-gradient(180deg,#0a0a1a,#1a0a2e);}
#menu-title{font-family:'Press Start 2P',monospace;font-size:clamp(20px,4vw,36px);color:#ffd700;text-shadow:3px 3px 0 #b8860b,0 0 24px #ffd700;margin-bottom:6px;}
#menu-sub{font-family:'Press Start 2P',monospace;font-size:clamp(9px,1.5vw,13px);color:#c9a0dc;text-shadow:2px 2px 0 #6a0dad;margin-bottom:40px;}
.star{position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;pointer-events:none;}
#charsel{background:linear-gradient(180deg,#0a1628,#0d2137);gap:0;overflow-y:auto;padding:20px 12px max(24px,env(safe-area-inset-bottom,24px));}
.char-grid{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin:16px 0 20px;}
.ccard{border:3px solid #333;padding:16px 14px;cursor:pointer;text-align:center;width:190px;background:#0a0a1a;transition:all .15s;}
.ccard:hover{transform:translateY(-4px);}
.cname{font-family:'Press Start 2P',monospace;font-size:11px;margin-bottom:6px;}
.cdesc{font-size:10px;color:#999;margin-bottom:10px;line-height:1.5;}
.cstats{font-size:10px;color:#aaa;line-height:1.8;text-align:left;}
@media(max-width:500px){
  .ccard{width:calc(50% - 10px);padding:10px 8px;}
  .cname{font-size:8px;}
  .cdesc{font-size:8px;}
  .cstats{font-size:8px;line-height:1.6;}
  #btn-back{margin-bottom:8px;}
}
#explore{padding:0;position:relative;}
#world-canvas{position:absolute;top:0;left:0;display:block;image-rendering:pixelated;}
#hud{position:absolute;top:0;left:0;right:0;padding:6px 12px;background:rgba(0,0,0,.8);display:flex;align-items:center;gap:14px;z-index:10;}
#hud .hpwrap{flex:1;max-width:240px;margin:0;}
#hud-biome{font-family:'Press Start 2P',monospace;font-size:8px;white-space:nowrap;}
#hud-bosses{font-family:'Press Start 2P',monospace;font-size:8px;color:#ffd700;white-space:nowrap;}
#hud-heal{font-family:'Press Start 2P',monospace;font-size:7px;color:#90ee90;display:none;animation:blink 1s ease-in-out infinite;}
#minimap{position:absolute;right:10px;width:120px;height:70px;background:rgba(0,0,0,.8);border:2px solid #555;z-index:10;}
#mm-canvas{display:block;}
#joy{position:absolute;background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.2);border-radius:50%;z-index:20;touch-action:none;display:none;align-items:center;justify-content:center;}
#joy-knob{background:rgba(255,255,255,.3);border-radius:50%;pointer-events:none;}
#pause-explore-btn{position:absolute;z-index:20;}
#intro-overlay{position:absolute;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:50;}
#intro-box{background:#0d1117;border:3px solid #555;padding:28px 32px;text-align:center;max-width:440px;animation:fadeIn .3s ease;}
#combat{background:#0a0a0a;padding:10px;gap:8px;align-items:stretch;justify-content:flex-start;}
#c-header{display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
#c-arena{display:flex;gap:10px;flex-shrink:0;}
#c-enemy-box,#c-player-box{flex:1;background:rgba(0,0,0,.45);border:2px solid #444;padding:10px;text-align:center;}
#c-log{flex:1;background:rgba(0,0,0,.6);border:2px solid #333;padding:8px;height:120px;overflow-y:auto;display:flex;flex-direction:column;gap:3px;}
.logline{font-size:10px;line-height:1.5;animation:fadeIn .2s ease;}
#boss-tag{font-family:'Press Start 2P',monospace;font-size:7px;color:#ff4444;margin-bottom:4px;display:none;animation:pulse 1s ease-in-out infinite;}
#c-actions{display:flex;gap:6px;flex-shrink:0;}
.abtn{flex:1;background:transparent;border:2px solid;cursor:pointer;font-family:'Press Start 2P',monospace;font-size:7px;padding:9px 4px;line-height:1.9;transition:opacity .1s;}
.abtn:hover{opacity:.75;}
#flee-btn{background:rgba(40,40,40,.6);border:2px solid #555;color:#777;font-family:'Press Start 2P',monospace;font-size:7px;padding:9px 10px;cursor:pointer;}
#q-panel{background:rgba(0,0,0,.9);border:2px solid #ffd700;padding:12px;display:none;flex-shrink:0;animation:fadeIn .2s ease;}
#timer-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
#timer-bg{flex:1;background:#111;border:2px solid #333;height:12px;}
#timer-fill{height:100%;transition:width 1s linear,background .3s;background:#4caf50;width:100%;}
#timer-num{font-family:'Press Start 2P',monospace;font-size:13px;min-width:22px;text-align:right;color:#4caf50;}
#q-meta{font-family:'Press Start 2P',monospace;font-size:7px;color:#ffd700;margin-bottom:4px;}
#q-text{font-size:12px;color:#fff;margin-bottom:10px;line-height:1.5;}
#q-opts{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.qopt{background:#1a1a2e;border:2px solid #444;color:#ddd;font-family:monospace;font-size:11px;padding:8px 10px;cursor:pointer;text-align:left;line-height:1.4;transition:background .12s;}
.qopt:hover:not([disabled]){background:#2a2a4e;}
.qopt.correct{background:#1b5e20!important;border-color:#4caf50!important;color:#fff!important;}
.qopt.wrong{background:#7f0000!important;border-color:#f44336!important;color:#fff!important;}
#q-result{margin-top:8px;font-family:'Press Start 2P',monospace;font-size:10px;text-align:center;display:none;animation:fadeIn .2s ease;}
#paused{background:rgba(0,0,0,.96);}
.modal-box{background:#0d1117;border:3px solid #444;padding:28px 36px;text-align:center;max-width:380px;width:90%;}
#gameover{background:#0a0000;}
#victory{background:linear-gradient(180deg,#0a0a1a,#1a1a00);overflow:hidden;}
.vstar{position:absolute;font-size:20px;opacity:.7;animation:pulse 1s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-7px)}75%{transform:translateX(7px)}}
@keyframes popIn{0%{transform:translateX(-50%) scale(.7);opacity:0}60%{transform:translateX(-50%) scale(1.1)}100%{transform:translateX(-50%) scale(1);opacity:1}}
.lu-stat-row{display:flex;justify-content:space-between;align-items:center;background:#0d1117;border:1px solid #333;padding:8px 12px;border-radius:4px;}
.lu-label{font-family:'Press Start 2P',monospace;font-size:8px;color:#ccc;}
.lu-controls{display:flex;align-items:center;gap:10px;}
.lu-btn{font-family:'Press Start 2P',monospace;font-size:12px;background:#1a1a2e;border:2px solid #444;color:#ffd700;width:28px;height:28px;cursor:pointer;line-height:1;}
.lu-btn:hover{background:#2a2a4e;}
.lu-val{font-family:'Press Start 2P',monospace;font-size:11px;color:#ffd700;min-width:22px;text-align:center;}
.item-row{display:flex;align-items:center;gap:10px;background:#0d1117;border:1px solid #333;padding:8px 10px;}
.item-icon{font-size:22px;flex-shrink:0;}
.item-info{flex:1;}
.item-name{font-family:'Press Start 2P',monospace;font-size:8px;color:#ffd700;margin-bottom:3px;}
.item-desc{font-size:9px;color:#777;line-height:1.5;}
.item-use{font-family:'Press Start 2P',monospace;font-size:7px;background:transparent;border:1px solid #4caf50;color:#4caf50;padding:5px 8px;cursor:pointer;}
.item-use:disabled{border-color:#333;color:#333;cursor:default;}
#xpbar-wrap{position:absolute;top:36px;left:0;right:0;height:6px;background:rgba(0,0,0,.6);z-index:11;}
#xpbar{height:100%;background:linear-gradient(90deg,#4fc3f7,#9c27b0);transition:width .4s;}
#hud-level{font-family:'Press Start 2P',monospace;font-size:7px;color:#ce93d8;white-space:nowrap;}
/* Puzzle + POI styles */
#puzzle-overlay{position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:300;display:none;align-items:center;justify-content:center;}
.puz-box{background:#0d1117;border:3px solid #ffd700;padding:22px 26px;max-width:460px;width:93%;text-align:center;box-shadow:0 0 40px rgba(255,215,0,.3);animation:fadeIn .3s ease;}
.puz-title{font-family:'Press Start 2P',monospace;font-size:12px;color:#ffd700;margin-bottom:6px;text-shadow:2px 2px 0 #7a5e00;}
.puz-subtitle{font-family:'Press Start 2P',monospace;font-size:7px;color:#888;margin-bottom:16px;}
.puz-timer-bar{background:#111;border:2px solid #333;height:10px;margin-bottom:12px;}
.puz-timer-fill{height:100%;background:#4caf50;transition:width .15s linear,background .3s;}
.puz-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.puz-cell{aspect-ratio:1;border:3px solid #333;cursor:pointer;transition:all .1s;font-size:22px;display:flex;align-items:center;justify-content:center;}
.puz-cell:hover{border-color:#ffd700;transform:scale(1.05);}
.puz-cell.lit{background:#ffd700 !important;border-color:#ffd700 !important;}
.puz-cell.correct{background:#1b5e20 !important;border-color:#4caf50 !important;}
.puz-cell.wrong{background:#7f0000 !important;border-color:#f44336 !important;}
.puz-choices{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px;}
.puz-choice{background:#1a1a2e;border:2px solid #444;color:#ddd;font-family:monospace;font-size:11px;padding:9px 8px;cursor:pointer;text-align:left;line-height:1.4;transition:background .1s;}
.puz-choice:hover:not([disabled]){background:#2a2a4e;}
.puz-choice.correct{background:#1b5e20!important;border-color:#4caf50!important;color:#fff!important;}
.puz-choice.wrong{background:#7f0000!important;border-color:#f44336!important;color:#fff!important;}
.puz-mathq{font-size:26px;color:#fff;margin:10px 0 14px;font-family:'Press Start 2P',monospace;}
.puz-result{font-family:'Press Start 2P',monospace;font-size:10px;margin-top:8px;min-height:18px;}
#enter-prompt{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);border:2px solid #ffd700;padding:7px 16px;font-family:'Press Start 2P',monospace;font-size:8px;color:#ffd700;z-index:50;pointer-events:none;display:none;white-space:nowrap;animation:fadeIn .2s ease;}
#fountain-msg{position:absolute;bottom:110px;left:50%;transform:translateX(-50%);background:rgba(0,40,60,.9);border:2px solid #44eecc;padding:7px 16px;font-family:'Press Start 2P',monospace;font-size:8px;color:#44eecc;z-index:50;pointer-events:none;display:none;animation:fadeIn .2s ease;}
#sentinels-hud{font-family:'Press Start 2P',monospace;font-size:8px;color:#ff9800;white-space:nowrap;}
</style>
</head>
<body>
<div id="game">
  <div id="menu" class="screen active">
    <div id="menu-stars"></div>
    <canvas id="menu-sprite-canvas" width="200" height="80" style="image-rendering:pixelated;margin-bottom:10px;"></canvas>
    <div id="menu-title">QuizMon</div>
    <div id="menu-sub">Legends of Knowledge</div>
    <button class="pbtn" id="btn-start" style="color:#ffd700;border-color:#ffd700">‚ñ∂ START GAME</button>
    <div style="margin-top:36px;font-family:'Press Start 2P',monospace;font-size:7px;color:#333">WASD to move ‚Ä¢ Walk into enemies to battle</div>
  </div>

  <div id="charsel" class="screen">
    <div id="charsel-inner">
      <div class="pf" style="font-size:15px;color:#4fc3f7;text-shadow:2px 2px 0 #01579b;margin-top:8px;">Choose Your Hero</div>
      <div style="font-size:11px;color:#445;margin-top:6px">Select your champion wisely</div>
      <div class="char-grid" id="char-grid"></div>
      <button class="pbtn pbtn-sm" id="btn-back" style="color:#777;border-color:#555;margin-bottom:8px;">‚Üê Back</button>
    </div>
  </div>

  <div id="explore" class="screen">
    <canvas id="world-canvas"></canvas>
    <div id="hud">
      <div class="hpwrap" style="margin:0">
        <div class="hplabel" id="hud-name">Player</div>
        <div class="hpbg"><div class="hpfill" id="hud-hp" style="width:100%;background:#4caf50"></div></div>
      </div>
      <div id="hud-level">Lv.1</div>
      <div id="hud-biome">üå≤ Forest</div>
      <div id="hud-bosses">üëë 0/4</div>
      <div id="hud-sentinels">‚öîÔ∏è 0/2</div>
      <div id="hud-heal">üíö HEALING</div>
      <button class="pbtn pbtn-sm" id="hud-pause-btn" style="color:#aaa;border-color:#555">‚è∏</button>
    </div>
    <div id="xpbar-wrap"><div id="xpbar" style="width:0%"></div></div>
    <div id="minimap"><canvas id="mm-canvas" width="120" height="70"></canvas></div>
    <div id="joy"><div id="joy-knob"></div></div>
    <button class="pbtn pbtn-sm" id="pause-explore-btn" style="color:#aaa;border-color:#555">‚è∏ PAUSE</button>
    <div id="intro-overlay">
      <div id="intro-box">
        <canvas id="intro-sprite" width="96" height="96" style="image-rendering:pixelated;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto;"></canvas>
        <div id="intro-name" class="pf" style="font-size:14px;margin-bottom:8px">Forest</div>
        <div id="intro-desc" style="font-size:11px;color:#bbb;margin-bottom:14px;line-height:1.5"></div>
        <div id="intro-tip"  style="font-size:10px;color:#777;margin-bottom:20px;line-height:1.6"></div>
        <button class="pbtn pbtn-sm" id="intro-go" style="color:#4caf50;border-color:#4caf50">‚öîÔ∏è Let's Go!</button>
      </div>
    </div>
    <div id="inventory-btn" style="position:absolute;top:44px;right:6px;display:none;z-index:15;">
      <button class="pbtn pbtn-sm" onclick="showInventory()" style="color:#ffd700;border-color:#ffd700;font-size:7px;padding:5px 8px;">üéí BAG</button>
    </div>
  </div>

  <div id="combat" class="screen">
    <div id="c-header">
      <div id="c-title" class="pf" style="font-size:10px;color:#ff9800"></div>
      <div id="c-biome" class="pf" style="font-size:8px;color:#666"></div>
    </div>
    <div id="c-arena">
      <div id="c-enemy-box">
        <div id="boss-tag">‚ö†Ô∏è BOSS BATTLE</div>
        <canvas id="c-enemy-canvas" width="80" height="80" style="image-rendering:pixelated;display:block;margin:0 auto 6px;"></canvas>
        <div class="hpwrap"><div class="hplabel" id="c-enemy-name">Enemy</div><div class="hpbg"><div class="hpfill" id="c-enemy-hp" style="width:100%;background:#4caf50"></div></div></div>
        <div id="c-enemy-hptext" style="font-size:10px;color:#aaa;margin-top:2px"></div>
      </div>
      <div id="c-log"></div>
      <div id="c-player-box">
        <canvas id="c-player-canvas" width="80" height="80" style="image-rendering:pixelated;display:block;margin:0 auto 6px;"></canvas>
        <div class="hpwrap"><div class="hplabel" id="c-player-name">Player</div><div class="hpbg"><div class="hpfill" id="c-player-hp" style="width:100%;background:#4caf50"></div></div></div>
        <div id="c-player-hptext" style="font-size:10px;color:#aaa;margin-top:2px"></div>
      </div>
    </div>
    <div id="c-actions">
      <button class="abtn" id="act-attack" style="color:#ff9800;border-color:#ff9800">‚öîÔ∏è Attack<br><span style="opacity:.6;font-size:6px">Normal dmg</span></button>
      <button class="abtn" id="act-heavy"  style="color:#f44336;border-color:#f44336">üí• Heavy<br><span style="opacity:.6;font-size:6px">Crit dmg</span></button>
      <button class="abtn" id="act-block"  style="color:#4fc3f7;border-color:#4fc3f7">üõ°Ô∏è Block<br><span style="opacity:.6;font-size:6px">Reduce dmg</span></button>
      <button class="abtn" id="act-dodge"  style="color:#ce93d8;border-color:#ce93d8">üí® Dodge<br><span style="opacity:.6;font-size:6px">Avoid dmg</span></button>
      <button id="flee-btn">üèÉ Flee</button>
    </div>
    <div id="q-panel">
      <div id="timer-row">
        <div id="timer-bg"><div id="timer-fill"></div></div>
        <div id="timer-num">15</div>
        <div class="pf" style="font-size:6px;color:#555">sec</div>
      </div>
      <div id="q-meta">CAT ‚Ä¢ DIFF</div>
      <div id="q-text">Question</div>
      <div id="q-opts">
        <button class="qopt" id="qo0">A. ‚Äî</button>
        <button class="qopt" id="qo1">B. ‚Äî</button>
        <button class="qopt" id="qo2">C. ‚Äî</button>
        <button class="qopt" id="qo3">D. ‚Äî</button>
      </div>
      <div id="q-result"></div>
    </div>
  </div>

  <div id="paused" class="screen">
    <div class="modal-box">
      <div class="pf" style="font-size:18px;color:#ffd700;margin-bottom:8px;text-shadow:2px 2px 0 #b8860b">‚è∏ PAUSED</div>
      <div id="p-biome" class="pf" style="font-size:8px;color:#666;margin-bottom:24px"></div>
      <button class="pbtn" id="btn-resume" style="color:#4caf50;border-color:#4caf50;width:100%;margin-bottom:12px">‚ñ∂ Resume</button>
      <button class="pbtn" id="btn-to-menu" style="color:#f44336;border-color:#f44336;width:100%">üè† Main Menu</button>
      <div id="p-stats" class="pf" style="margin-top:18px;font-size:7px;color:#444"></div>
    </div>
  </div>

  <div id="gameover" class="screen">
    <canvas id="go-canvas" width="80" height="80" style="image-rendering:pixelated;margin-bottom:16px;filter:grayscale(1);opacity:.5;"></canvas>
    <div class="pf" style="font-size:clamp(14px,3vw,22px);color:#f44336;margin-bottom:10px;text-shadow:2px 2px 0 #7f0000">You Have Fallen</div>
    <div style="font-size:13px;color:#555;margin-bottom:40px">Your knowledge was not enough...</div>
    <button class="pbtn" id="btn-go-menu" style="color:#f44336;border-color:#f44336">üè† Main Menu</button>
  </div>

  <div id="victory" class="screen">
    <div id="v-stars"></div>
    <div style="font-size:80px;margin-bottom:14px;filter:drop-shadow(0 0 30px #ffd700);animation:pulse 1s ease-in-out infinite">üèÜ</div>
    <div class="pf" style="font-size:clamp(11px,2vw,16px);color:#ffd700;margin-bottom:6px;text-align:center;text-shadow:2px 2px 0 #b8860b,0 0 20px #ffd700">You Have Mastered</div>
    <div class="pf" style="font-size:clamp(11px,2vw,16px);color:#ffd700;margin-bottom:24px;text-shadow:2px 2px 0 #b8860b,0 0 20px #ffd700">Knowledge!</div>
    <div style="font-size:13px;color:#ccc;margin-bottom:6px">All 4 Biome Bosses Defeated</div>
    <div style="font-size:18px;color:#888;margin-bottom:36px">üå≤ üèúÔ∏è ‚ùÑÔ∏è üåã</div>
    <button class="pbtn" id="btn-v-menu" style="color:#ffd700;border-color:#ffd700">üè† Play Again</button>
  </div>
  <div id="levelup" class="screen" style="background:rgba(0,0,0,0.97);">
    <div class="modal-box" style="border-color:#ffd700;max-width:420px;">
      <div class="pf" style="font-size:16px;color:#ffd700;margin-bottom:4px;text-shadow:2px 2px 0 #b8860b">‚¨Ü LEVEL UP!</div>
      <div id="lu-level" class="pf" style="font-size:10px;color:#ccc;margin-bottom:16px"></div>
      <div id="lu-points" class="pf" style="font-size:8px;color:#ff9800;margin-bottom:14px"></div>
      <div style="display:grid;gap:10px;margin-bottom:16px;">
        <div class="lu-stat-row" id="lu-kn">
          <div class="lu-label">üìñ Knowledge <span class="lu-desc" style="color:#888;font-size:8px">+Damage</span></div>
          <div class="lu-controls"><button class="lu-btn" onclick="luAllocate('kn',-1)">‚àí</button><span id="lu-kn-val" class="lu-val">0</span><button class="lu-btn" onclick="luAllocate('kn',1)">+</button></div>
        </div>
        <div class="lu-stat-row" id="lu-ph">
          <div class="lu-label">üèõÔ∏è Philosophy <span class="lu-desc" style="color:#888;font-size:8px">+Defense</span></div>
          <div class="lu-controls"><button class="lu-btn" onclick="luAllocate('ph',-1)">‚àí</button><span id="lu-ph-val" class="lu-val">0</span><button class="lu-btn" onclick="luAllocate('ph',1)">+</button></div>
        </div>
        <div class="lu-stat-row" id="lu-qs">
          <div class="lu-label">üí¨ Quick Speak <span class="lu-desc" style="color:#888;font-size:8px">+Dodge chance</span></div>
          <div class="lu-controls"><button class="lu-btn" onclick="luAllocate('qs',-1)">‚àí</button><span id="lu-qs-val" class="lu-val">0</span><button class="lu-btn" onclick="luAllocate('qs',1)">+</button></div>
        </div>
      </div>
      <div id="lu-stat-preview" style="font-size:8px;color:#555;margin-bottom:12px;font-family:monospace;line-height:1.7;text-align:left;"></div>
      <button class="pbtn" id="lu-confirm" style="color:#ffd700;border-color:#ffd700;width:100%" onclick="luConfirm()">‚úî Confirm</button>
    </div>
  </div>

  <div id="itemdrop" style="position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);border:2px solid #ffd700;padding:10px 18px;font-family:'Press Start 2P',monospace;font-size:8px;color:#ffd700;z-index:999;display:none;text-align:center;pointer-events:none;"></div>

  <div id="inventory" class="screen" style="background:rgba(0,0,0,.97);">
    <div class="modal-box" style="border-color:#ffd700;max-width:460px;max-height:90vh;overflow-y:auto;">
      <div class="pf" style="font-size:14px;color:#ffd700;margin-bottom:4px">üéí INVENTORY</div>
      <div id="inv-stats" style="font-size:8px;color:#777;margin-bottom:12px;font-family:monospace;line-height:1.8;"></div>
      <div id="inv-items" style="display:grid;gap:8px;margin-bottom:14px;"></div>
      <button class="pbtn pbtn-sm" id="inv-close" style="color:#aaa;border-color:#555;width:100%">‚Üê Close</button>
    </div>
  </div>

    <div id="enter-prompt" onclick="if(G.nearPuzzle)openPuzzle()" style="cursor:pointer;">üîì [E] / TAP ‚Äî ENTER</div>
    <div id="fountain-msg">üíß RESTORED!</div>

  <!-- BOSS LOCKED DIALOGUE -->
  <div id="boss-locked-dialogue" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;align-items:center;justify-content:center;">
    <div style="background:#0d0d1a;border:3px solid #aa8800;padding:28px 32px;max-width:420px;width:90%;text-align:center;box-shadow:0 0 40px rgba(180,140,0,.5);animation:fadeIn .3s ease;">
      <div style="font-size:40px;margin-bottom:12px">üîí</div>
      <div id="bld-title" style="font-family:'Press Start 2P',monospace;font-size:12px;color:#ffd700;margin-bottom:10px;text-shadow:2px 2px 0 #7a5e00;line-height:1.6"></div>
      <div id="bld-body" style="font-family:'Press Start 2P',monospace;font-size:8px;color:#bbb;margin-bottom:16px;line-height:1.8"></div>
      <div id="bld-hint" style="font-family:'Press Start 2P',monospace;font-size:7px;color:#ffd700;margin-bottom:20px;line-height:1.8;border:1px solid #554400;padding:8px;background:rgba(255,215,0,.06)"></div>
      <button class="pbtn pbtn-sm" onclick="closeBossLockedDialogue()" style="color:#aa8800;border-color:#aa8800;width:100%">‚Üê Turn Back</button>
    </div>
  </div>

  <!-- GATEKEEPER DIALOGUE -->
  <div id="gatekeeper-dialogue" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;align-items:center;justify-content:center;">
    <div style="background:#0d0d1a;border:3px solid #ff9800;padding:28px 32px;max-width:420px;width:90%;text-align:center;box-shadow:0 0 40px rgba(255,152,0,.4);animation:fadeIn .3s ease;">
      <div style="font-size:40px;margin-bottom:12px">‚öîÔ∏è</div>
      <div id="gkd-title" style="font-family:'Press Start 2P',monospace;font-size:11px;color:#ff9800;margin-bottom:10px;line-height:1.6"></div>
      <div id="gkd-body" style="font-family:'Press Start 2P',monospace;font-size:8px;color:#bbb;margin-bottom:16px;line-height:1.8"></div>
      <div id="gkd-hint" style="font-family:'Press Start 2P',monospace;font-size:7px;color:#ff9800;margin-bottom:20px;line-height:1.8;border:1px solid #6a3a00;padding:8px;background:rgba(255,152,0,.06)"></div>
      <button class="pbtn pbtn-sm" onclick="closeGatekeeperDialogue()" style="color:#ff9800;border-color:#ff9800;width:100%">‚Üê Turn Back</button>
    </div>
  </div>

  <!-- PUZZLE OVERLAY -->
  <div id="puzzle-overlay">
    <div class="puz-box">
      <div id="puz-poi-icon" style="font-size:36px;margin-bottom:8px"></div>
      <div class="puz-title" id="puz-title">PUZZLE CHALLENGE</div>
      <div class="puz-subtitle" id="puz-subtitle">Solve to earn a reward</div>
      <div class="puz-timer-bar"><div class="puz-timer-fill" id="puz-timer-fill" style="width:100%"></div></div>
      <!-- Math Blitz -->
      <div id="puz-math" style="display:none">
        <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#4fc3f7;margin-bottom:6px" id="puz-math-progress">Q 1/3</div>
        <div class="puz-mathq" id="puz-math-q">12 + 7 = ?</div>
        <div id="puz-math-opts" class="puz-choices"></div>
        <div class="puz-result" id="puz-math-result"></div>
      </div>
      <!-- Memory Grid -->
      <div id="puz-memory" style="display:none">
        <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#ce93d8;margin-bottom:8px" id="puz-mem-msg">WATCH THE PATTERN</div>
        <div class="puz-grid" id="puz-mem-grid"></div>
        <div class="puz-result" id="puz-mem-result"></div>
      </div>
      <!-- Word Cipher -->
      <div id="puz-cipher" style="display:none">
        <div id="puz-cipher-q" style="font-size:12px;color:#fff;margin-bottom:12px;line-height:1.6;min-height:48px"></div>
        <div id="puz-cipher-opts" class="puz-choices"></div>
        <div class="puz-result" id="puz-cipher-result"></div>
      </div>
      <div id="puz-reward-panel" style="display:none;margin-top:12px;">
        <div id="puz-reward-text" style="font-family:'Press Start 2P',monospace;font-size:9px;color:#ffd700;margin-bottom:12px;line-height:1.7"></div>
        <button class="pbtn pbtn-sm" onclick="closePuzzle(true)" style="color:#4caf50;border-color:#4caf50;width:100%">‚úî Claim Reward</button>
      </div>
      <div id="puz-fail-panel" style="display:none;margin-top:12px;">
        <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#f44336;margin-bottom:12px">Better luck next time...</div>
        <button class="pbtn pbtn-sm" onclick="closePuzzle(false)" style="color:#777;border-color:#555;width:100%">‚Üê Leave</button>
      </div>
      <button id="puz-skip" class="pbtn pbtn-sm" onclick="closePuzzle(false)" style="color:#444;border-color:#333;width:100%;margin-top:8px">‚úï Skip</button>
    </div>
  </div>

  <!-- CHEAT PANEL -->
  <div id="cheat-panel" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:9999;align-items:center;justify-content:center;overflow-y:auto;padding:16px;">
    <div style="background:#0a0a1a;border:3px solid #ff4444;padding:24px 28px;max-width:420px;width:100%;text-align:center;box-shadow:0 0 40px rgba(255,68,68,.35);margin:auto;">
      <div style="font-family:'Press Start 2P',monospace;font-size:14px;color:#ff4444;margin-bottom:4px;text-shadow:2px 2px 0 #7f0000">‚ò† CHEAT MODE ‚ò†</div>
      <div id="cheat-hint" style="font-family:'Press Start 2P',monospace;font-size:7px;color:#555;margin-bottom:22px;">‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíB activated</div>
      <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#aaa;margin-bottom:10px;">‚ö° WARP TO BIOME</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px;">
        <button class="pbtn pbtn-sm" onclick="cheatWarp(0)" style="color:#66bb6a;border-color:#66bb6a;">üå≤ Forest</button>
        <button class="pbtn pbtn-sm" onclick="cheatWarp(1)" style="color:#ffa726;border-color:#ffa726;">üèúÔ∏è Desert</button>
        <button class="pbtn pbtn-sm" onclick="cheatWarp(2)" style="color:#80deea;border-color:#80deea;">‚ùÑÔ∏è Ice</button>
        <button class="pbtn pbtn-sm" onclick="cheatWarp(3)" style="color:#ff5722;border-color:#ff5722;">üåã Volcano</button>
      </div>
      <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#aaa;margin-bottom:10px;">üîß QUICK TOOLS</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px;">
        <button class="pbtn pbtn-sm" onclick="cheatMaxHP()"      style="color:#4caf50;border-color:#4caf50;">üíö Full HP</button>
        <button class="pbtn pbtn-sm" onclick="cheatKillAll()"    style="color:#f44336;border-color:#f44336;">üíÄ Kill All</button>
        <button class="pbtn pbtn-sm" onclick="cheatUnlockBoss()" style="color:#ffd700;border-color:#ffd700;">üîì Unlock Boss</button>
        <button class="pbtn pbtn-sm" onclick="cheatLevelUp()"    style="color:#ce93d8;border-color:#ce93d8;">‚¨Ü Level Up</button>
      </div>
      <div id="cheat-status" style="font-family:'Press Start 2P',monospace;font-size:8px;color:#ffd700;min-height:16px;margin-bottom:14px;"></div>
      <button class="pbtn pbtn-sm" onclick="closeCheat()" style="color:#777;border-color:#555;width:100%;">‚úñ Close  [Esc]</button>
    </div>
  </div>
</div>

<script>
// ================================================================
// PIXEL ART SPRITE SYSTEM
// Each sprite is a 16x16 pixel grid defined as color-indexed rows
// ================================================================
const PAL = {
  // Skin tones
  sk1:'#f4c78f', sk2:'#e8a96a', sk3:'#d4845a',
  // Hair colors
  h1:'#2a1a0a', h2:'#8B4513', h3:'#ffd700', h4:'#c0c0c0', h5:'#cc2222', h6:'#1a3a6a',
  // Clothes
  c1:'#1a3a8a', c2:'#8a1a1a', c3:'#1a6a2a', c4:'#6a1a6a', c5:'#8a6a1a', c6:'#555',
  // Armor
  a1:'#c0c0c0', a2:'#d4a017', a3:'#4fc3f7',
  // Enemies - Forest
  ef1:'#2d8b2d', ef2:'#1a5a1a', ef3:'#5aab5a', ef4:'#8B4513',
  // Enemies - Desert
  ed1:'#c8a44a', ed2:'#8b6914', ed3:'#e8d080', ed4:'#cc5500',
  // Enemies - Ice
  ei1:'#80deea', ei2:'#b0e0f0', ei3:'#4099aa', ei4:'#fff',
  // Enemies - Volcano
  ev1:'#cc2222', ev2:'#ff6600', ev3:'#880000', ev4:'#ff9900',
  // Shared
  eye:'#111', wt:'#fff', bl:'#000', rd:'#ff0000', ye:'#ffd700',
  tr:'transparent',
  // Terrain
  gr:'#3a7a2a', gd:'#4a8a3a', st:'#888', dk:'#222', gy:'#666',
  tn:'#8B7355', wt2:'#4499cc', sd:'#c8a44a', ic:'#b0d8f0', lv:'#cc3300',
  ts:'#2a5a1a', td:'#7a5a20', ti:'#6a9ab0', tv:'#5a1a00',
};

// Sprite drawing: draw a 16x16 or NxN sprite scaled to target size
// sprite = array of 16 strings, each 16 chars, each char maps to PAL key
function drawSprite(ctx, sprite, x, y, scale, flipX=false, tint=null) {
  const rows = sprite.length;
  const cols = sprite[0].length;
  ctx.save();
  if(flipX) {
    ctx.translate(x + cols*scale, y);
    ctx.scale(-1, 1);
    x = 0; y = 0;
  } else {
    ctx.translate(x, y);
    x = 0; y = 0;
  }
  for(let r=0;r<rows;r++) {
    for(let c=0;c<cols;c++) {
      const ch = sprite[r][c];
      if(ch === '.' || ch === ' ') continue;
      const color = PAL[ch] || '#ff00ff';
      ctx.fillStyle = tint || color;
      ctx.fillRect(c*scale, r*scale, scale, scale);
    }
  }
  ctx.restore();
}

// ================================================================
// SPRITE DEFINITIONS (16x16 pixel art)
// Key: each character = a palette entry key (2-char codes compressed to 1 char via lookup)
// ================================================================

// We'll use a simpler single-char lookup
const C = {
  // transparent
  '.':null,
  // skin
  'S':'#f4c78f', 's':'#d4845a', 'k':'#e8a96a',
  // hair/dark
  'H':'#2a1a0a', 'h':'#8B4513', 'B':'#1a6a2a', 'b':'#1a3a8a',
  // clothes blue
  'u':'#2244aa', 'U':'#1a3a8a',
  // clothes red
  'r':'#aa2222', 'R':'#cc0000',
  // clothes green
  'g':'#1a6a2a', 'G':'#2a8a3a',
  // clothes purple
  'p':'#6a1a8a', 'P':'#9a3aaa',
  // clothes brown/tan  
  't':'#8B6914', 'T':'#c8a44a',
  // armor silver
  'A':'#c0c0c0', 'a':'#888888',
  // gold
  'Y':'#ffd700', 'y':'#b8860b',
  // white
  'W':'#ffffff', 'w':'#dddddd',
  // black
  'X':'#111111', 'x':'#333333',
  // eye
  'E':'#111111',
  // green (nature/forest)
  'n':'#3a8a3a', 'N':'#2a6a2a', 'm':'#5aab5a', 'M':'#1a4a1a',
  // brown (earth)
  'o':'#8B4513', 'O':'#5a2a05',
  // blue (ice/water)
  'i':'#80deea', 'I':'#4099aa', 'j':'#b0e8f8', 'J':'#2288aa',
  // red/fire
  'f':'#ff6600', 'F':'#cc2200', 'q':'#ff9900', 'Q':'#880000',
  // sand/desert
  'd':'#c8a44a', 'D':'#8b6914', 'c':'#e8d080', 'C':'#cc5500',
  // Lava
  'l':'#cc3300', 'L':'#ff5500',
  // pink
  'v':'#ff8888', 'V':'#ff4466',
  // teal
  'e':'#2aaa88', 'z':'#008866',
  // Muted ice tile (low-contrast slate blue-grey)
  '1':'#1e3545', '2':'#243e50',
  // Muted lava tile (low-contrast dark charcoal-brown)
  '3':'#1c0f08', '4':'#231408',
  // Muted lava deco (dark rusty-brown glow, not neon)
  '5':'#5a2008', '6':'#3a1205',
};

function px(ctx, sprite, x, y, scale, flipX=false) {
  const rows = sprite.length;
  const cols = sprite[0].length;
  ctx.save();
  if(flipX){ctx.translate(x+cols*scale,y);ctx.scale(-1,1);x=0;y=0;}
  else{ctx.translate(x,y);x=0;y=0;}
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const ch=sprite[r][c];
      if(ch==='.'||ch===' ')continue;
      ctx.fillStyle=C[ch]||'#ff00ff';
      ctx.fillRect(c*scale,r*scale,scale,scale);
    }
  }
  ctx.restore();
}

// ================================================================
// CHARACTER SPRITES (16x16)
// ================================================================
const SPRITES = {
  // Scholar - blue robes, blonde hair
  scholar:[
    '....HHHHHH......',
    '...HHHHHHHHH....',
    '...HSHHHSSSH....',
    '...HSSSSSSSH....',
    '....SSEEESS.....',
    '....SSWWWSS.....',
    '...uuuSSSSuuu...',
    '..uuuuuuuuuuuu..',
    '..uuuuuuuuuuuu..',
    '..uuYuuuuuYuu...',
    '..uuuYuuuYuuu...',
    '...uuuuuuuuu....',
    '...uu.....uu....',
    '..uuu.....uuu...',
    '..XX.......XX...',
    '..XX.......XX...',
  ],
  // Guardian - silver armor, brown hair
  guardian:[
    '....hhhhhh......',
    '...hhhhhhhh.....',
    '...hShhSSSh.....',
    '...hSSSSSSh.....',
    '....SSEESs......',
    '....AAWWAS......',
    '...AAAAAAAAA....',
    '..AAAAAAAAAA....',
    '..AAAAAAAAAA....',
    '..AAYAAAYAAA....',
    '..AAAAAAAAA.....',
    '...AAAAAAAA.....',
    '...AA.....AA....',
    '..AAA.....AAA...',
    '..AA.......AA...',
    '..AA.......AA...',
  ],
  // Strategist - red outfit, dark hair
  strategist:[
    '....HHHHHH......',
    '...HHHHHHHHH....',
    '...HSHhHSSSH....',
    '...HSSSSSSH.....',
    '....SSEESs......',
    '....SRVVRS......',
    '...RRRRRRRR.....',
    '..RRRRRRRRRRR...',
    '..RRRRRRRRRRR...',
    '..RRYRRRRYRRr...',
    '..RRRYRRRYRRr...',
    '...RRRRRRRRR....',
    '...RR.....RR....',
    '..RRR.....RRR...',
    '..XX.......XX...',
    '..XX.......XX...',
  ],

  // ---- FOREST ENEMIES ----
  // Seedling (easy) - small green plant monster
  seedling:[
    '....NnNnNN......',
    '...NnnmmmNn.....',
    '...NmmmmmNN.....',
    '....NmEENm......',
    '....NmNNNm......',
    '.....NNNN.......',
    '....ooNooo......',
    '...ooooooo......',
    '...ooooooo......',
    '....ooooo.......',
    '....oo.oo.......',
    '...ooo.ooo......',
    '..oo.....oo.....',
    '...........  ...',
    '...........  ...',
    '...........  ...',
  ],
  // Vine Crawler (medium)
  vinecrawler:[
    '..NNNmNNNN......',
    '.NNmmmmmmNN.....',
    '.NmmmEEmmmN.....',
    '.NmmmmmmmmN.....',
    '..NNmmmNNN......',
    '...NNNNNN.......',
    '.nnnNNNNnnn.....',
    'nnnnnnnnnnnn....',
    'nNNnnnnnNNnn....',
    'nnnnnnnnnnn.....',
    '.nnn...nnn......',
    '..nn...nn.......',
    '.nnn...nnn......',
    'nn.....nn.......',
    '...........  ...',
    '...........  ...',
  ],
  // Ancient Ent (boss)
  ancientent:[
    '..NNNNNmNNNN....',
    '.NNmmmmmmmmNN...',
    'NNmmmmmmmmmmmN..',
    'NmmmEEEEEEmmmmN.',
    'NmmmmmmmmmmmmN..',
    '.NNNmmmmmmNNN...',
    '..NNNoNNNNN.....',
    '.ooooooooooo....',
    'oNooooooooNoo...',
    'ooooooooooooo...',
    'ooooooooooooo...',
    '.ooo.....ooo....',
    'Nooo.....oooN...',
    'Nooo.....oooN...',
    'ooo.......ooo...',
    'oo.........oo...',
  ],

  // ---- DESERT ENEMIES ----
  // Sand Beetle (easy)
  sandbeetle:[
    '....DDDDD.......',
    '...DdcddddD.....',
    '..DdcccccddD....',
    '..DdcEEcccD.....',
    '..DdcccccddD....',
    '...DdcddddD.....',
    '....DDDDD.......',
    '..DDDDDDDDD.....',
    '.DdddddddddD....',
    '..DDDDDDDDD.....',
    '...D.....D......',
    '..DD.....DD.....',
    '.D.........D....',
    '...........  ...',
    '...........  ...',
    '...........  ...',
  ],
  // Mummy (medium)
  mummy:[
    '....WWWWWW......',
    '...WwwWWWwW.....',
    '...WwWWWWwW.....',
    '...WwWEEWwW.....',
    '...WwWWWWwW.....',
    '....WWWWWW......',
    '...wwwwwwww.....',
    '..wwwwwwwwww....',
    '..wwwwwwwwww....',
    '...wwwwwwww.....',
    '...ww.....ww....',
    '...ww.....ww....',
    '..www.....www...',
    '..ww.......ww...',
    '..w.........w...',
    '...........  ...',
  ],
  // Sand Warlord (boss)
  sandwarlord:[
    '....TTTTTTT.....',
    '...TcTTTTTcT....',
    '..TcccTTTcccT...',
    '..TcTEETTETcT...',
    '..TcccTTTcccT...',
    '...TcTTTTTcT....',
    '....TTTTTTT.....',
    '...CTTTTTTTTC...',
    '..CTTTTYTTTTtC..',
    '..CTTTTTTTTttC..',
    '..CcTTTTTTTcC...',
    '...CcTTTTTcC....',
    '...Cc.....cC....',
    '..TCC.....CCT...',
    '..TC.......CT...',
    '..T.........T...',
  ],

  // ---- ICE ENEMIES ----
  // Snow Puff (easy)
  snowpuff:[
    '....jjjjj.......',
    '...jiiiiiij.....',
    '..jiiiIIiiij....',
    '..jiIIIIIIij....',
    '..jiIEEIIIij....',
    '..jiIIIIIIij....',
    '...jiiiIiiij....',
    '....jjjjjj......',
    '...jjIIjIIjj....',
    '...jIIIIIIIj....',
    '....jIIIIIj.....',
    '.....jIIIj......',
    '......jIj.......',
    '.....jjijj......',
    '....jj...jj.....',
    '...........  ...',
  ],
  // Frost Wraith (medium)
  frostwraith:[
    '....jIIIIIj.....',
    '...jIIIIIIIj....',
    '..jIIIEEIIIIj...',
    '..jIIIIIIIIIj...',
    '..jIIIIIIIIIj...',
    '...jIIIIIIIj....',
    '....jjIIIjj.....',
    '....jIIIIIIj....',
    '...jIIIIIIIIj...',
    '...IIIIIIIIIIj..',
    '..IIIIIIIIIIj...',
    '..IIIjjjjIIj....',
    '..Ij.......jI...',
    '..j.........j...',
    '...........  ...',
    '...........  ...',
  ],
  // Ice Titan (boss)
  icetitan:[
    '...jjIIIIIjj....',
    '..jIIIIIIIIIj...',
    '.jIIIIIIIIIIIj..',
    '.jIIIEEEEIIIIj..',
    '.jIIIIIIIIIIIj..',
    '..jIIIIIIIIIj...',
    '...jjjIIIjjj....',
    '..IIIJIIIIIII...',
    '.IIIIIIIIIIIIj..',
    '.IjIIIIIIIIjII..',
    '.IIIIIIIIIIIjI..',
    '..IIIjjjjIIII...',
    '..III.....IIII..',
    '..IjI.....IjII..',
    '..jI.......Ij...',
    '..I.........I...',
  ],

  // ---- VOLCANO ENEMIES ----
  // Ember Sprite (easy)
  embersprite:[
    '.....fFFf.......',
    '....fFFFFf......',
    '...fFFFFFFf.....',
    '...fFEEFFFf.....',
    '...fFFFFFqf.....',
    '....fFFFqff.....',
    '.....fffqf......',
    '....LLqqqLL.....',
    '...LLLqqqLLL....',
    '...LLLqqqLLL....',
    '....LLqqqLL.....',
    '....Lq...qL.....',
    '...LLq...qLL....',
    '..LL.......LL...',
    '...........  ...',
    '...........  ...',
  ],
  // Magma Golem (medium)
  magmagolem:[
    '...QQQQQQQ......',
    '..QQlllllQQ.....',
    '.QQlllllllQQ....',
    '.QQlEElllLQQ....',
    '.QQlllllllQQ....',
    '..QQlllllQQ.....',
    '...QQQQQQQ......',
    '.QQQlllllQQQ....',
    'QQQQlllllQQQQ...',
    'QQlQlllllQlQQ...',
    'QQQQlllllQQQQ...',
    '.QQQlllllQQQ....',
    '..QQ.....QQ.....',
    '.QQQ.....QQQ....',
    '..QQ.......QQ...',
    '..Q.........Q...',
  ],
  // Inferno King (boss)
  infernoking:[
    '..fFfFFFFfFf....',
    '.fFFFFFFFFFFf...',
    'fFFFFFFFFFFFFFf.',
    'fFFEEEFFFEEEFFf.',
    'fFFFFFFFFFFFFFf.',
    '.fFFFFqFFFqFFFf.',
    '..fFFFqqqqqFFf..',
    '.QLQQQQqQQQQQLQ.',
    'QLLLQQQqQQQQLLLQ',
    'QlllLQQqQQLLlllQ',
    'QQlllLQQQLlllQQ.',
    '.QQlllLLLlllQQ..',
    '..QQll...llQQ...',
    '..QLl.....lLQ...',
    '..Ql.......lQ...',
    '..Q.........Q...',
  ],

  // Terrain tiles (8x8)
  grass_tile:[
    'gGgGgGgG',
    'GgGgGgGg',
    'gGgGgGgG',
    'GgGgGgGg',
    'gGgGgGgG',
    'GgGgGgGg',
    'gGgGgGgG',
    'GgGgGgGg',
  ],
  sand_tile:[
    'TTdTTdTT',
    'dTTTdTTT',
    'TTdTTdTT',
    'TdTTTdTT',
    'TTdTTdTT',
    'dTTTdTTT',
    'TTdTTdTT',
    'TdTTTdTT',
  ],
  ice_tile:[
    '11111111',
    '11211121',
    '12111112',
    '11111211',
    '21111111',
    '11121111',
    '11111121',
    '12111111',
  ],
  lava_tile:[
    '33333333',
    '33433333',
    '34333433',
    '33333333',
    '33334333',
    '43333333',
    '33333343',
    '33343333',
  ],
  town_tile:[
    'GgGgGgGg',
    'gGgGGgGg',
    'GgGgGgGg',
    'gGGgGgGG',
    'GgGgGgGg',
    'ggGgGGgg',
    'GgGgGgGg',
    'gGgGGgGg',
  ],
  // Decorations
  tree_deco:[
    '...NNN..',
    '..NmmmN.',
    '.NmmNmmN',
    '.NmmmmmN',
    '..NmNmN.',
    '...ooo..',
    '...ooo..',
    '........',
  ],
  cactus_deco:[
    '...ddd..',
    '...ddd..',
    '.ddddddd',
    '.ddddddd',
    '...ddd..',
    '...ddd..',
    '...ddd..',
    '........',
  ],
  // ‚îÄ‚îÄ Desert terrain extras ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Sandstone pillar cluster ‚Äî solid obstacle (two boulders side by side)
  sandstone_pillar:[
    '.cDDcDd.',
    'cDddDddD',
    'DddDDddD',
    'DdCDdCdD',
    'DddDDddD',
    'DddDdddD',
    '.DDDDDD.',
    '........',
  ],
  // Sand dune ‚Äî non-solid, decorative terrain bump with shadow
  sand_dune:[
    '........',
    '......d.',
    '....dddd',
    '...dDDdd',
    '..dDDDdd',
    '.dDDDDdd',
    'ddDDDddd',
    'dddddddd',
  ],
  // Skull pile ‚Äî non-solid, macabre desert atmosphere
  skull_pile:[
    '........',
    '.wWww...',
    'wWEEWw..',
    'wWwwWw..',
    '.wwwww..',
    '..ww.w..',
    '.ww..ww.',
    '........',
  ],
  // Ancient ruins arch ‚Äî non-solid, two broken stone columns
  ruins_arch:[
    '.aa..aa.',
    'aAA..AAa',
    'aAA..AAa',
    'aAA..AAa',
    '.aa..aa.',
    '........',
    '........',
    '........',
  ],
  iceberg_deco:[
    '...222..',
    '..21112.',
    '.2111112',
    '.2111112',
    '..21112.',
    '...222..',
    '........',
    '........',
  ],
  rock_deco:[
    '..aaaa..',
    '.aAAAAa.',
    'aAAAAAaa',
    'aAAAAAaa',
    '.aAAAAa.',
    '..aaaa..',
    '........',
    '........',
  ],
  // ‚ïê‚ïê NEW TERRAIN TILES ‚ïê‚ïê
  // Forest extras
  fallen_log:[
    '........',
    '.ooooooo',
    'oOOOOOOo',
    'oOoOoOOo',
    'oOOOOOOo',
    '.ooooooo',
    '........',
    '........',
  ],
  mushroom_patch:[
    '...V.....',
    '..VVV...',
    '.VVVVV..',
    '.VwVwV..',
    '..ooo...',
    '.oo.oo..',
    '...o....',
    '........',
  ],
  forest_pond:[
    '..jjjj..',
    '.jJJJJj.',
    'jJJJJJJj',
    'jJGJJGJj',
    'jJJJJJJj',
    '.jGJJGj.',
    '..jjjj..',
    '........',
  ],
  // Ice extras
  frozen_spire:[
    '...22...',
    '..2112..',
    '..2112..',
    '.211112.',
    '.211112.',
    '21111112',
    '.222222.',
    '........',
  ],
  snowdrift:[
    '........',
    '....WW..',
    '...WWWW.',
    '..WWWWWW',
    'WWWWWWWW',
    '.wwwwwww',
    '.wWwWwWw',
    '........',
  ],
  ice_crack:[
    '2.......',
    '.1......',
    '..11....',
    '..211...',
    '....111.',
    '.....2..',
    '......11',
    '.......2',
  ],
  frozen_pond:[
    '..2222..',
    '.211112.',
    '211aa112',
    '21aaaa12',
    '211aa112',
    '.211112.',
    '..2222..',
    '........',
  ],
  // Volcano extras
  obsidian_chunk:[
    '..xxxx..',
    '.xXXXXx.',
    'xXXaaXXx',
    'xXaXXaXx',
    'xXXaaXXx',
    '.xXXXXx.',
    '..xxxx..',
    '........',
  ],
  lava_bubble:[
    '..6556..',
    '.5555556',
    '655655566',
    '5656655',
    '5555566.',
    '.55555..',
    '..6666..',
    '........',
  ],
  ash_field:[
    'axaxaxax',
    'xaxaxaxa',
    'aaxxaaxx',
    'xxaaxxaa',
    'axaxaxax',
    'xaxaxaxa',
    '........',
    '........',
  ],

  // ---- FOREST UNIQUE ----
  // Mushroom Shaman ‚Äî purple cap, staff, casts spores
  mushroomshaman:[
    '....PPPpp.......',
    '...PPpppppP.....',
    '..PPpppppppP....',
    '..PPpEEppppP....',
    '..PPpppppppP....',
    '...PPpppppP.....',
    '....SSSSSS......',
    '...pSSSSSSp.....',
    '...pSSYSSp......',
    '....pSSSSp......',
    '....pS..Sp......',
    '...ppS..Spp.....',
    '..oopS..Spoo....',
    '..oop....poo....',
    '..oo......oo....',
    '...........  ...',
  ],
  // Bark Golem ‚Äî heavy armored tree creature
  barkgolem:[
    '..oNNoNNoNN.....',
    '.oNNNNNNNNNo....',
    'oNNNNNNNNNNNo...',
    'oNNNEENNNNNNo...',
    'oNNNNNNNNNNNo...',
    '.oNNNNNNNNNo....',
    '..ooNNNNNoo.....',
    '.oooNNNNNooo....',
    'ooooNNNNNoooo...',
    'oNooNNNNNooNo...',
    'ooooNNNNNoooo...',
    '.oooNNNNNooo....',
    '..oo.....oo.....',
    '.ooo.....ooo....',
    '..o.......o.....',
    '...........  ...',
  ],
  // Shadow Wolf ‚Äî dark, sleek predator
  shadowwolf:[
    '..XXXxx.........',
    '.XXxxxxxXX......',
    'XXxxEExxxxX.....',
    'XxxxxxxxvxX.....',
    'XxxxxxxxxxxX....',
    '.XXxxxxxxxxX....',
    '...XXxxxxxXX....',
    '..xXXXxxxXX.....',
    '.xxxxxxxxxxx....',
    'xxxxxxxxxxxx....',
    'xxxxxxxxxxxx....',
    '.xxx...xxx......',
    '.xx.....xx......',
    '.x.......x......',
    '...........  ...',
    '...........  ...',
  ],

  // ---- DESERT UNIQUE ----
  // Scorpion Guard ‚Äî armored arachnid with tail
  scorpionguard:[
    '....CCCCC.......',
    '...CcdddccC.....',
    '..CcdddddccC....',
    '..CcdEEdddcC....',
    '..CcdddddccC....',
    '...CcdddccC.....',
    '....CCCCC.......',
    'CCCCCcccCCCCCC..',
    'CddddddddddddC..',
    'CCCCCcccCCCCCC..',
    '..CC.....CC.....',
    '.CCC.....CCC....',
    'CCCCCCdddCCCCC..',
    '.....CdddC......',
    '......CdC.......',
    '.......C........',
  ],
  // Dust Djinn ‚Äî swirling sand spirit
  dustdjinn:[
    '....dddTd.......',
    '...dTTTTTd......',
    '..dTTTTTTTd.....',
    '..dTTEETTTd.....',
    '..dTTTTTTTd.....',
    '...dTTTTTd......',
    '....dTTTd.......',
    '..dddTTTddd.....',
    '.ddddTTTdddd....',
    'dddddTTTddddd...',
    '.dddddTddddd....',
    '..ddddddddd.....',
    '...ddd...ddd....',
    '....d.....d.....',
    '...........  ...',
    '...........  ...',
  ],
  // Bone Archer ‚Äî skeletal desert hunter
  bonearcher:[
    '....WWWWW.......',
    '...WwwWwwW......',
    '...WwWEWwW......',
    '...WwwWwwW......',
    '....WWWWW.......',
    '.....wWwW.......',
    '....wwwwwwY.....',
    '...wwwwwwwY.....',
    '...wwwwwwwY.....',
    '....wwwwwwY.....',
    '....ww...w......',
    '...www...www....',
    '..ww.......ww...',
    '...........  ...',
    '...........  ...',
    '...........  ...',
  ],

  // ---- ICE UNIQUE ----
  // Glacier Crab ‚Äî massive armored crab
  glaciercrab:[
    'jjjjjjjjjjjjjj..',
    'jIIIIIIIIIIIIj..',
    'IIIIIIIIIIIIIIj.',
    'IIjIIEEIIIjIIIj.',
    'IIIIIIIIIIIIIIj.',
    'jIIIIIIIIIIIIj..',
    'jjjjIIIIIjjjj...',
    '...jIIIIIj......',
    '..jIjIIIjIj.....',
    '.jIIIjIjIIIj....',
    '..jIIIIIIIj.....',
    '...jjIIIjj......',
    '....jIIIj.......',
    '...jj...jj......',
    '..jj.....jj.....',
    '...........  ...',
  ],
  // Blizzard Bat ‚Äî frozen winged creature
  blizzardbat:[
    'jj.....jjj......',
    'jIj...jIIj......',
    'jIIjjjIIIj......',
    'jIIIIIIEIj......',
    'jIIIIIIIIj......',
    '.jIIIIIIj.......',
    '..jjIIjj........',
    '...jIIIj........',
    '..jjIIjj........',
    '.jj.jj.jj.......',
    'jj..jj..jj......',
    'j....j...j......',
    '...........  ...',
    '...........  ...',
    '...........  ...',
    '...........  ...',
  ],
  // Crystal Golem ‚Äî gem-studded ice giant
  crystalgolem:[
    '..jjIIIIIIjj....',
    '.jIIIIIIIIIIj...',
    'jIIYIIIIIIYIIj..',
    'jIIIYIIIIYIIIj..',
    'jIIIIEEIIIIIIj..',
    'jIIIYIIIIYIIIj..',
    '.jIIIIIIIIIIj...',
    '..jjIIIIIIjj....',
    '.jIIjIIIIjIIj...',
    'jIIIIjIIjIIIIj..',
    'jIIIIIIIIIIIIj..',
    '.jIIjIIIIjIIj...',
    '..jI.....Ij.....',
    '..jI.....Ij.....',
    '..j.......j.....',
    '...........  ...',
  ],

  // ---- VOLCANO UNIQUE ----
  // Ash Phantom ‚Äî smoky ghost-like entity
  ashphantom:[
    '....xXxxx.......',
    '...xXXXXXx......',
    '..xXXXXXXXx.....',
    '..xXXEEXXXx.....',
    '..xXXXXXXXx.....',
    '...xXXXXXx......',
    '....xXXXx.......',
    '..xxxXXXxxx.....',
    '.xxxxxXxxxxxx...',
    'xxxxxxXxxxxxxx..',
    '.xxxxxXxxxxxx...',
    '..xxxXXXxxx.....',
    '..xx.....xx.....',
    '..x.......x.....',
    '...........  ...',
    '...........  ...',
  ],
  // Lava Serpent ‚Äî long fire snake
  lavaserpent:[
    '...fFFFf........',
    '..fFLLLFf.......',
    '.fFLLELLFf......',
    '.fFLLLLLFf......',
    '..fFLLLFf.......',
    '...fFFFf........',
    '....LLLf........',
    '...LLLLfL.......',
    '..LLLLLLLf......',
    '..LLLLLLLLf.....',
    '...LLLLLLf......',
    '....LLLLf.......',
    '.....LLf........',
    '......Lf........',
    '...........  ...',
    '...........  ...',
  ],
  // Volcano Drake ‚Äî winged fire lizard
  volcanodrake:[
    '.fFFfFFFFfFFf...',
    'fFFFFFFFFFFFFf..',
    'fFFFFFFFFFFFFFf.',
    'fFFFEEFFFFEEFFf.',
    'fFFFFFFFFFFFFFf.',
    '.fFFFFLFFFLFFFf.',
    '..fFFFLLLLLFFf..',
    '.fFfFLLLLLLFfFf.',
    'fFFFLfLLLLfLFFFf',
    'fFFLFFfLLfFFLFFf',
    '.fFFFFFLLFFFFFf.',
    '..fFFF..FFFf....',
    '..fFF....FFf....',
    '..fF......Ff....',
    '..f........f....',
    '...........  ...',
  ],
};

// Tile canvas cache
const tileCache = {};
function getTileCanvas(spriteName, scale) {
  const key = spriteName+'_'+scale;
  if(tileCache[key]) return tileCache[key];
  const sp = SPRITES[spriteName];
  if(!sp) return null;
  const rows=sp.length, cols=sp[0].length;
  const c=document.createElement('canvas');
  c.width=cols*scale; c.height=rows*scale;
  const ctx=c.getContext('2d');
  px(ctx,sp,0,0,scale);
  tileCache[key]=c;
  return c;
}

// Draw sprite to a canvas element
function drawToCanvas(canvasEl, spriteName, bgColor, scale=4, flipX=false) {
  const sp = SPRITES[spriteName];
  if(!sp) return;
  const rows=sp.length, cols=sp[0].length;
  canvasEl.width = cols*scale;
  canvasEl.height = rows*scale;
  const ctx = canvasEl.getContext('2d');
  ctx.fillStyle = bgColor || 'transparent';
  ctx.fillRect(0,0,canvasEl.width,canvasEl.height);
  px(ctx, sp, 0, 0, scale, flipX);
}

// ================================================================
// QUESTIONS
// ================================================================
const Q=[
  {q:"Capital of France?",o:["Berlin","Paris","Madrid","Rome"],a:1,d:"easy",c:"Geography"},
  {q:"Which continent is Egypt in?",o:["Asia","Europe","Africa","South America"],a:2,d:"easy",c:"Geography"},
  {q:"Largest ocean?",o:["Atlantic","Indian","Arctic","Pacific"],a:3,d:"easy",c:"Geography"},
  {q:"How many continents?",o:["5","6","7","8"],a:2,d:"easy",c:"Geography"},
  {q:"Capital of Japan?",o:["Beijing","Seoul","Tokyo","Bangkok"],a:2,d:"easy",c:"Geography"},
  {q:"Most populous country?",o:["USA","India","China","Brazil"],a:2,d:"easy",c:"Geography"},
  {q:"Capital of Australia?",o:["Sydney","Melbourne","Canberra","Brisbane"],a:2,d:"easy",c:"Geography"},
  {q:"Amazon River continent?",o:["Africa","Asia","North America","South America"],a:3,d:"easy",c:"Geography"},
  {q:"Gas plants absorb?",o:["Oxygen","Nitrogen","Carbon Dioxide","Hydrogen"],a:2,d:"easy",c:"Science"},
  {q:"Bones in human body?",o:["186","206","226","246"],a:1,d:"easy",c:"Science"},
  {q:"Planet closest to Sun?",o:["Venus","Earth","Mercury","Mars"],a:2,d:"easy",c:"Science"},
  {q:"Water boils at (¬∞C)?",o:["90","95","100","105"],a:2,d:"easy",c:"Science"},
  {q:"Chemical symbol for gold?",o:["Go","Gd","Au","Ag"],a:2,d:"easy",c:"Science"},
  {q:"The Red Planet?",o:["Venus","Mars","Jupiter","Saturn"],a:1,d:"easy",c:"Science"},
  {q:"Spider legs?",o:["6","8","10","12"],a:1,d:"easy",c:"Science"},
  {q:"H2O is?",o:["Salt","Water","Hydrogen","Oxygen"],a:1,d:"easy",c:"Science"},
  {q:"First US President?",o:["Lincoln","John Adams","George Washington","Jefferson"],a:2,d:"easy",c:"History"},
  {q:"WWII ended?",o:["1943","1944","1945","1946"],a:2,d:"easy",c:"History"},
  {q:"Painted the Mona Lisa?",o:["Michelangelo","Raphael","Leonardo da Vinci","Donatello"],a:2,d:"easy",c:"History"},
  {q:"Pyramids are near?",o:["Cairo","Alexandria","Luxor","Aswan"],a:0,d:"easy",c:"History"},
  {q:"12 √ó 12?",o:["132","144","148","156"],a:1,d:"easy",c:"Math"},
  {q:"‚àö64?",o:["6","7","8","9"],a:2,d:"easy",c:"Math"},
  {q:"Hexagon sides?",o:["5","6","7","8"],a:1,d:"easy",c:"Math"},
  {q:"15% of 200?",o:["25","30","35","40"],a:1,d:"easy",c:"Math"},
  {q:"2^10?",o:["512","1024","2048","256"],a:1,d:"easy",c:"Math"},
  {q:"Colors in a rainbow?",o:["5","6","7","8"],a:2,d:"easy",c:"General"},
  {q:"Fastest land animal?",o:["Lion","Cheetah","Leopard","Gazelle"],a:1,d:"easy",c:"General"},
  {q:"Guitar strings?",o:["4","5","6","7"],a:2,d:"easy",c:"General"},
  {q:"Most of Earth's atmosphere?",o:["Oxygen","Hydrogen","CO2","Nitrogen"],a:3,d:"easy",c:"General"},
  {q:"Sport at Wimbledon?",o:["Cricket","Tennis","Golf","Rugby"],a:1,d:"easy",c:"General"},
  {q:"Soccer team size?",o:["9","10","11","12"],a:2,d:"easy",c:"General"},
  {q:"Japan's currency?",o:["Yuan","Won","Yen","Ringgit"],a:2,d:"easy",c:"General"},
  {q:"Days in a leap year?",o:["364","365","366","367"],a:2,d:"easy",c:"General"},
  {q:"Largest mammal?",o:["Elephant","Giraffe","Blue Whale","Hippo"],a:2,d:"easy",c:"General"},
  {q:"Developed relativity?",o:["Newton","Bohr","Einstein","Hawking"],a:2,d:"easy",c:"Science"},
  {q:"First Moon landing?",o:["1967","1968","1969","1970"],a:2,d:"easy",c:"History"},
  {q:"Largest planet?",o:["Saturn","Uranus","Neptune","Jupiter"],a:3,d:"easy",c:"Science"},
  {q:"Longest river?",o:["Amazon","Congo","Yangtze","Nile"],a:3,d:"medium",c:"Geography"},
  {q:"Country with most natural lakes?",o:["Russia","USA","Brazil","Canada"],a:3,d:"medium",c:"Geography"},
  {q:"Capital of Brazil?",o:["Rio de Janeiro","S√£o Paulo","Bras√≠lia","Salvador"],a:2,d:"medium",c:"Geography"},
  {q:"Mount Kilimanjaro is in?",o:["Kenya","Ethiopia","Tanzania","Uganda"],a:2,d:"medium",c:"Geography"},
  {q:"Saltiest sea?",o:["Red Sea","Dead Sea","Caspian Sea","Mediterranean"],a:1,d:"medium",c:"Geography"},
  {q:"Speed of light?",o:["200k km/s","300k km/s","400k km/s","500k km/s"],a:1,d:"medium",c:"Science"},
  {q:"Organ that makes insulin?",o:["Liver","Kidney","Pancreas","Stomach"],a:2,d:"medium",c:"Science"},
  {q:"Atomic number of carbon?",o:["4","6","8","12"],a:1,d:"medium",c:"Science"},
  {q:"Planet with most moons?",o:["Jupiter","Saturn","Uranus","Neptune"],a:1,d:"medium",c:"Science"},
  {q:"DNA stands for?",o:["Deoxyribose Nucleic Acid","Deoxyribonucleic Acid","Double Nucleic Acid","Dipeptide Nucleic Acid"],a:1,d:"medium",c:"Science"},
  {q:"Powerhouse of the cell?",o:["Nucleus","Ribosome","Mitochondria","Golgi Apparatus"],a:2,d:"medium",c:"Science"},
  {q:"Vitamin from sunlight?",o:["Vitamin A","Vitamin B","Vitamin C","Vitamin D"],a:3,d:"medium",c:"Science"},
  {q:"Berlin Wall fell?",o:["1987","1988","1989","1990"],a:2,d:"medium",c:"History"},
  {q:"First person in space?",o:["Neil Armstrong","Yuri Gagarin","Buzz Aldrin","Alan Shepard"],a:1,d:"medium",c:"History"},
  {q:"Renaissance began in?",o:["France","England","Italy","Germany"],a:2,d:"medium",c:"History"},
  {q:"Hundred Years' War length?",o:["100 years","116 years","99 years","87 years"],a:1,d:"medium",c:"History"},
  {q:"Ancient wonder in Alexandria?",o:["Colossus of Rhodes","Lighthouse","Hanging Gardens","Statue of Zeus"],a:1,d:"medium",c:"History"},
  {q:"CPU stands for?",o:["Central Process Unit","Central Processing Unit","Computer Process Unit","Core Processing Unit"],a:1,d:"medium",c:"Technology"},
  {q:"HTML stands for?",o:["HyperText Markup Language","HighText Machine Language","HyperText Machine Language","HyperTool Markup Language"],a:0,d:"medium",c:"Technology"},
  {q:"Invented the WWW?",o:["Bill Gates","Steve Jobs","Tim Berners-Lee","Linus Torvalds"],a:2,d:"medium",c:"Technology"},
  {q:"First iPhone year?",o:["2005","2006","2007","2008"],a:2,d:"medium",c:"Technology"},
  {q:"RAM stands for?",o:["Random Access Memory","Read Access Memory","Rapid Access Memory","Remote Access Memory"],a:0,d:"medium",c:"Technology"},
  {q:"Wrote '1984'?",o:["Aldous Huxley","George Orwell","Ray Bradbury","H.G. Wells"],a:1,d:"medium",c:"Literature"},
  {q:"Wrote 'Don Quixote'?",o:["Lope de Vega","Miguel de Cervantes","Garc√≠a M√°rquez","Federico Lorca"],a:1,d:"medium",c:"Literature"},
  {q:"Killed Hamlet's father?",o:["Laertes","Polonius","Claudius","Horatio"],a:2,d:"medium",c:"Literature"},
  {q:"'To Kill a Mockingbird' author?",o:["Truman Capote","Tennessee Williams","Harper Lee","John Steinbeck"],a:2,d:"medium",c:"Literature"},
  {q:"Most spoken language?",o:["English","Spanish","Mandarin Chinese","Hindi"],a:2,d:"medium",c:"General"},
  {q:"Olympics originated in?",o:["Italy","Greece","Egypt","Persia"],a:1,d:"medium",c:"General"},
  {q:"Chemical symbol for iron?",o:["Ir","In","Fe","Fo"],a:2,d:"medium",c:"Science"},
  {q:"Country that invented paper?",o:["Egypt","India","China","Japan"],a:2,d:"medium",c:"History"},
  {q:"Bytes in a kilobyte?",o:["100","512","1024","2048"],a:2,d:"medium",c:"Technology"},
  {q:"Element symbol 'K'?",o:["Krypton","Potassium","Calcium","Chromium"],a:1,d:"medium",c:"Science"},
  {q:"Capital of Kazakhstan?",o:["Almaty","Astana","Shymkent","Karaganda"],a:1,d:"hard",c:"Geography"},
  {q:"Most official languages?",o:["India","Switzerland","South Africa","Belgium"],a:2,d:"hard",c:"Geography"},
  {q:"Mariana Trench ocean?",o:["Atlantic","Indian","Arctic","Pacific"],a:3,d:"hard",c:"Geography"},
  {q:"Smallest country by area?",o:["Monaco","San Marino","Liechtenstein","Vatican City"],a:3,d:"hard",c:"Geography"},
  {q:"River through Baghdad?",o:["Euphrates","Tigris","Nile","Indus"],a:1,d:"hard",c:"Geography"},
  {q:"Half-life of Carbon-14?",o:["2,730 years","5,730 years","11,460 years","1,365 years"],a:1,d:"hard",c:"Science"},
  {q:"Chandrasekhar limit?",o:["0.8 solar masses","1.4 solar masses","2.0 solar masses","3.0 solar masses"],a:1,d:"hard",c:"Science"},
  {q:"Highest melting point element?",o:["Iron","Platinum","Tungsten","Osmium"],a:2,d:"hard",c:"Science"},
  {q:"Human chromosomes?",o:["44","46","48","50"],a:1,d:"hard",c:"Science"},
  {q:"Force binding quarks?",o:["Electromagnetic","Weak nuclear","Strong nuclear","Gravitational"],a:2,d:"hard",c:"Science"},
  {q:"Higgs boson confirmed?",o:["2010","2012","2014","2016"],a:1,d:"hard",c:"Science"},
  {q:"Western Rome fell in?",o:["410 AD","455 AD","476 AD","500 AD"],a:2,d:"hard",c:"History"},
  {q:"Last Tsar of Russia?",o:["Alexander III","Nicholas I","Nicholas II","Alexander II"],a:2,d:"hard",c:"History"},
  {q:"Treaty of Westphalia ended?",o:["Thirty Years War","Hundred Years War","Seven Years War","Napoleonic Wars"],a:0,d:"hard",c:"History"},
  {q:"Builder of the Great Pyramid?",o:["Ramesses II","Tutankhamun","Khufu","Cleopatra"],a:2,d:"hard",c:"History"},
  {q:"Byzantine Emperor at fall of Constantinople?",o:["Constantine XI","John VIII","Manuel II","Alexios IV"],a:0,d:"hard",c:"History"},
  {q:"Euler's number to 2 d.p.?",o:["2.71","2.72","2.73","2.74"],a:0,d:"hard",c:"Math"},
  {q:"10th prime number?",o:["23","27","29","31"],a:2,d:"hard",c:"Math"},
  {q:"17 √ó 23?",o:["381","391","401","411"],a:1,d:"hard",c:"Math"},
  {q:"Interior angles of pentagon?",o:["360¬∞","540¬∞","720¬∞","900¬∞"],a:1,d:"hard",c:"Math"},
  {q:"log‚ÇÇ(1024)?",o:["8","9","10","11"],a:2,d:"hard",c:"Math"},
  {q:"SQL stands for?",o:["Structured Query Language","Simple Query Language","Sequential Query Language","Standard Query Language"],a:0,d:"hard",c:"Technology"},
  {q:"O(n log n) is?",o:["Bubble sort","Merge sort","Linear search","Binary search"],a:1,d:"hard",c:"Technology"},
  {q:"Email send protocol?",o:["HTTP","FTP","SMTP","POP3"],a:2,d:"hard",c:"Technology"},
  {q:"Smallest unit of data?",o:["Byte","Nibble","Bit","Word"],a:2,d:"hard",c:"Technology"},
  {q:"Wrote 'The Divine Comedy'?",o:["Petrarch","Dante Alighieri","Boccaccio","Virgil"],a:1,d:"hard",c:"Literature"},
  {q:"'Ulysses' published in?",o:["1918","1920","1922","1924"],a:2,d:"hard",c:"Literature"},
  {q:"Wrote 'Crime and Punishment'?",o:["Tolstoy","Turgenev","Chekhov","Dostoevsky"],a:3,d:"hard",c:"Literature"},
  {q:"Estate in 'Pride and Prejudice'?",o:["Pemberley","Thornfield","Wuthering Heights","Netherfield"],a:0,d:"hard",c:"Literature"},
  {q:"Study of fungi?",o:["Botany","Mycology","Zoology","Ecology"],a:1,d:"hard",c:"Science"},
  {q:"Most abundant atmospheric gas?",o:["Oxygen","Argon","CO2","Nitrogen"],a:3,d:"hard",c:"Science"},
];

// ================================================================
// GAME DATA
// ================================================================
const CHARS=[
  {id:0,name:"Scholar",  sprite:"scholar",   hp:100,atk:20,def:15,crit:.20,dodge:.15,color:"#4fc3f7",desc:"Balanced. Knows a little of everything."},
  {id:1,name:"Guardian", sprite:"guardian",  hp:140,atk:15,def:30,crit:.10,dodge:.10,color:"#81c784",desc:"High defense. Hard to kill, slow to strike."},
  {id:2,name:"Strategist",sprite:"strategist",hp:80,atk:25,def:10,crit:.45,dodge:.30,color:"#f06292",desc:"High crit & dodge. Risky but rewarding."},
];

const BIOMES=[
  {
    id:0,name:"Forest",emoji:"üå≤",
    bg:"#0d2e0d",tile:"grass_tile",townTile:"town_tile",
    deco:"tree_deco",   decoFreq:0.05,   // solid trees
    deco2:"fallen_log", deco2Freq:0.018, // solid fallen logs
    deco3:"mushroom_patch",deco3Freq:0.04, // non-solid mushrooms
    deco4:"forest_pond",   deco4Freq:0.012, // non-solid ponds
    wallColor:"#1a5a1a",wallAccent:"#2a7a2a",
    eColor:"#66bb6a",
    enemies:[
      {name:"Seedling",      sprite:"seedling",      baseHp:35, baseAtk:8,  sc:0.35,type:"easy"},
      {name:"Vine Crawler",  sprite:"vinecrawler",   baseHp:55, baseAtk:14, sc:0.45,type:"medium"},
      {name:"Shadow Wolf",   sprite:"shadowwolf",    baseHp:65, baseAtk:18, sc:0.50,type:"medium"},
      {name:"Mushroom Shaman",sprite:"mushroomshaman",baseHp:80,baseAtk:22, sc:0.55,type:"hard"},
      {name:"Bark Golem",    sprite:"barkgolem",     baseHp:95, baseAtk:16, sc:0.45,type:"hard",unique:true,count:1},
    ],
    boss:{name:"Ancient Ent",sprite:"ancientent",bossHpMult:3,bossAtkMult:1.6,sc:0.55},
    dw:{easy:.70,medium:.25,hard:.05},
    desc:"A mystical forest teeming with ancient spirits.",
    unlockHint:"Defeat the Bark Golem guardian to unlock the boss.",
  },
  {
    id:1,name:"Desert",emoji:"üèúÔ∏è",
    bg:"#3a1800",tile:"sand_tile",townTile:"town_tile",
    deco:"sandstone_pillar",decoFreq:0.028,   // solid ‚Äì rock pillars
    deco2:"cactus_deco",    deco2Freq:0.018,   // solid ‚Äì cacti
    deco3:"sand_dune",      deco3Freq:0.045,   // non-solid ‚Äì dune bumps
    deco4:"skull_pile",     deco4Freq:0.012,   // non-solid ‚Äì bones
    deco5:"ruins_arch",     deco5Freq:0.010,   // non-solid ‚Äì ruins
    wallColor:"#8b6914",wallAccent:"#c8a44a",
    eColor:"#ffa726",
    enemies:[
      {name:"Sand Beetle",   sprite:"sandbeetle",    baseHp:50, baseAtk:14, sc:0.45,type:"easy"},
      {name:"Mummy",         sprite:"mummy",         baseHp:75, baseAtk:20, sc:0.55,type:"medium"},
      {name:"Bone Archer",   sprite:"bonearcher",    baseHp:85, baseAtk:24, sc:0.55,type:"medium"},
      {name:"Dust Djinn",    sprite:"dustdjinn",     baseHp:95, baseAtk:28, sc:0.60,type:"hard"},
      {name:"Scorpion Guard",sprite:"scorpionguard", baseHp:110,baseAtk:20, sc:0.50,type:"hard",unique:true,count:1},
    ],
    boss:{name:"Sand Warlord",sprite:"sandwarlord",bossHpMult:3,bossAtkMult:1.7,sc:0.65},
    dw:{easy:.30,medium:.55,hard:.15},
    desc:"Scorching sands hide many deadly predators.",
    unlockHint:"Defeat the Scorpion Guard to unlock the boss.",
  },
  {
    id:2,name:"Ice",emoji:"‚ùÑÔ∏è",
    bg:"#091824",tile:"ice_tile",townTile:"town_tile",
    deco:"iceberg_deco",   decoFreq:0.04,   // solid icebergs
    deco2:"frozen_spire",  deco2Freq:0.02,  // solid spires
    deco3:"snowdrift",     deco3Freq:0.055, // non-solid drifts
    deco4:"ice_crack",     deco4Freq:0.04,  // non-solid cracks
    deco5:"frozen_pond",   deco5Freq:0.012, // non-solid pools
    wallColor:"#0a3050",wallAccent:"#4099aa",
    eColor:"#80deea",
    enemies:[
      {name:"Snow Puff",     sprite:"snowpuff",      baseHp:65, baseAtk:18, sc:0.55,type:"easy"},
      {name:"Frost Wraith",  sprite:"frostwraith",   baseHp:90, baseAtk:26, sc:0.65,type:"medium"},
      {name:"Blizzard Bat",  sprite:"blizzardbat",   baseHp:100,baseAtk:30, sc:0.65,type:"medium"},
      {name:"Glacier Crab",  sprite:"glaciercrab",   baseHp:115,baseAtk:24, sc:0.60,type:"hard"},
      {name:"Crystal Golem", sprite:"crystalgolem",  baseHp:130,baseAtk:22, sc:0.55,type:"hard",unique:true,count:1},
    ],
    boss:{name:"Ice Titan",sprite:"icetitan",bossHpMult:3,bossAtkMult:1.8,sc:0.72},
    dw:{easy:.10,medium:.50,hard:.40},
    desc:"A frozen wasteland haunted by ancient creatures.",
    unlockHint:"Defeat the Crystal Golem to unlock the boss.",
  },
  {
    id:3,name:"Volcano",emoji:"üåã",
    bg:"#130a04",tile:"lava_tile",townTile:"town_tile",
    deco:"rock_deco",      decoFreq:0.04,   // solid rocks
    deco2:"obsidian_chunk",deco2Freq:0.025, // solid obsidian
    deco3:"lava_bubble",   deco3Freq:0.04,  // non-solid lava pools
    deco4:"ash_field",     deco4Freq:0.05,  // non-solid ash
    wallColor:"#3a0a0a",wallAccent:"#cc3300",
    eColor:"#ef5350",
    enemies:[
      {name:"Ember Sprite",  sprite:"embersprite",   baseHp:80, baseAtk:24, sc:0.62,type:"easy"},
      {name:"Magma Golem",   sprite:"magmagolem",    baseHp:110,baseAtk:34, sc:0.72,type:"medium"},
      {name:"Ash Phantom",   sprite:"ashphantom",    baseHp:120,baseAtk:38, sc:0.70,type:"medium"},
      {name:"Lava Serpent",  sprite:"lavaserpent",   baseHp:135,baseAtk:42, sc:0.72,type:"hard"},
      {name:"Volcano Drake", sprite:"volcanodrake",  baseHp:155,baseAtk:36, sc:0.68,type:"hard",unique:true,count:1},
    ],
    boss:{name:"Inferno King",sprite:"infernoking",bossHpMult:3,bossAtkMult:2.0,sc:0.80},
    dw:{easy:.05,medium:.25,hard:.70},
    desc:"The ultimate volcanic trial. Many terrors guard the Inferno King.",
    unlockHint:"Defeat the Volcano Drake to unlock the boss.",
  },
];

// ================================================================
// ITEMS
// ================================================================
const ITEMS=[
  // Common drops (any enemy)
  {id:'scroll_minor',name:'Minor Scroll',icon:'üìú',desc:'Restore 20 HP',rarity:'common',
   effect:p=>{p.hp=Math.min(p.maxHp,p.hp+20);},effectDesc:'+20 HP',consumable:true},
  {id:'herb',name:'Forest Herb',icon:'üåø',desc:'Restore 40 HP',rarity:'common',
   effect:p=>{p.hp=Math.min(p.maxHp,p.hp+40);},effectDesc:'+40 HP',consumable:true},
  {id:'lucky_charm',name:'Lucky Charm',icon:'üçÄ',desc:'+5% dodge chance permanently',rarity:'uncommon',
   effect:p=>{p.dodge=Math.min(0.8,p.dodge+0.05);},effectDesc:'+5% Dodge',consumable:true},
  {id:'focus_stone',name:'Focus Stone',icon:'üíé',desc:'+3 attack permanently',rarity:'uncommon',
   effect:p=>{p.atk+=3;},effectDesc:'+3 ATK',consumable:true},
  {id:'iron_veil',name:'Iron Veil',icon:'üõ°Ô∏è',desc:'+4 defense permanently',rarity:'uncommon',
   effect:p=>{p.def+=4;},effectDesc:'+4 DEF',consumable:true},
  // Rare drops (medium+ enemies)
  {id:'tome_knowledge',name:'Tome of Knowledge',icon:'üìö',desc:'+5 ATK & +10 max HP',rarity:'rare',
   effect:p=>{p.atk+=5;p.maxHp+=10;p.hp=Math.min(p.maxHp,p.hp+10);},effectDesc:'+5 ATK +10 MaxHP',consumable:true},
  {id:'crystal_lens',name:'Crystal Lens',icon:'üîÆ',desc:'+8% crit chance permanently',rarity:'rare',
   effect:p=>{p.crit=Math.min(0.9,p.crit+0.08);},effectDesc:'+8% Crit',consumable:true},
  {id:'potion_full',name:'Full Elixir',icon:'üß™',desc:'Restore full HP',rarity:'rare',
   effect:p=>{p.hp=p.maxHp;},effectDesc:'Full Heal',consumable:true},
  // Epic drops (unique/boss enemies)
  {id:'crown_wisdom',name:'Crown of Wisdom',icon:'üëë',desc:'+10 ATK +10 DEF +10% dodge',rarity:'epic',
   effect:p=>{p.atk+=10;p.def+=10;p.dodge=Math.min(0.8,p.dodge+0.10);},effectDesc:'+10ATK +10DEF +10%Dodge',consumable:true},
  {id:'phoenix_feather',name:'Phoenix Feather',icon:'ü™∂',desc:'+20 max HP & restore full HP',rarity:'epic',
   effect:p=>{p.maxHp+=20;p.hp=p.maxHp;},effectDesc:'+20 MaxHP + Full Heal',consumable:true},
  {id:'ring_quickspeech',name:'Ring of Quick Speech',icon:'üíç',desc:'+15% dodge & +5 ATK',rarity:'epic',
   effect:p=>{p.dodge=Math.min(0.8,p.dodge+0.15);p.atk+=5;},effectDesc:'+15%Dodge +5ATK',consumable:true},
];

const ITEM_RARITY_COLOR={common:'#aaa',uncommon:'#4caf50',rare:'#4fc3f7',epic:'#ce93d8'};

// Drop table: {itemId, chance}
const DROP_TABLES={
  easy:[
    {id:'scroll_minor',chance:0.25},{id:'herb',chance:0.15},{id:'lucky_charm',chance:0.06},
  ],
  medium:[
    {id:'herb',chance:0.20},{id:'focus_stone',chance:0.10},{id:'iron_veil',chance:0.10},
    {id:'crystal_lens',chance:0.05},{id:'tome_knowledge',chance:0.05},
  ],
  hard:[
    {id:'focus_stone',chance:0.15},{id:'tome_knowledge',chance:0.12},{id:'crystal_lens',chance:0.10},
    {id:'potion_full',chance:0.08},
  ],
  unique:[
    {id:'crown_wisdom',chance:0.30},{id:'ring_quickspeech',chance:0.30},{id:'potion_full',chance:0.40},
  ],
  boss:[
    {id:'phoenix_feather',chance:0.60},{id:'crown_wisdom',chance:0.40},
  ],
};

function rollDrops(dropKey){
  const table=DROP_TABLES[dropKey]||[];
  const drops=[];
  table.forEach(entry=>{
    if(Math.random()<entry.chance) drops.push(entry.id);
  });
  return drops;
}

// ================================================================
// XP / LEVEL SYSTEM
// ================================================================
const XP_TABLE=[0,100,220,380,580,830,1140,1520,1980,2530,3180]; // xp needed to reach each level
const MAX_LEVEL=10;

function xpForLevel(lv){return XP_TABLE[Math.min(lv,MAX_LEVEL-1)]||99999;}
function xpReward(etype,isBoss,isUnique){
  if(isBoss) return 80+G.biomeIdx*30;
  if(isUnique) return 50+G.biomeIdx*15;
  const base={easy:12,medium:22,hard:35};
  return (base[etype.type]||12)+G.biomeIdx*5;
}

// Pending level-up allocation
let luPending={pts:0,kn:0,ph:0,qs:0};

function gainXP(amount){
  if(!G.player) return;
  G.player.xp=(G.player.xp||0)+amount;
  const lv=G.player.level||1;
  if(lv<MAX_LEVEL && G.player.xp>=xpForLevel(lv)){
    G.player.xp-=xpForLevel(lv);
    G.player.level=(lv+1);
    G.player.statPoints=(G.player.statPoints||0)+3;
    // Queue levelup screen
    G.pendingLevelUp=true;
  }
  updateHUD();
}

function showLevelUp(){
  G.pendingLevelUp=false;
  AudioEngine.sfxLevelUp();
  const p=G.player;
  luPending={pts:p.statPoints||0,kn:0,ph:0,qs:0};
  document.getElementById('lu-level').textContent=`Reached Level ${p.level}!`;
  document.getElementById('lu-points').textContent=`${luPending.pts} stat point${luPending.pts!==1?'s':''} to distribute`;
  luRender();
  show('levelup');
}

function luAllocate(stat,delta){
  const used=luPending.kn+luPending.ph+luPending.qs;
  const total=luPending.pts;
  if(delta>0 && used>=total) return;
  if(delta<0 && luPending[stat]<=0) return;
  luPending[stat]+=delta;
  luRender();
}

function luRender(){
  ['kn','ph','qs'].forEach(k=>{
    document.getElementById(`lu-${k}-val`).textContent=luPending[k];
  });
  const p=G.player;
  const remaining=luPending.pts-(luPending.kn+luPending.ph+luPending.qs);
  document.getElementById('lu-points').textContent=`${remaining} point${remaining!==1?'s':''} remaining`;
  document.getElementById('lu-confirm').disabled=remaining>0;
  document.getElementById('lu-confirm').style.opacity=remaining>0?'0.4':'1';
  // Preview
  const newAtk=p.atk+luPending.kn*3;
  const newDef=p.def+luPending.ph*3;
  const newDodge=Math.min(0.8,(p.dodge||0)+luPending.qs*0.04);
  document.getElementById('lu-stat-preview').innerHTML=
    `üìñ Knowledge: <b style="color:#ff9800">${p.stats?.kn||0}</b> ‚Üí <b style="color:#ffd700">${(p.stats?.kn||0)+luPending.kn}</b>  ATK: ${p.atk} ‚Üí <b style="color:#ffd700">${newAtk}</b><br>`+
    `üèõÔ∏è Philosophy: <b style="color:#4fc3f7">${p.stats?.ph||0}</b> ‚Üí <b style="color:#ffd700">${(p.stats?.ph||0)+luPending.ph}</b>  DEF: ${p.def} ‚Üí <b style="color:#ffd700">${newDef}</b><br>`+
    `üí¨ Quick Speak: <b style="color:#ce93d8">${p.stats?.qs||0}</b> ‚Üí <b style="color:#ffd700">${(p.stats?.qs||0)+luPending.qs}</b>  Dodge: ${Math.round((p.dodge||0)*100)}% ‚Üí <b style="color:#ffd700">${Math.round(newDodge*100)}%</b>`;
}

function luConfirm(){
  const p=G.player;
  p.atk+=luPending.kn*3;
  p.def+=luPending.ph*3;
  p.dodge=Math.min(0.8,(p.dodge||0)+luPending.qs*0.04);
  if(!p.stats) p.stats={kn:0,ph:0,qs:0};
  p.stats.kn+=luPending.kn;
  p.stats.ph+=luPending.ph;
  p.stats.qs+=luPending.qs;
  p.statPoints=0;
  // If a post-level-up callback is queued (e.g. biome advance), run it now
  const cb = G._postLevelUp;
  G._postLevelUp = null;
  if(cb){ cb(); }
  else { show('explore'); startLoop(); }
}

// ================================================================
// INVENTORY
// ================================================================
function showInventory(){
  stopLoop();
  const p=G.player;
  document.getElementById('inv-stats').innerHTML=
    `Lv.<b style="color:#ce93d8">${p.level}</b>  XP: <b style="color:#4fc3f7">${p.xp}/${xpForLevel(p.level)}</b>  SP: <b style="color:#ffd700">${p.statPoints||0}</b><br>`+
    `üìñ Knowledge: <b style="color:#ff9800">${p.stats?.kn||0}</b> (+${(p.stats?.kn||0)*3} ATK bonus)<br>`+
    `üèõÔ∏è Philosophy: <b style="color:#4fc3f7">${p.stats?.ph||0}</b> (+${(p.stats?.ph||0)*3} DEF bonus)<br>`+
    `üí¨ Quick Speak: <b style="color:#ce93d8">${p.stats?.qs||0}</b> (+${Math.round((p.stats?.qs||0)*4)}% Dodge bonus)<br>`+
    `ATK: <b style="color:#ff9800">${p.atk}</b> | DEF: <b style="color:#4fc3f7">${p.def}</b> | Dodge: <b style="color:#ce93d8">${Math.round((p.dodge||0)*100)}%</b>`;
  const inv=document.getElementById('inv-items');
  inv.innerHTML='';
  const items=p.inventory||[];
  if(!items.length){
    inv.innerHTML='<div style="font-family:monospace;font-size:11px;color:#444;text-align:center;padding:12px;">No items yet. Defeat enemies to find loot!</div>';
  } else {
    items.forEach((itemId,idx)=>{
      const item=ITEMS.find(i=>i.id===itemId);
      if(!item) return;
      const row=document.createElement('div');row.className='item-row';
      row.innerHTML=`<div class="item-icon">${item.icon}</div>
        <div class="item-info">
          <div class="item-name" style="color:${ITEM_RARITY_COLOR[item.rarity]}">${item.name}</div>
          <div class="item-desc">${item.desc}</div>
        </div>
        <button class="item-use" onclick="useItem(${idx})"${!item.consumable?'disabled':''}>USE</button>`;
      inv.appendChild(row);
    });
  }
  show('inventory');
}

function useItem(idx){
  const p=G.player;
  const items=p.inventory||[];
  const itemId=items[idx];
  const item=ITEMS.find(i=>i.id===itemId);
  if(!item||!item.consumable) return;
  AudioEngine.sfxItemUse();
  item.effect(p);
  items.splice(idx,1);
  showItemDrop(`Used ${item.icon} ${item.name}: ${item.effectDesc}`,2000);
  showInventory(); // refresh
}

function showItemDrop(msg,dur=3000){
  const el=document.getElementById('itemdrop');
  el.textContent=msg;
  el.style.display='block';
  el.style.animation='none';void el.offsetWidth;
  el.style.animation='popIn .4s ease';
  clearTimeout(el._t);
  el._t=setTimeout(()=>{el.style.display='none';},dur);
}

document.getElementById('inv-close').onclick=()=>{
  if(G.screen==='inventory'){show('explore');startLoop();}
};
const WW=1280,WH=720,TILE=32;
const COLS=Math.ceil(WW/TILE)+2, ROWS=Math.ceil(WH/TILE)+2;
let terrainMap=[]; // 0=base tile, 1=town tile, 2=deco/obstacle
let decoPositions=[];

function buildTerrain(biomeIdx){
  const b=BIOMES[biomeIdx];
  terrainMap=[];
  decoPositions=[];
  for(let r=0;r<ROWS;r++){
    terrainMap[r]=[];
    for(let c=0;c<COLS;c++){
      const wx=(c)*TILE, wy=(r)*TILE;
      const distTown=Math.hypot(wx+TILE/2-TOWN_X,wy+TILE/2-TOWN_Y);
      if(distTown<TOWN_SAFE) terrainMap[r][c]=1; // town tile
      else terrainMap[r][c]=0;
    }
  }
  // Scatter decorations ‚Äî keep a clear buffer around the town safe zone
  for(let r=1;r<ROWS-1;r++){
    for(let c=1;c<COLS-1;c++){
      const wx=c*TILE,wy=r*TILE;
      const distTown=Math.hypot(wx-TOWN_X,wy-TOWN_Y);
      if(distTown>(TOWN_SAFE+32) && terrainMap[r][c]===0){
        const roll=Math.random();
        let cum=0;
        if(b.decoFreq  && roll<(cum+=b.decoFreq)){  terrainMap[r][c]=2; decoPositions.push({x:wx,y:wy,r,c}); }
        else if(b.deco2Freq && roll<(cum+=b.deco2Freq)){ terrainMap[r][c]=3; decoPositions.push({x:wx,y:wy,r,c}); }
        else if(b.deco3Freq && roll<(cum+=b.deco3Freq)){ terrainMap[r][c]=4; }
        else if(b.deco4Freq && roll<(cum+=b.deco4Freq)){ terrainMap[r][c]=5; }
        else if(b.deco5Freq && roll<(cum+=b.deco5Freq)){ terrainMap[r][c]=6; }
      }
    }
  }
}

function isSolid(wx,wy){
  const c=Math.floor(wx/TILE), r=Math.floor(wy/TILE);
  if(r<0||r>=ROWS||c<0||c>=COLS) return false;
  const tv=terrainMap[r][c];
  return tv===2||tv===3; // 2=primary solid deco, 3=secondary solid deco
}

// ================================================================
// STATE
// ================================================================
const G={
  screen:"menu",player:null,biomeIdx:0,
  defeated:new Set(),usedQ:new Set(),
  enemies:[],px:400,py:300,inTown:false,
  keys:new Set(),jdx:0,jdy:0,loopId:null,
  animFrame:0, animTick:0,
  eid:null,eBoss:false,eHp:0,eMaxHp:0,
  cEnemyType:null,
  cAction:null,cQ:null,cTimer:15,cTimerInt:null,
  cAnswered:false,cCorrect:false,
  combatFlash:0, playerFlash:0,
  // Aggro system
  aggroEnemy:null,
  aggroPhase:null,
  aggroTimer:0,
  frozen:false,
  // Boss unlock
  uniqueKilled:false,
  bossLockFlash:0,
  bossUnlockFlash:0,
  eUnique:false,
  // Level-up
  pendingLevelUp:false,
  pendingDrops:[],   // items queued to give after combat ends
  _postLevelUp:null, // callback to run after level-up screen is confirmed
};
const SPD=2.8;
const AGGRO_DETECT = 120;   // px ‚Äì enemy notices player
const AGGRO_WARN   = 60;    // frames of "!" warning before charge
const CHARGE_SPD   = 5.5;   // pixels/frame while charging

function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function dst(ax,ay,bx,by){return Math.hypot(ax-bx,ay-by);}

// ‚îÄ‚îÄ Line-of-sight raycaster: returns false if a solid tile blocks the path ‚îÄ‚îÄ
// Steps along the line in TILE/2 increments and checks isSolid at each point.
function hasLOS(x1,y1,x2,y2){
  const dx=x2-x1, dy=y2-y1;
  const len=Math.hypot(dx,dy);
  if(len<1) return true;
  const step=TILE*0.5;           // sample every half-tile
  const nx=dx/len, ny=dy/len;
  const steps=Math.ceil(len/step);
  for(let i=1;i<steps;i++){
    const px2=x1+nx*step*i, py2=y1+ny*step*i;
    if(isSolid(px2,py2)) return false;
  }
  return true;
}

const TOWN_X=400, TOWN_Y=300;
const TOWN_SAFE=140;  // px ‚Äî inside this radius enemies cannot aggro (matches visual ring ~105 + buffer)

function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  G.screen=id;
  // Music routing
  if(id==='menu')      AudioEngine.playMenu();
  else if(id==='explore') AudioEngine.playExplore();
  else if(id==='gameover') AudioEngine.playDefeat();
  else if(id==='victory')  AudioEngine.playVictory();
  // 'combat' music is set in beginCombat() based on enemy type
  // 'paused','levelup','inventory','charsel' keep current music
}

// ================================================================
// MENU
// ================================================================
(function(){
  const el=document.getElementById('menu-stars');
  for(let i=0;i<24;i++){
    const s=document.createElement('div');s.className='star';
    s.style.left=(i*37)%100+'%';s.style.top=(i*53)%85+'%';
    el.appendChild(s);
  }
  let t=0;
  setInterval(()=>{t++;el.querySelectorAll('.star').forEach((s,i)=>s.style.opacity=(t+i)%3===0?'1':'0.15');},500);
  // Draw some sprites on menu canvas
  const mc=document.getElementById('menu-sprite-canvas');
  mc.width=200;mc.height=80;
  const mctx=mc.getContext('2d');
  mctx.fillStyle='transparent';
  px(mctx,SPRITES.scholar,4,8,4);
  px(mctx,SPRITES.guardian,72,8,4);
  px(mctx,SPRITES.strategist,140,8,4);
})();

document.getElementById('btn-start').onclick=()=>{AudioEngine.init();show('charsel');buildChars();};
document.getElementById('btn-back').onclick=()=>show('menu');

// ================================================================
// CHAR SELECT
// ================================================================
function buildChars(){
  const g=document.getElementById('char-grid');g.innerHTML='';
  CHARS.forEach(c=>{
    const d=document.createElement('div');d.className='ccard';
    // Sprite canvas
    const sc=document.createElement('canvas');
    sc.width=64;sc.height=64;sc.style.imageRendering='pixelated';
    sc.style.display='block';sc.style.margin='0 auto 8px';
    const sctx=sc.getContext('2d');
    px(sctx,SPRITES[c.sprite],0,0,4);
    d.appendChild(sc);
    const info=document.createElement('div');
    info.innerHTML=`<div class="cname" style="color:${c.color}">${c.name}</div>
      <div class="cdesc">${c.desc}</div>
      <div class="cstats">‚ù§Ô∏è HP: <span style="color:#ef5350">${c.hp}</span><br>
        ‚öîÔ∏è ATK: <span style="color:#ff9800">${c.atk}</span><br>
        üõ°Ô∏è DEF: <span style="color:#4fc3f7">${c.def}</span><br>
        üí• CRIT: <span style="color:#ffd700">${Math.round(c.crit*100)}%</span><br>
        üí® DODGE: <span style="color:#ce93d8">${Math.round(c.dodge*100)}%</span></div>`;
    d.appendChild(info);
    d.onmouseenter=()=>{d.style.borderColor=c.color;d.style.transform='translateY(-4px)';d.style.boxShadow=`0 8px 24px ${c.color}44`;d.style.background=`${c.color}11`;};
    d.onmouseleave=()=>{d.style.borderColor='#333';d.style.transform='';d.style.boxShadow='';d.style.background='#0a0a1a';};
    d.onclick=()=>startGame(c.id);
    g.appendChild(d);
  });
}

// ================================================================
// START / WORLD
// ================================================================
function startGame(id){
  const c=CHARS[id];
  G.player={
    ...c, maxHp:c.hp,
    level:1, xp:0, statPoints:0,
    stats:{kn:0,ph:0,qs:0},
    inventory:[],
  };
  G.defeated=new Set();G.usedQ=new Set();
  G.biomeIdx=0;
  initWorld();show('explore');layoutUI();showIntro();
  document.getElementById('inventory-btn').style.display='block';
}

function initWorld(){
  const b=BIOMES[G.biomeIdx];
  G.px=400;G.py=300;G.enemies=[];
  G.aggroPhase=null;G.aggroEnemy=null;G.aggroTimer=0;G.frozen=false;
  G.uniqueKilled=false;
  G._bossDialogueShown=false;
  G._gkDialogueShown=false;
  G.nearPuzzle=null;
  G.gatekeepersKilled=0;
  G.gatekeepersNeeded=2;
  G.fountains=[];
  G.puzzlePoints=[];
  buildTerrain(G.biomeIdx);

  let id=0;

  // ‚îÄ‚îÄ Roaming enemies (reduced counts) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  b.enemies.forEach((etype)=>{
    if(etype.unique) return;
    const count = etype.type==='easy'?2 : etype.type==='medium'?2 : 1;
    for(let i=0;i<count;i++){
      let x,y,tries=0;
      do{x=80+Math.random()*(WW-160);y=60+Math.random()*(WH-120);tries++;}
      while((dst(x,y,400,300)<170||isSolid(x,y))&&tries<80);
      const hp=etype.baseHp+G.biomeIdx*8;
      const spd=etype.type==='medium'?1.4:etype.type==='hard'?1.6:1.0;
      G.enemies.push({id:id++,x,y,dx:(Math.random()-.5)*spd,dy:(Math.random()-.5)*spd,
        hp,maxHp:hp,dead:false,boss:false,unique:false,standing:false,gatekeeper:false,etype});
    }
  });

  // ‚îÄ‚îÄ Standing Sentinels (must be defeated before unique unlocks) ‚îÄ
  const hardEtype=b.enemies.find(e=>e.type==='hard'&&!e.unique)||b.enemies[b.enemies.length-2]||b.enemies[0];
  for(let i=0;i<G.gatekeepersNeeded;i++){
    let gx,gy,tries=0;
    do{
      gx=180+Math.random()*(WW-360);
      gy=90+Math.random()*(WH-180);
      tries++;
    }while((dst(gx,gy,400,300)<220||isSolid(gx,gy)||
            G.enemies.some(e=>dst(e.x,e.y,gx,gy)<100))&&tries<120);
    const hp=Math.round((hardEtype.baseHp+G.biomeIdx*8)*1.25);
    G.enemies.push({id:id++,x:gx,y:gy,dx:0,dy:0,
      hp,maxHp:hp,dead:false,boss:false,unique:false,standing:true,gatekeeper:true,etype:hardEtype});
  }

  // ‚îÄ‚îÄ Unique guardian ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ug=b.enemies.find(e=>e.unique);
  if(ug){
    let ux,uy,tries=0;
    do{ux=120+Math.random()*(WW*0.65-120);uy=80+Math.random()*(WH-160);tries++;}
    while((dst(ux,uy,400,300)<350||dst(ux,uy,WW-120,WH/2)<200||isSolid(ux,uy))&&tries<120);
    const uhp=ug.baseHp+G.biomeIdx*12;
    G.enemies.push({id:id++,x:ux,y:uy,dx:0,dy:0,hp:uhp,maxHp:uhp,
      dead:false,boss:false,unique:true,standing:false,gatekeeper:false,etype:ug});
  }

  // ‚îÄ‚îÄ Boss ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!G.defeated.has(G.biomeIdx)){
    const be=b.boss;
    const baseHp=(b.enemies[0].baseHp+G.biomeIdx*8)*be.bossHpMult;
    G.enemies.push({id:id++,x:WW-120,y:WH/2,dx:0,dy:0,
      hp:Math.round(baseHp),maxHp:Math.round(baseHp),
      dead:false,boss:true,unique:false,standing:false,gatekeeper:false,locked:true,
      etype:{...b.enemies[0],name:be.name,sprite:be.sprite,
             baseAtk:b.enemies[0].baseAtk*be.bossAtkMult,sc:be.sc}});
  }

  // ‚îÄ‚îÄ Healing Fountains (3 per biome) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const fcol={0:'#44ffcc',1:'#44aaff',2:'#aaddff',3:'#ff8844'};
  for(let i=0;i<3;i++){
    let fx,fy,tries=0;
    do{fx=110+Math.random()*(WW-220);fy=90+Math.random()*(WH-180);tries++;}
    while((dst(fx,fy,400,300)<140||isSolid(fx,fy)||
           G.fountains.some(f=>dst(f.x,f.y,fx,fy)<140))&&tries<120);
    G.fountains.push({x:fx,y:fy,cooldown:0,color:fcol[G.biomeIdx]||'#44ffcc'});
  }

  // ‚îÄ‚îÄ Puzzle POIs (3 per biome) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const poiByBiome=[
    ['cabin','cave','ancient_oak'],
    ['oasis','ruin','cave'],
    ['shrine','cave','cabin'],
    ['altar','shrine','ruin'],
  ];
  const poiIcons={cabin:'üèöÔ∏è',cave:'üóø',ancient_oak:'üå≥',oasis:'üå¥',ruin:'üèõÔ∏è',shrine:'üíé',altar:'üî•'};
  const poiNames={cabin:'Mysterious Cabin',cave:'Dark Cave',ancient_oak:'Ancient Oak',
                  oasis:'Desert Oasis',ruin:'Ancient Ruin',shrine:'Ice Shrine',altar:'Lava Altar'};
  const ptypes=poiByBiome[G.biomeIdx]||['cave','cabin','shrine'];
  for(let i=0;i<3;i++){
    let px2,py2,tries=0;
    do{px2=110+Math.random()*(WW-220);py2=90+Math.random()*(WH-180);tries++;}
    while((dst(px2,py2,400,300)<160||isSolid(px2,py2)||
           G.puzzlePoints.some(p=>dst(p.x,p.y,px2,py2)<150)||
           G.fountains.some(f=>dst(f.x,f.y,px2,py2)<100))&&tries<120);
    G.puzzlePoints.push({x:px2,y:py2,type:ptypes[i],used:false,cooldown:0,
      icon:poiIcons[ptypes[i]]||'‚ùì',name:poiNames[ptypes[i]]||'Mystery'});
  }
}

// ================================================================
// CANVAS DRAW
// ================================================================
const cv=document.getElementById('world-canvas');
const cx=cv.getContext('2d');
const mc=document.getElementById('mm-canvas');
const mx=mc.getContext('2d');

// Pre-render tile strips
const tileStrips={};
function getTileStrip(spriteName,scale){
  const key=spriteName+'_'+scale;
  if(tileStrips[key]) return tileStrips[key];
  const sp=SPRITES[spriteName];
  if(!sp) return null;
  const rows=sp.length,cols=sp[0].length;
  // Make a strip of 4 tiles wide for variation
  const c2=document.createElement('canvas');
  c2.width=cols*scale*4;c2.height=rows*scale;
  const c2x=c2.getContext('2d');
  for(let t=0;t<4;t++) px(c2x,sp,t*cols*scale,0,scale);
  tileStrips[key]=c2;
  return c2;
}

let playerWalkFrame=0, playerWalkTick=0;

// ‚îÄ‚îÄ Draw procedural POI structures ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawPOI(ctx, x, y, type, pulse, nearPlayer){
  const glow=nearPlayer?`rgba(255,215,0,${0.3+pulse*0.4})`:`rgba(255,215,0,0.12)`;
  // Outer aura
  ctx.save();
  ctx.beginPath();ctx.arc(x,y,30,0,Math.PI*2);
  ctx.fillStyle=glow;ctx.fill();
  ctx.restore();

  if(type==='cave'){
    // Dark rocky arch
    ctx.save();
    ctx.fillStyle='#2a1a0a';ctx.beginPath();ctx.arc(x,y,20,Math.PI,0);ctx.fill();
    ctx.fillStyle='#111';ctx.beginPath();ctx.arc(x,y+2,14,Math.PI*1.1,-0.1);ctx.fill();
    ctx.fillStyle='#444';ctx.lineWidth=3;ctx.strokeStyle='#555';
    ctx.strokeRect(x-20,y,5,12);ctx.strokeRect(x+15,y,5,12);
    ctx.fillStyle='#333';ctx.fillRect(x-20,y,40,3); // lintel
    ctx.restore();
    ctx.font="14px serif";ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üóø',x,y-28);

  } else if(type==='cabin'){
    // Log cabin
    ctx.save();
    ctx.fillStyle='#5a3010';ctx.fillRect(x-18,y-10,36,22);
    ctx.strokeStyle='#3a1a00';ctx.lineWidth=2;ctx.strokeRect(x-18,y-10,36,22);
    // Roof triangle
    ctx.fillStyle='#8B4513';ctx.beginPath();
    ctx.moveTo(x-22,y-10);ctx.lineTo(x,y-28);ctx.lineTo(x+22,y-10);ctx.closePath();ctx.fill();
    ctx.strokeStyle='#5a2a00';ctx.stroke();
    // Door
    ctx.fillStyle='#222';ctx.fillRect(x-5,y+2,10,10);
    // Window
    ctx.fillStyle='#ffdd88';ctx.fillRect(x-16,y-6,8,7);
    ctx.strokeStyle='#8B6914';ctx.lineWidth=1;ctx.strokeRect(x-16,y-6,8,7);
    ctx.restore();
    ctx.font="14px serif";ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üèöÔ∏è',x,y-42);

  } else if(type==='oasis'){
    // Desert oasis: blue pool + palm
    ctx.save();
    ctx.fillStyle='#1a4a88';ctx.beginPath();ctx.ellipse(x,y+6,18,10,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#44aaff';ctx.lineWidth=2;ctx.stroke();
    // Ripple
    ctx.globalAlpha=0.3+pulse*0.3;ctx.beginPath();ctx.ellipse(x,y+6,12,6,0,0,Math.PI*2);
    ctx.strokeStyle='#88ddff';ctx.lineWidth=1;ctx.stroke();ctx.globalAlpha=1;
    // Palm trunk
    ctx.fillStyle='#8B6914';ctx.fillRect(x-3,y-20,6,24);
    // Fronds
    ctx.strokeStyle='#1a8a1a';ctx.lineWidth=3;ctx.setLineDash([]);
    [[-24,-12],[-16,-22],[-4,-26],[12,-22],[20,-12]].forEach(([dx2,dy2])=>{
      ctx.beginPath();ctx.moveTo(x,y-18);ctx.lineTo(x+dx2,y+dy2);ctx.stroke();
    });
    ctx.restore();
    ctx.font="14px serif";ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üå¥',x,y-46);

  } else if(type==='ancient_oak'){
    // Giant glowing tree
    ctx.save();
    ctx.shadowColor='#44ff88';ctx.shadowBlur=20*pulse;
    ctx.fillStyle='#1a5a1a';ctx.beginPath();ctx.arc(x,y-8,22,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#2a8a3a';ctx.beginPath();ctx.arc(x-8,y-14,14,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#2a8a3a';ctx.beginPath();ctx.arc(x+8,y-14,14,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#3aaa4a';ctx.beginPath();ctx.arc(x,y-20,14,0,Math.PI*2);ctx.fill();
    ctx.restore();
    ctx.fillStyle='#5a3010';ctx.fillRect(x-5,y+10,10,14);
    ctx.font="13px serif";ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ú®',x,y-38);

  } else if(type==='shrine'){
    // Ice crystal shrine
    ctx.save();
    ctx.strokeStyle=nearPlayer?`rgba(180,240,255,${0.8+pulse*0.2})`:'rgba(100,180,220,0.6)';
    ctx.lineWidth=2;ctx.setLineDash([]);
    // Crystal spires
    [[x-12,y-30],[x,y-38],[x+12,y-30]].forEach(([sx,sy])=>{
      ctx.fillStyle='rgba(80,200,240,0.7)';
      ctx.beginPath();ctx.moveTo(sx-5,y+4);ctx.lineTo(sx,sy);ctx.lineTo(sx+5,y+4);ctx.closePath();ctx.fill();
      ctx.stroke();
    });
    ctx.fillStyle='#1a3a5a';ctx.fillRect(x-16,y+4,32,8);
    ctx.restore();
    ctx.font="13px serif";ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üíé',x,y-50);

  } else if(type==='altar'){
    // Lava altar
    ctx.save();
    ctx.fillStyle='#3a1a0a';ctx.fillRect(x-16,y-4,32,18);
    ctx.fillStyle='#5a2a10';ctx.fillRect(x-12,y-10,24,6);
    ctx.fillStyle='#8a4a20';ctx.fillRect(x-8,y-14,16,4);
    // Flame
    ctx.shadowColor='#ff6600';ctx.shadowBlur=16*pulse;
    ctx.font="18px serif";ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('üî•',x,y-24);
    ctx.restore();
    ctx.font="13px serif";ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ö°',x,y-46);

  } else if(type==='ruin'){
    // Broken stone arch
    ctx.save();
    ctx.fillStyle='#6a6a5a';
    ctx.fillRect(x-20,y-28,8,32);
    ctx.fillRect(x+12,y-22,8,26);
    ctx.fillRect(x-20,y-28,18,7); // broken lintel left
    ctx.fillStyle='#4a4a3a';ctx.strokeStyle='#888';ctx.lineWidth=1;
    ctx.strokeRect(x-20,y-28,8,32);ctx.strokeRect(x+12,y-22,8,26);
    ctx.restore();
    ctx.font="13px serif";ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üèõÔ∏è',x,y-44);
  }

  // Interaction glow when near
  if(nearPlayer){
    ctx.save();
    ctx.strokeStyle=`rgba(255,215,0,${0.5+pulse*0.5})`;ctx.lineWidth=2;ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.arc(x,y,34,0,Math.PI*2);ctx.stroke();
    ctx.restore();
  }
}

function drawWorld(){
  const ex=document.getElementById('explore');
  const newW=ex.clientWidth||window.innerWidth;
  const newH=ex.clientHeight||window.innerHeight;
  if(cv.width!==newW||cv.height!==newH){cv.width=newW;cv.height=newH;}
  const W=cv.width,H=cv.height;
  const b=BIOMES[G.biomeIdx];
  const camX=clamp(G.px-W/2,0,WW-W);
  const camY=clamp(G.py-H/2,0,WH-H);

  // Background
  cx.fillStyle=b.bg;cx.fillRect(0,0,W,H);

  // Draw terrain tiles
  const sp_base=SPRITES[b.tile];
  const sp_town=SPRITES[b.townTile||'town_tile'];
  const sp_deco =b.deco  ? SPRITES[b.deco]  : null;
  const sp_deco2=b.deco2 ? SPRITES[b.deco2] : null;
  const sp_deco3=b.deco3 ? SPRITES[b.deco3] : null;
  const sp_deco4=b.deco4 ? SPRITES[b.deco4] : null;
  const sp_deco5=b.deco5 ? SPRITES[b.deco5] : null;
  const c0=Math.floor(camX/TILE)-1,c1=Math.ceil((camX+W)/TILE)+1;
  const r0=Math.floor(camY/TILE)-1,r1=Math.ceil((camY+H)/TILE)+1;

  for(let r=Math.max(0,r0);r<Math.min(ROWS,r1);r++){
    for(let c=Math.max(0,c0);c<Math.min(COLS,c1);c++){
      const wx=c*TILE,wy=r*TILE;
      const sx=wx-camX,sy=wy-camY;
      const tval=terrainMap[r]?terrainMap[r][c]||0:0;
      // Draw base tile (town tile for tval=1, base tile for everything else)
      const sp=tval===1?sp_town:sp_base;
      if(sp) px(cx,sp,sx,sy,TILE/sp[0].length);
      // Draw deco overlay on top of base
      if(tval===2 && sp_deco)  px(cx,sp_deco, sx,sy,TILE/sp_deco[0].length);
      if(tval===3 && sp_deco2) px(cx,sp_deco2,sx,sy,TILE/sp_deco2[0].length);
      if(tval===4 && sp_deco3) px(cx,sp_deco3,sx,sy,TILE/sp_deco3[0].length);
      if(tval===5 && sp_deco4) px(cx,sp_deco4,sx,sy,TILE/sp_deco4[0].length);
      if(tval===6 && sp_deco5) px(cx,sp_deco5,sx,sy,TILE/sp_deco5[0].length);
    }
  }

  // Town circle glow
  cx.save();
  cx.strokeStyle='rgba(144,238,144,0.45)';cx.lineWidth=3;
  cx.setLineDash([6,4]);cx.beginPath();
  cx.arc(TOWN_X-camX,TOWN_Y-camY,TOWN_SAFE,0,Math.PI*2);cx.stroke();cx.restore();
  cx.font="8px 'Press Start 2P'";cx.fillStyle='#90ee90';cx.textAlign='center';cx.textBaseline='alphabetic';
  cx.fillText('TOWN',TOWN_X-camX,TOWN_Y-camY-(TOWN_SAFE+7));

  // Enemies
  G.animTick=(G.animTick+1)%20;
  if(G.animTick===0) G.animFrame=(G.animFrame+1)%4;

  G.enemies.forEach(e=>{
    if(e.dead)return;
    const sp=SPRITES[e.etype.sprite];
    if(!sp) return;
    const sc=e.boss?3:e.unique?2.5:2;
    const sw=sp[0].length*sc,sh=sp.length*sc;
    const ex2=e.x-camX-sw/2, ey2=e.y-camY-sh/2;

    if(e.boss && e.locked){
      // Locked boss: greyed out, chains drawn, lock icon
      cx.save();
      cx.globalAlpha=0.35;
      cx.filter='grayscale(100%)';
      px(cx,sp,ex2,ey2,sc);
      cx.restore();
      // Lock chain ring
      cx.save();
      cx.strokeStyle='rgba(180,140,0,0.6)';cx.lineWidth=3;cx.setLineDash([5,4]);
      cx.beginPath();cx.arc(e.x-camX,e.y-camY,sw/2+14,0,Math.PI*2);cx.stroke();
      cx.restore();
      // üîí label
      cx.font="13px serif";cx.textAlign='center';cx.textBaseline='middle';
      cx.fillText('üîí',e.x-camX,e.y-camY-sh/2-14);
      cx.font="6px 'Press Start 2P'";cx.fillStyle='#aa8800';cx.textBaseline='alphabetic';
      cx.fillText('BOSS ‚Äî LOCKED',e.x-camX,e.y-camY-sh/2-24);
    } else if(e.boss){
      // Unlocked boss: fiery glow
      cx.save();
      cx.shadowColor=BIOMES[G.biomeIdx].eColor;cx.shadowBlur=16;
      px(cx,sp,ex2,ey2,sc);
      cx.restore();
      cx.font="7px 'Press Start 2P'";cx.fillStyle='#ff4444';cx.textAlign='center';cx.textBaseline='alphabetic';
      cx.fillText('‚ö† BOSS',e.x-camX,e.y-camY-sh/2-5);
    } else if(e.unique){
      // Unique guardian: gold shimmer ‚Äî show locked if gatekeepers still alive
      const gkAlive=G.enemies.filter(en=>en.gatekeeper&&!en.dead).length;
      const shimmer=0.7+Math.sin(Date.now()/300)*0.3;
      cx.save();
      if(gkAlive>0){cx.globalAlpha=0.5;cx.filter='grayscale(60%)';}
      else{cx.shadowColor='#ffd700';cx.shadowBlur=Math.round(10*shimmer);}
      const bob=Math.sin(G.animFrame*1.5+e.id)*1.5;
      px(cx,sp,ex2,ey2+bob,sc);
      cx.restore();
      // Ring
      cx.save();
      cx.strokeStyle=gkAlive>0?`rgba(180,100,0,0.5)`:`rgba(255,215,0,${0.5+shimmer*0.4})`;
      cx.lineWidth=2;cx.setLineDash([]);
      cx.beginPath();cx.arc(e.x-camX,e.y-camY,sw/2+8,0,Math.PI*2);cx.stroke();
      cx.restore();
      cx.font="6px 'Press Start 2P'";
      cx.fillStyle=gkAlive>0?'#cc8800':'#ffd700';cx.textAlign='center';cx.textBaseline='alphabetic';
      cx.fillText(gkAlive>0?`‚öîÔ∏è SEALED (${gkAlive} left)`:'üîë GUARDIAN',e.x-camX,e.y-camY-sh/2-5);
    } else if(e.gatekeeper){
      // Standing sentinel: orange glow, crossed swords icon
      const pulse=0.7+Math.sin(Date.now()/400)*0.3;
      cx.save();
      cx.shadowColor='#ff9800';cx.shadowBlur=Math.round(12*pulse);
      px(cx,sp,ex2,ey2,sc); // no bob ‚Äî standing still
      cx.restore();
      cx.save();
      cx.strokeStyle=`rgba(255,152,0,${0.4+pulse*0.5})`;cx.lineWidth=2;cx.setLineDash([3,3]);
      cx.beginPath();cx.arc(e.x-camX,e.y-camY,sw/2+8,0,Math.PI*2);cx.stroke();
      cx.restore();
      cx.font="11px serif";cx.textAlign='center';cx.textBaseline='middle';
      cx.fillText('‚öîÔ∏è',e.x-camX,e.y-camY-sh/2-14);
      cx.font="6px 'Press Start 2P'";cx.fillStyle='#ff9800';cx.textBaseline='alphabetic';
      cx.fillText('SENTINEL',e.x-camX,e.y-camY-sh/2-24);
    } else {
      // Normal enemy
      const bob=Math.sin(G.animFrame*1.5+e.id)*1.5;
      px(cx,sp,ex2,ey2+bob,sc);
    }

    // HP bar (skip locked boss)
    if(!(e.boss && e.locked)){
      const bw=sw;
      const bhp=Math.max(0,e.hp/e.maxHp);
      cx.fillStyle='#111';cx.fillRect(e.x-camX-bw/2,e.y-camY-sh/2-10,bw,5);
      cx.fillStyle=bhp>0.5?'#4caf50':bhp>0.25?'#ff9800':'#f44336';
      cx.fillRect(e.x-camX-bw/2,e.y-camY-sh/2-10,bw*bhp,5);
    }
  });

  // Player
  const ps=SPRITES[G.player.sprite];
  if(ps){
    const psc=3;
    const pw=ps[0].length*psc,ph=ps.length*psc;
    // Walk animation: offset y slightly
    playerWalkTick=(playerWalkTick+1)%12;
    if(playerWalkTick===0) playerWalkFrame=(playerWalkFrame+1)%4;
    const bob=(G.keys.size>0||Math.abs(G.jdx)>0.1||Math.abs(G.jdy)>0.1)?Math.sin(playerWalkFrame*Math.PI)*2:0;
    const flashTint=G.playerFlash>0?'rgba(255,100,100,0.5)':null;
    if(G.playerFlash>0) G.playerFlash--;
    cx.save();
    if(G.playerFlash>0){cx.globalAlpha=0.7+Math.sin(G.playerFlash)*0.3;}
    px(cx,ps,G.px-camX-pw/2,G.py-camY-ph/2+bob,psc);
    cx.restore();
    // Player name tag
    cx.font="7px 'Press Start 2P'";cx.fillStyle='#ffd700';cx.textAlign='center';
    cx.fillText(G.player.name,G.px-camX,G.py-camY-ph/2-5);
  }

  // Flash overlay for combat
  if(G.combatFlash>0){
    cx.fillStyle=`rgba(255,255,255,${G.combatFlash/10})`;
    cx.fillRect(0,0,W,H);
    G.combatFlash--;
  }

  // ‚îÄ‚îÄ Healing Fountains ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const now2=Date.now();
  (G.fountains||[]).forEach(f=>{
    const fx=f.x-camX, fy=f.y-camY;
    const pulse=0.6+Math.sin(now2/500)*0.4;
    const onCooldown=f.cooldown>0;
    // Outer glow ring
    cx.save();
    cx.globalAlpha=onCooldown?0.15:pulse*0.5;
    cx.beginPath();cx.arc(fx,fy,28,0,Math.PI*2);
    cx.fillStyle=f.color;cx.fill();
    cx.restore();
    // Basin
    cx.save();
    cx.fillStyle=onCooldown?'#333':'#1a3a4a';
    cx.beginPath();cx.arc(fx,fy,18,0,Math.PI*2);cx.fill();
    cx.strokeStyle=onCooldown?'#555':f.color;cx.lineWidth=2;cx.stroke();
    cx.restore();
    // Water surface shimmer
    if(!onCooldown){
      cx.save();cx.globalAlpha=pulse;
      cx.fillStyle=f.color;
      cx.beginPath();cx.arc(fx,fy,10,0,Math.PI*2);cx.fill();
      cx.restore();
    }
    // Pillar
    cx.fillStyle=onCooldown?'#444':'#2a5a6a';
    cx.fillRect(fx-4,fy,8,14);
    // Label
    cx.font="11px serif";cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText('üíß',fx,fy-26);
    cx.font="6px 'Press Start 2P'";
    cx.fillStyle=onCooldown?'#555':f.color;cx.textBaseline='alphabetic';
    cx.fillText(onCooldown?'COOLING...':'FOUNTAIN',fx,fy-34);
    // Cooldown arc
    if(onCooldown){
      const arc=(1-f.cooldown/1800)*Math.PI*2;
      cx.save();cx.strokeStyle='#ff9800';cx.lineWidth=3;cx.setLineDash([]);
      cx.beginPath();cx.arc(fx,fy,22,-Math.PI/2,-Math.PI/2+arc);cx.stroke();cx.restore();
    }
  });

  // ‚îÄ‚îÄ Puzzle POI Entrances ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (G.puzzlePoints||[]).forEach(p=>{
    const px2=p.x-camX, py2=p.y-camY;
    const nearPlayer=dst(p.x,p.y,G.px,G.py)<48;
    const pulse2=0.7+Math.sin(now2/400)*0.3;
    if(p.used){
      // Used: greyed out shell
      cx.save();cx.globalAlpha=0.3;
      cx.font="28px serif";cx.textAlign='center';cx.textBaseline='middle';
      cx.fillText(p.icon,px2,py2);cx.restore();
      cx.font="6px 'Press Start 2P'";cx.fillStyle='#444';cx.textAlign='center';cx.textBaseline='alphabetic';
      cx.fillText('EXPLORED',px2,py2+24);
      return;
    }
    // Draw biome-appropriate POI shape
    drawPOI(cx,px2,py2,p.type,pulse2,nearPlayer);
    // Label
    cx.font="6px 'Press Start 2P'";
    cx.fillStyle=nearPlayer?'#ffd700':'#aaa';cx.textAlign='center';cx.textBaseline='alphabetic';
    cx.fillText(p.name.toUpperCase(),px2,py2+36);
  });

  // ‚îÄ‚îÄ Aggro visuals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const now = Date.now();
  const warnBlink = Math.floor(now/100)%2===0;
  const fastBlink = Math.floor(now/60)%2===0;

  G.enemies.forEach(e=>{
    if(e.dead)return;
    const sp=SPRITES[e.etype.sprite];
    if(!sp)return;
    const sc=e.boss?3:2;
    const sw2=sp[0].length*sc, sh=sp.length*sc;
    const ex2=e.x-camX, ey2=e.y-camY;

    // Soft aggro detection ring (faint, only when idle)
    if(!e.boss && G.aggroPhase===null){
      cx.save();
      cx.strokeStyle='rgba(255,200,0,0.10)';
      cx.lineWidth=1; cx.setLineDash([4,4]);
      cx.beginPath(); cx.arc(ex2,ey2,AGGRO_DETECT,0,Math.PI*2); cx.stroke();
      cx.restore();
    }

    // ‚îÄ‚îÄ WARNING phase: big "!" speech bubble above enemy ‚îÄ‚îÄ
    if(G.aggroPhase==='warning' && G.aggroEnemy===e){
      // Pulsing yellow ring around enemy
      cx.save();
      cx.strokeStyle=warnBlink?'rgba(255,220,0,0.9)':'rgba(255,100,0,0.7)';
      cx.lineWidth=3; cx.setLineDash([]);
      cx.beginPath(); cx.arc(ex2,ey2,sw2/2+10,0,Math.PI*2); cx.stroke();
      cx.restore();

      // "!" speech bubble
      const bw=30, bh=34;
      const bx=ex2-bw/2, by=ey2-sh/2-bh-14;
      // Bubble background
      cx.save();
      cx.fillStyle=warnBlink?'#ffdd00':'#ff8800';
      cx.strokeStyle='#000'; cx.lineWidth=2;
      cx.beginPath();
      cx.roundRect?cx.roundRect(bx,by,bw,bh,4):cx.rect(bx,by,bw,bh);
      cx.fill(); cx.stroke();
      // Triangle pointer
      cx.fillStyle=warnBlink?'#ffdd00':'#ff8800';
      cx.beginPath();
      cx.moveTo(ex2-6,by+bh); cx.lineTo(ex2+6,by+bh); cx.lineTo(ex2,by+bh+8);
      cx.fill();
      cx.strokeStyle='#000'; cx.lineWidth=2;
      cx.beginPath();
      cx.moveTo(ex2-6,by+bh); cx.lineTo(ex2,by+bh+8); cx.lineTo(ex2+6,by+bh);
      cx.stroke();
      // "!" text
      cx.fillStyle='#000';
      cx.font="bold 20px 'Press Start 2P',monospace";
      cx.textAlign='center'; cx.textBaseline='middle';
      cx.fillText('!',ex2,by+bh/2);
      cx.restore();
    }

    // ‚îÄ‚îÄ CHARGING phase: motion trail + red outline ‚îÄ‚îÄ
    if(G.aggroPhase==='charging' && G.aggroEnemy===e){
      const ddx=G.px-e.x, ddy=G.py-e.y;
      const dlen=Math.hypot(ddx,ddy)||1;
      // Motion trail (3 fading copies behind)
      for(let t=1;t<=3;t++){
        cx.save();
        cx.globalAlpha=0.15*t;
        px(cx,sp,ex2-sw2/2-(ddx/dlen*10*t),ey2-sh/2-(ddy/dlen*10*t),sc);
        cx.restore();
      }
      // Angry red outline
      cx.save();
      cx.strokeStyle=fastBlink?'#ff2200':'#ff9900';
      cx.lineWidth=3; cx.setLineDash([]);
      cx.strokeRect(ex2-sw2/2-3,ey2-sh/2-3,sw2+6,sh+6);
      cx.restore();
      // Rage "!!" above enemy
      cx.save();
      cx.fillStyle=fastBlink?'#ff2200':'#ff6600';
      cx.font="bold 14px 'Press Start 2P',monospace";
      cx.textAlign='center'; cx.textBaseline='alphabetic';
      cx.fillText('!!',ex2,ey2-sh/2-6);
      cx.restore();
    }
  });

  // ‚îÄ‚îÄ FROZEN player: vignette + status text ‚îÄ‚îÄ
  if(G.frozen){
    // Dark edge vignette
    const vg=cx.createRadialGradient(W/2,H/2,H*0.25,W/2,H/2,H*0.85);
    vg.addColorStop(0,'rgba(0,0,0,0)');
    vg.addColorStop(1,G.aggroPhase==='charging'?'rgba(180,20,0,0.45)':'rgba(0,0,0,0.45)');
    cx.fillStyle=vg; cx.fillRect(0,0,W,H);

    // Red border flash during charging
    if(G.aggroPhase==='charging' && fastBlink){
      cx.save();
      cx.strokeStyle='rgba(255,40,0,0.7)'; cx.lineWidth=8;
      cx.strokeRect(4,4,W-8,H-8);
      cx.restore();
    }

    // Status banner at bottom
    cx.save();
    cx.fillStyle='rgba(0,0,0,0.65)';
    cx.fillRect(0,H-44,W,44);
    if(G.aggroPhase==='warning'){
      cx.font="10px 'Press Start 2P',monospace";
      cx.fillStyle=warnBlink?'#ffdd00':'#ff8800';
      cx.textAlign='center'; cx.textBaseline='middle';
      cx.fillText('! ENEMY SPOTTED ‚Äî BRACE YOURSELF !', W/2, H-22);
    } else if(G.aggroPhase==='charging'){
      cx.font="10px 'Press Start 2P',monospace";
      cx.fillStyle=fastBlink?'#ff2200':'#ff9900';
      cx.textAlign='center'; cx.textBaseline='middle';
      cx.fillText('‚ö° INCOMING CHARGE ‚Äî CANNOT MOVE ‚ö°', W/2, H-22);
    }
    cx.restore();
  }

  // ‚îÄ‚îÄ Boss lock flash: red warning when player touches locked boss ‚îÄ‚îÄ
  if(G.bossLockFlash>0){
    G.bossLockFlash--;
    const p=G.bossLockFlash/90;
    cx.save();
    cx.fillStyle=`rgba(180,0,0,${p*0.35})`;cx.fillRect(0,0,W,H);
    cx.strokeStyle=`rgba(255,60,0,${p*0.9})`;cx.lineWidth=6;cx.strokeRect(3,3,W-6,H-6);
    cx.fillStyle=`rgba(255,80,0,${Math.min(1,p*2)})`;
    cx.font="11px 'Press Start 2P',monospace";cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText('üîí DEFEAT THE GUARDIAN FIRST!',W/2,H/2);
    cx.restore();
  }

  // ‚îÄ‚îÄ Boss unlock banner ‚îÄ‚îÄ
  if(G.bossUnlockFlash>0){
    G.bossUnlockFlash--;
    const p=Math.min(1,G.bossUnlockFlash/30);
    const blink=Math.floor(Date.now()/200)%2===0;
    cx.save();
    cx.fillStyle=`rgba(0,0,0,${p*0.6})`;cx.fillRect(0,H/2-40,W,80);
    cx.strokeStyle=`rgba(255,215,0,${p*0.9})`;cx.lineWidth=3;
    cx.strokeRect(0,H/2-40,W,80);
    cx.font="12px 'Press Start 2P',monospace";
    cx.fillStyle=blink?`rgba(255,215,0,${p})`:`rgba(255,255,100,${p})`;
    cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText('üîì GUARDIAN DEFEATED! BOSS UNLOCKED!',W/2,H/2);
    cx.restore();
  }

  // Minimap
  const mmW=parseInt(document.getElementById('minimap').style.width)||120;
  const mmH=parseInt(document.getElementById('minimap').style.height)||70;
  mx.fillStyle='rgba(0,0,0,.85)';mx.fillRect(0,0,mmW,mmH);
  const mmx2=v=>v/WW*mmW,mmy2=v=>v/WH*mmH;
  mx.fillStyle='#2d6a1e';mx.fillRect(mmx2(400)-4,mmy2(300)-4,8,8);
  G.enemies.forEach(e=>{
    if(e.dead)return;
    mx.fillStyle=e.boss?(e.locked?'#554400':'#ff4444'):e.unique?'#ffd700':e.gatekeeper?'#ff9800':BIOMES[G.biomeIdx].eColor;
    const sz=e.boss?5:e.unique?4:3;
    mx.fillRect(mmx2(e.x)-sz/2,mmy2(e.y)-sz/2,sz,sz);
  });
  // Fountains on minimap
  (G.fountains||[]).forEach(f=>{
    mx.fillStyle=f.cooldown>0?'#336655':'#44ffcc';
    mx.beginPath();mx.arc(mmx2(f.x),mmy2(f.y),3,0,Math.PI*2);mx.fill();
  });
  // Puzzle POIs on minimap
  (G.puzzlePoints||[]).forEach(p=>{
    mx.fillStyle=p.used?'#333':'#ffd700';
    mx.fillRect(mmx2(p.x)-2,mmy2(p.y)-2,4,4);
  });
  mx.fillStyle='#ffd700';mx.fillRect(mmx2(G.px)-3,mmy2(G.py)-3,6,6);
}

function updateHUD(){
  if(!G.player)return;
  const b=BIOMES[G.biomeIdx];
  const p=G.player;
  document.getElementById('hud-name').textContent=p.name;
  const hp=Math.max(0,p.hp/p.maxHp*100);
  const hb=document.getElementById('hud-hp');
  hb.style.width=hp+'%';hb.style.background=hp>50?'#4caf50':hp>25?'#ff9800':'#f44336';
  document.getElementById('hud-level').textContent=`Lv.${p.level||1}`;
  document.getElementById('hud-biome').textContent=`${b.emoji} ${b.name}`;
  const bossReady=G.uniqueKilled;
  document.getElementById('hud-bosses').textContent=`üëë ${G.defeated.size}/4 ${bossReady?'üîì':'üîí'}`;
  const gkAlive=G.enemies?G.enemies.filter(e=>e.gatekeeper&&!e.dead).length:G.gatekeepersNeeded;
  const gkDone=G.gatekeepersNeeded-gkAlive;
  const gkEl=document.getElementById('hud-sentinels');
  if(gkEl){gkEl.textContent=`‚öîÔ∏è ${gkDone}/${G.gatekeepersNeeded}`;gkEl.style.color=gkAlive===0?'#4caf50':'#ff9800';}
  document.getElementById('hud-heal').style.display=G.inTown?'block':'none';
  // XP bar
  const lv=p.level||1;
  const xpPct=lv>=MAX_LEVEL?100:((p.xp||0)/xpForLevel(lv)*100);
  document.getElementById('xpbar').style.width=Math.min(100,xpPct)+'%';
}

// ================================================================
// GAME LOOP
// ================================================================
function startLoop(){stopLoop();function loop(){if(G.screen!=='explore'){G.loopId=null;return;}tick();drawWorld();updateHUD();G.loopId=requestAnimationFrame(loop);}G.loopId=requestAnimationFrame(loop);}
function stopLoop(){if(G.loopId){cancelAnimationFrame(G.loopId);G.loopId=null;}}

function tick(){
  // ‚îÄ‚îÄ Aggro state machine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(G.aggroPhase==='warning'){
    G.aggroTimer--;
    // Player is frozen during warning
    G.frozen=true;
    if(G.aggroTimer<=0){
      // Switch to charging
      G.aggroPhase='charging';
      G.aggroTimer=120; // max frames to reach player before giving up
    }
    // Move all non-aggro enemies normally (but not the aggro one)
    tickIdleEnemies();
    return; // skip player movement & normal enemy loop below
  }

  if(G.aggroPhase==='charging'){
    G.frozen=true;
    const e=G.aggroEnemy;
    if(!e||e.dead){resetAggro();return;}
    G.aggroTimer--;
    // Charge toward player ‚Äî respects solid tiles (trees block the charge)
    const ddx=G.px-e.x, ddy=G.py-e.y;
    const dlen=Math.hypot(ddx,ddy)||1;
    const cspd = e.boss ? CHARGE_SPD*1.3 : CHARGE_SPD;
    const nx2 = e.x + ddx/dlen*cspd;
    const ny2 = e.y + ddy/dlen*cspd;
    // Try to move; if blocked by a tree, give up the charge
    const blockedX = isSolid(nx2, e.y);
    const blockedY = isSolid(e.x, ny2);
    if(blockedX && blockedY){
      // Fully blocked by a tree ‚Äî abort charge, enemy loses the player
      resetAggro();
      tickIdleEnemies();
      return;
    }
    if(!blockedX) e.x=nx2;
    if(!blockedY) e.y=ny2;
    // Hit!
    if(dst(e.x,e.y,G.px,G.py)<28){
      resetAggro();
      beginCombat(e);
      return;
    }
    // Gave up (timer expired)
    if(G.aggroTimer<=0) resetAggro();
    tickIdleEnemies();
    return;
  }

  // ‚îÄ‚îÄ Normal movement (no aggro active) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  G.frozen=false;

  // Update inTown FIRST so aggro check below uses current frame value
  G.inTown = dst(G.px,G.py,TOWN_X,TOWN_Y) < TOWN_SAFE;
  if(G.inTown && G.player.hp<G.player.maxHp)
    G.player.hp=Math.min(G.player.maxHp,G.player.hp+0.2);

  let dx=0,dy=0;
  if(!G.frozen){
    if(G.keys.has('w')||G.keys.has('arrowup'))dy-=1;
    if(G.keys.has('s')||G.keys.has('arrowdown'))dy+=1;
    if(G.keys.has('a')||G.keys.has('arrowleft'))dx-=1;
    if(G.keys.has('d')||G.keys.has('arrowright'))dx+=1;
    dx+=G.jdx;dy+=G.jdy;
    const len=Math.hypot(dx,dy);
    if(len>0){dx=dx/len*SPD;dy=dy/len*SPD;}
    const nx=clamp(G.px+dx,20,WW-20);
    const ny=clamp(G.py+dy,20,WH-20);
    if(!isSolid(nx,G.py)) G.px=nx;
    if(!isSolid(G.px,ny)) G.py=ny;
    // Footstep SFX when actually moving
    if(dx!==0||dy!==0){
      _footstepTick++;
      if(_footstepTick>=18){_footstepTick=0;AudioEngine.sfxFootstep();}
    } else { _footstepTick=0; }
  }

  for(const e of G.enemies){
    if(e.dead)continue;
    // Aggro: skip if player is in town OR a tree blocks line-of-sight
    const d=dst(e.x,e.y,G.px,G.py);
    const aggroRange = e.boss ? AGGRO_DETECT*1.4 : e.gatekeeper ? AGGRO_DETECT*0.9 : AGGRO_DETECT;
    // Block unique aggro if sentinels are still alive
    if(e.unique && !G.uniqueKilled){
      const gkAlive=G.enemies.filter(en=>en.gatekeeper&&!en.dead).length;
      if(gkAlive>0 && d<100 && !G.inTown){showGatekeeperDialogue(gkAlive);return;}
    }
    if(d<aggroRange && !G.inTown && G.aggroPhase===null && !(e.boss && e.locked) && hasLOS(e.x,e.y,G.px,G.py)){
      G.aggroEnemy=e;
      G.aggroPhase='warning';
      G.aggroTimer=AGGRO_WARN;
      G.frozen=true;
      AudioEngine.sfxEncounter();
      return;
    }
    // Standing enemies (sentinels) don't roam
    if(e.standing){continue;}
    // Normal wander ‚Äî enemies bounce off solid tiles and stay out of town
    const enx=e.x+e.dx, eny=e.y+e.dy;
    if(!isSolid(enx,e.y)&&enx>60&&enx<WW-60) e.x=enx; else e.dx*=-1;
    if(!isSolid(e.x,eny)&&eny>60&&eny<WH-60) e.y=eny; else e.dy*=-1;
    // Keep enemies out of town radius
    if(dst(e.x,e.y,TOWN_X,TOWN_Y)<TOWN_SAFE+20){e.dx*=-1;e.dy*=-1;}
    // Don't start combat if player is safely inside town or boss is locked
    if(d<28 && !G.inTown && !(e.boss && e.locked)){beginCombat(e);return;}
    // Show locked boss dialogue when player gets close
    if(e.boss && e.locked && d<80 && !G.inTown){showBossLockedDialogue(e);return;}
  }

  // ‚îÄ‚îÄ Healing Fountain proximity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  G.nearPuzzle=null;
  let nearAnyFountain=false;
  (G.fountains||[]).forEach(f=>{
    if(f.cooldown>0){f.cooldown--;return;}
    if(dst(f.x,f.y,G.px,G.py)<42 && !G.inTown){
      const healAmt=Math.round(G.player.maxHp*0.25);
      if(G.player.hp<G.player.maxHp){
        G.player.hp=Math.min(G.player.maxHp,G.player.hp+healAmt);
        f.cooldown=1800;
        showFountainMsg(`üíß +${healAmt} HP restored!`);
        nearAnyFountain=true;
      }
    }
  });

  // ‚îÄ‚îÄ Puzzle POI proximity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let nearAnyPuzzle=false;
  (G.puzzlePoints||[]).forEach(p=>{
    if(p.used)return;
    if(dst(p.x,p.y,G.px,G.py)<45){
      G.nearPuzzle=p;
      nearAnyPuzzle=true;
    }
  });
  const ep=document.getElementById('enter-prompt');
  if(ep) ep.style.display=nearAnyPuzzle?'block':'none';
}

function tickIdleEnemies(){
  for(const e of G.enemies){
    if(e.dead||e===G.aggroEnemy||e.standing)continue;
    const enx=e.x+e.dx,eny=e.y+e.dy;
    if(!isSolid(enx,e.y)&&enx>60&&enx<WW-60) e.x=enx; else e.dx*=-1;
    if(!isSolid(e.x,eny)&&eny>60&&eny<WH-60) e.y=eny; else e.dy*=-1;
    if(dst(e.x,e.y,TOWN_X,TOWN_Y)<TOWN_SAFE+20){e.dx*=-1;e.dy*=-1;}
  }
}

function resetAggro(){
  G.aggroPhase=null;
  G.aggroEnemy=null;
  G.aggroTimer=0;
  G.frozen=false;
}

// ================================================================
// BOSS LOCKED DIALOGUE
// ================================================================
function showBossLockedDialogue(bossEnemy){
  if(G._bossDialogueShown) return; // already open, don't re-trigger
  G._bossDialogueShown = true;
  stopLoop();
  const b = BIOMES[G.biomeIdx];
  const ug = b.enemies.find(e => e.unique);
  const guardianName = ug ? ug.name : 'the Guardian';
  const bossName = b.boss.name;

  document.getElementById('bld-title').textContent = `${bossName} ‚Äî SEALED`;
  document.getElementById('bld-body').textContent =
    `A powerful seal prevents you from challenging ${bossName}.`;
  document.getElementById('bld-hint').innerHTML =
    `üîë You must defeat the <span style="color:#ffd700">Guardian: ${guardianName}</span><br>` +
    `before this boss will engage in battle!`;
  const dlg = document.getElementById('boss-locked-dialogue');
  dlg.style.display = 'flex';
}

function closeBossLockedDialogue(){
  G._bossDialogueShown = false;
  document.getElementById('boss-locked-dialogue').style.display = 'none';
  // Push player slightly away from the boss to avoid immediately re-triggering
  const boss = G.enemies.find(e => e.boss && e.locked && !e.dead);
  if(boss){
    const ddx = G.px - boss.x, ddy = G.py - boss.y;
    const dlen = Math.hypot(ddx, ddy) || 1;
    G.px = clamp(boss.x + ddx/dlen * 110, 20, WW-20);
    G.py = clamp(boss.y + ddy/dlen * 110, 20, WH-20);
  }
  show('explore');
  startLoop();
}

// ================================================================
// GATEKEEPER DIALOGUE
// ================================================================
function showGatekeeperDialogue(gkAlive){
  if(G._gkDialogueShown)return;
  G._gkDialogueShown=true;
  stopLoop();
  const b=BIOMES[G.biomeIdx];
  const ug=b.enemies.find(e=>e.unique);
  const guardianName=ug?ug.name:'the Guardian';
  document.getElementById('gkd-title').textContent=`${guardianName} ‚Äî SEALED`;
  document.getElementById('gkd-body').textContent=
    `${guardianName} refuses to be challenged while its Sentinels stand guard.`;
  document.getElementById('gkd-hint').innerHTML=
    `‚öîÔ∏è You must defeat <span style="color:#ff9800">${gkAlive} Sentinel${gkAlive>1?'s':''}</span> first!<br>`+
    `<span style="color:#aaa">Look for the ‚öîÔ∏è standing enemies on the map.</span>`;
  document.getElementById('gatekeeper-dialogue').style.display='flex';
}
function closeGatekeeperDialogue(){
  G._gkDialogueShown=false;
  document.getElementById('gatekeeper-dialogue').style.display='none';
  // Push player back from unique
  const ug=G.enemies.find(e=>e.unique&&!e.dead);
  if(ug){
    const ddx=G.px-ug.x,ddy=G.py-ug.y;
    const dlen=Math.hypot(ddx,ddy)||1;
    G.px=clamp(ug.x+ddx/dlen*120,20,WW-20);
    G.py=clamp(ug.y+ddy/dlen*120,20,WH-20);
  }
  show('explore');startLoop();
}

// Fountain heal flash message
function showFountainMsg(msg){
  const el=document.getElementById('fountain-msg');
  if(!el)return;
  el.textContent=msg;el.style.display='block';
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.style.display='none',2000);
}

// ================================================================
// PUZZLE POI SYSTEM
// ================================================================
const PUZZLE_REWARDS=[
  {id:'herb',       chance:0.9},
  {id:'scroll_minor',chance:0.7},
  {id:'focus_stone',chance:0.35},
  {id:'iron_veil',  chance:0.3},
  {id:'lucky_charm',chance:0.25},
  {id:'tome_knowledge',chance:0.12},
  {id:'potion_full',chance:0.08},
];

const CIPHER_QS=[
  {q:"I speak without a mouth and hear without ears. I have no body, but I come alive with wind. What am I?",o:["Shadow","Echo","Smoke","Mirror"],a:1},
  {q:"The more you take, the more you leave behind. What am I?",o:["Memories","Footsteps","Water","Time"],a:1},
  {q:"I have cities, but no houses live there. I have mountains, but no trees grow. I have water, but no fish swim. What am I?",o:["Desert","Map","Sky","Dream"],a:1},
  {q:"What gets wetter the more it dries?",o:["Rain","A towel","Ice","A sponge"],a:1},
  {q:"I have hands but cannot clap. What am I?",o:["Statue","Clock","Glove","Robot"],a:1},
  {q:"What has a head, a tail, but no body?",o:["Snake","Coin","Arrow","River"],a:1},
  {q:"The more you remove from me, the bigger I become. What am I?",o:["Cloud","Hole","Shadow","Balloon"],a:1},
  {q:"I travel the world but stay in one corner. What am I?",o:["Compass","Stamp","Star","Moon"],a:1},
  {q:"What can run but never walks, has a mouth but never talks?",o:["Wind","River","Fire","Time"],a:1},
  {q:"I have branches but no fruit, trunk, or leaves. What am I?",o:["River","Bank","Road","Bridge"],a:1},
];

let _puzState={};
let _puzTimer=null;

function openPuzzle(){
  if(!G.nearPuzzle||G.nearPuzzle.used)return;
  stopLoop();
  document.getElementById('enter-prompt').style.display='none';
  const p=G.nearPuzzle;
  const types=['math','memory','cipher'];
  const ptype=types[Math.floor(Math.random()*types.length)];
  _puzState={poi:p,type:ptype,score:0,done:false};

  document.getElementById('puz-poi-icon').textContent=p.icon;
  document.getElementById('puz-reward-panel').style.display='none';
  document.getElementById('puz-fail-panel').style.display='none';
  document.getElementById('puz-skip').style.display='block';
  document.getElementById('puz-math').style.display='none';
  document.getElementById('puz-memory').style.display='none';
  document.getElementById('puz-cipher').style.display='none';
  document.getElementById('puz-timer-fill').style.width='100%';
  document.getElementById('puz-timer-fill').style.background='#4caf50';

  if(ptype==='math'){
    document.getElementById('puz-title').textContent=`‚ö° MATH BLITZ`;
    document.getElementById('puz-subtitle').textContent=`${p.name} ‚Äî Solve 3 quick sums!`;
    document.getElementById('puz-math').style.display='block';
    startMathPuzzle();
  } else if(ptype==='memory'){
    document.getElementById('puz-title').textContent=`üß† MEMORY GRID`;
    document.getElementById('puz-subtitle').textContent=`${p.name} ‚Äî Remember the pattern!`;
    document.getElementById('puz-memory').style.display='block';
    startMemoryPuzzle();
  } else {
    document.getElementById('puz-title').textContent=`üîÆ WORD CIPHER`;
    document.getElementById('puz-subtitle').textContent=`${p.name} ‚Äî Solve the riddle!`;
    document.getElementById('puz-cipher').style.display='block';
    startCipherPuzzle();
  }
  document.getElementById('puzzle-overlay').style.display='flex';
}

function closePuzzle(won){
  stopPuzTimer();
  document.getElementById('puzzle-overlay').style.display='none';
  document.getElementById('enter-prompt').style.display='none';
  if(won && _puzState.poi){
    _puzState.poi.used=true;
    // Roll rewards
    const drops=[];
    PUZZLE_REWARDS.forEach(r=>{if(Math.random()<r.chance)drops.push(r.id);});
    const reward=drops[Math.floor(Math.random()*drops.length)]||'herb';
    const item=ITEMS.find(i=>i.id===reward);
    if(item){
      if(!G.player.inventory)G.player.inventory=[];
      G.player.inventory.push(reward);
      showItemDrop(`${item.icon} Found: ${item.name}!`,3000);
    }
  } else if(_puzState.poi){
    _puzState.poi.cooldown=300; // 5-second retry cooldown
    setTimeout(()=>{if(_puzState.poi)_puzState.poi.cooldown=0;},5000);
  }
  _puzState={};
  show('explore');startLoop();
}

function stopPuzTimer(){clearInterval(_puzTimer);_puzTimer=null;}

// ‚îÄ‚îÄ Math Blitz ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _mathQ=0,_mathScore=0;
function startMathPuzzle(){
  _mathQ=0;_mathScore=0;
  showMathQuestion();
  startPuzTimer(18);
}
function showMathQuestion(){
  if(_mathQ>=3){endMathPuzzle();return;}
  document.getElementById('puz-math-progress').textContent=`Q ${_mathQ+1}/3`;
  const ops=['+','-','√ó'];
  const op=ops[Math.floor(Math.random()*ops.length)];
  let a=Math.floor(Math.random()*12)+2;
  let b=Math.floor(Math.random()*12)+2;
  let ans;
  if(op==='+')ans=a+b;
  else if(op==='-'){ans=a-b;if(ans<0){b=Math.floor(Math.random()*a);ans=a-b;}}
  else{a=Math.floor(Math.random()*9)+2;b=Math.floor(Math.random()*9)+2;ans=a*b;}
  document.getElementById('puz-math-q').textContent=`${a} ${op} ${b} = ?`;
  const opts=document.getElementById('puz-math-opts');
  opts.innerHTML='';
  document.getElementById('puz-math-result').textContent='';
  // Generate 4 options
  const choices=new Set([ans]);
  while(choices.size<4){choices.add(ans+Math.floor(Math.random()*10)-5);}
  const arr=Array.from(choices).sort(()=>Math.random()-.5);
  arr.forEach(v=>{
    const b2=document.createElement('button');
    b2.className='puz-choice';b2.textContent=v;
    b2.onclick=()=>checkMathAnswer(v,ans,b2,arr,opts);
    opts.appendChild(b2);
  });
}
function checkMathAnswer(val,correct,btn,arr,opts){
  opts.querySelectorAll('.puz-choice').forEach(b2=>b2.disabled=true);
  if(val===correct){btn.classList.add('correct');_mathScore++;document.getElementById('puz-math-result').style.color='#4caf50';document.getElementById('puz-math-result').textContent='‚úÖ Correct!';}
  else{btn.classList.add('wrong');opts.querySelectorAll('.puz-choice').forEach((b2,i)=>{if(parseInt(b2.textContent)===correct)b2.classList.add('correct');});document.getElementById('puz-math-result').style.color='#f44336';document.getElementById('puz-math-result').textContent='‚ùå Wrong!';}
  _mathQ++;setTimeout(showMathQuestion,900);
}
function endMathPuzzle(){
  stopPuzTimer();
  if(_mathScore>=2)showPuzReward(`‚úÖ ${_mathScore}/3 correct! Puzzle solved!`);
  else showPuzFail(`‚ùå Only ${_mathScore}/3 correct. Need 2 to pass.`);
}

// ‚îÄ‚îÄ Memory Grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _memTarget=[],_memSelected=[];
const MEM_EMOJIS=['üî•','üíß','üåø','‚ö°','‚ùÑÔ∏è','üåô','‚òÄÔ∏è','üíÄ','üîÆ'];
function startMemoryPuzzle(){
  const grid=document.getElementById('puz-mem-grid');
  grid.innerHTML='';
  _memTarget=[];_memSelected=[];
  const count=3+G.biomeIdx; // 3-6 tiles to remember based on biome difficulty
  const allIdx=[0,1,2,3,4,5,6,7,8];
  while(_memTarget.length<Math.min(count,4)){
    const r=allIdx.splice(Math.floor(Math.random()*allIdx.length),1)[0];
    _memTarget.push(r);
  }
  const cellEmojis=MEM_EMOJIS.slice(0,9);
  for(let i=0;i<9;i++){
    const c=document.createElement('div');
    c.className='puz-cell';c.dataset.idx=i;
    c.style.background='#1a1a2e';
    c.style.fontSize='22px';
    c.textContent='';
    c.onclick=()=>memCellClick(i,c);
    grid.appendChild(c);
  }
  document.getElementById('puz-mem-msg').textContent='WATCH THE PATTERN';
  document.getElementById('puz-mem-result').textContent='';
  // Flash pattern
  setTimeout(()=>flashMemPattern(cellEmojis),400);
}
function flashMemPattern(emojis){
  const cells=document.querySelectorAll('#puz-mem-grid .puz-cell');
  // Show pattern
  cells.forEach((c,i)=>{
    if(_memTarget.includes(i)){c.classList.add('lit');c.textContent=emojis[i];}
  });
  setTimeout(()=>{
    cells.forEach(c=>{c.classList.remove('lit');c.textContent='';c.style.background='#1a1a2e';});
    document.getElementById('puz-mem-msg').textContent='NOW CLICK THE PATTERN!';
    startPuzTimer(10);
  },1800);
}
function memCellClick(idx,cell){
  if(_memSelected.includes(idx))return;
  _memSelected.push(idx);
  cell.style.background='#2a2a6e';cell.textContent='?';
  if(_memSelected.length===_memTarget.length){
    stopPuzTimer();
    const correct=_memTarget.every(i=>_memSelected.includes(i));
    const cells=document.querySelectorAll('#puz-mem-grid .puz-cell');
    cells.forEach((c,i)=>{
      if(_memTarget.includes(i)){c.classList.add(correct?'correct':'wrong');c.textContent=MEM_EMOJIS[i];}
      else if(_memSelected.includes(i)&&!_memTarget.includes(i)){c.classList.add('wrong');}
    });
    setTimeout(()=>{
      if(correct)showPuzReward('üß† Perfect recall! Puzzle solved!');
      else showPuzFail('‚ùå Wrong pattern. Try again later.');
    },800);
  }
}

// ‚îÄ‚îÄ Word Cipher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startCipherPuzzle(){
  const q=CIPHER_QS[Math.floor(Math.random()*CIPHER_QS.length)];
  document.getElementById('puz-cipher-q').textContent=q.q;
  const opts=document.getElementById('puz-cipher-opts');
  opts.innerHTML='';
  document.getElementById('puz-cipher-result').textContent='';
  // Shuffle options
  const order=[0,1,2,3].sort(()=>Math.random()-.5);
  const correctInOrder=order.indexOf(q.a);
  order.forEach((origIdx,newIdx)=>{
    const b=document.createElement('button');
    b.className='puz-choice';
    b.textContent=`${['A','B','C','D'][newIdx]}. ${q.o[origIdx]}`;
    b.onclick=()=>{
      opts.querySelectorAll('.puz-choice').forEach(x=>x.disabled=true);
      const isCorrect=origIdx===q.a;
      if(isCorrect){b.classList.add('correct');stopPuzTimer();setTimeout(()=>showPuzReward('üîÆ Riddle solved! Puzzle complete!'),600);}
      else{b.classList.add('wrong');opts.querySelectorAll('.puz-choice').forEach((x,ni)=>{if(order[ni]===q.a)x.classList.add('correct');});document.getElementById('puz-cipher-result').style.color='#f44336';document.getElementById('puz-cipher-result').textContent='‚ùå Wrong answer.';stopPuzTimer();setTimeout(()=>showPuzFail('Better luck next time...'),800);}
    };
    opts.appendChild(b);
  });
  startPuzTimer(20);
}

// ‚îÄ‚îÄ Shared puzzle helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startPuzTimer(seconds){
  stopPuzTimer();
  let t=seconds;
  const fill=document.getElementById('puz-timer-fill');
  _puzTimer=setInterval(()=>{
    t--;
    const pct=t/seconds*100;
    fill.style.width=pct+'%';
    fill.style.background=pct>50?'#4caf50':pct>25?'#ff9800':'#f44336';
    if(t<=0){stopPuzTimer();puzTimeOut();}
  },1000);
}
function puzTimeOut(){
  if(_puzState.type==='math')endMathPuzzle();
  else if(_puzState.type==='memory')showPuzFail('‚è∞ Time\'s up!');
  else showPuzFail('‚è∞ Time\'s up!');
}
function showPuzReward(msg){
  _puzState.done=true;
  document.getElementById('puz-math').style.display='none';
  document.getElementById('puz-memory').style.display='none';
  document.getElementById('puz-cipher').style.display='none';
  document.getElementById('puz-skip').style.display='none';
  const panel=document.getElementById('puz-reward-panel');
  document.getElementById('puz-reward-text').textContent=msg+'\n\nYou earned a reward!';
  panel.style.display='block';
}
function showPuzFail(msg){
  _puzState.done=true;
  document.getElementById('puz-math').style.display='none';
  document.getElementById('puz-memory').style.display='none';
  document.getElementById('puz-cipher').style.display='none';
  document.getElementById('puz-skip').style.display='none';
  document.getElementById('puz-fail-panel').style.display='block';
  document.getElementById('puz-fail-panel').querySelector('div').textContent=msg;
}

// ================================================================
// INTRO (updated with sentinel hint)
// ================================================================
function showIntro(){
  const b=BIOMES[G.biomeIdx];
  // Draw boss sprite in intro
  const isc=document.getElementById('intro-sprite');
  drawToCanvas(isc,b.boss.sprite,'transparent',5);
  document.getElementById('intro-name').textContent=b.name+' Biome';
  document.getElementById('intro-name').style.color=b.eColor;
  document.getElementById('intro-desc').textContent=b.desc;
  const etypes=b.enemies.filter(e=>!e.unique).map(e=>e.name).join(', ');
  const ug=b.enemies.find(e=>e.unique);
  document.getElementById('intro-tip').innerHTML=
    `Enemies: <strong style="color:${b.eColor}">${etypes}</strong><br>`+
    `<span style="color:#ff9800">‚öîÔ∏è Sentinels must be defeated before challenging the Guardian</span><br>`+
    (ug?`<span style="color:#ffd700">üîë Guardian: <strong>${ug.name}</strong> ‚Äî defeat to unlock boss</span><br>`:'') +
    `Boss: <strong style="color:#ff4444">${b.boss.name}</strong><br>`+
    `<span style="color:#44ffcc">üíß Healing Fountains restore 25% HP</span><br>`+
    `<span style="color:#ffd700">üîÆ Explore caves & shrines for puzzle rewards</span><br><br>Town (green ring) heals you`;
  document.getElementById('intro-go').style.color=b.eColor;
  document.getElementById('intro-go').style.borderColor=b.eColor;
  document.getElementById('intro-overlay').style.display='flex';
}
document.getElementById('intro-go').onclick=()=>{document.getElementById('intro-overlay').style.display='none';startLoop();};

// ================================================================
// KEYBOARD
// ================================================================
window.addEventListener('keydown',e=>{
  G.keys.add(e.key.toLowerCase());
  if(e.key==='Escape'){
    if(G.screen==='explore')doPause();
    else if(G.screen==='paused')doResume();
    else if(G.screen==='inventory'){show('explore');startLoop();}
  }
  if((e.key==='i'||e.key==='I')&&G.screen==='explore'){showInventory();}
  // E key to enter puzzle POI
  if((e.key==='e'||e.key==='E')&&G.screen==='explore'&&G.nearPuzzle){openPuzzle();}
});
window.addEventListener('keyup',e=>G.keys.delete(e.key.toLowerCase()));

// ================================================================
// PAUSE
// ================================================================
document.getElementById('hud-pause-btn').onclick=doPause;
document.getElementById('pause-explore-btn').onclick=doPause;
document.getElementById('btn-resume').onclick=doResume;
document.getElementById('btn-to-menu').onclick=()=>{stopLoop();show('menu');};
function doPause(){stopLoop();const b=BIOMES[G.biomeIdx];document.getElementById('p-biome').textContent=`${b.emoji} ${b.name} Biome`;document.getElementById('p-stats').textContent=`HP: ${Math.round(G.player.hp)}/${G.player.maxHp}  |  Bosses: ${G.defeated.size}/4`;show('paused');}
function doResume(){show('explore');layoutUI();startLoop();}

// ================================================================
// COMBAT
// ================================================================
function beginCombat(enemy){
  // Block if boss is still locked
  if(enemy.boss && enemy.locked){
    // Show a brief "locked" flash on canvas ‚Äî handled in drawWorld
    G.bossLockFlash=90;
    return;
  }
  stopLoop();
  // Freeze enemy positions ‚Äî snapshot every living enemy's position
  // so we can restore them after combat ends (prevents swarm ambushes)
  G._enemySnapshot = G.enemies
    .filter(e => !e.dead && e.id !== enemy.id)
    .map(e => ({id: e.id, x: e.x, y: e.y, dx: e.dx, dy: e.dy}));
  const b=BIOMES[G.biomeIdx];
  G.eid=enemy.id;G.eBoss=enemy.boss;G.eUnique=!!enemy.unique;
  G.eHp=enemy.hp;G.eMaxHp=enemy.maxHp;
  G.cEnemyType=enemy.etype;
  G.cAnswered=false;G.cAction=null;

  document.getElementById('combat').style.background=`linear-gradient(180deg,${b.bg},#050505)`;
  let titleTxt = enemy.boss ? `üëë BOSS: ${b.boss.name}`
                : enemy.unique ? `‚ö†Ô∏è GUARDIAN: ${enemy.etype.name}`
                : `‚öîÔ∏è ${enemy.etype.name}`;
  document.getElementById('c-title').textContent=titleTxt;
  document.getElementById('c-title').style.color=enemy.boss?'#ff4444':enemy.unique?'#ffd700':b.eColor;
  document.getElementById('c-biome').textContent=`${b.emoji} ${b.name}`;
  document.getElementById('boss-tag').style.display=enemy.boss?'block':enemy.unique?'block':'none';
  document.getElementById('boss-tag').textContent=enemy.boss?'‚ö†Ô∏è BOSS BATTLE':'üîë GUARDIAN ‚Äî Defeat to unlock Boss!';
  document.getElementById('boss-tag').style.color=enemy.boss?'#ff4444':'#ffd700';
  document.getElementById('c-enemy-box').style.borderColor=enemy.boss?'#ff4444':enemy.unique?'#ffd700':'#555';
  document.getElementById('c-enemy-box').style.boxShadow=enemy.boss?'0 0 20px rgba(255,68,68,.4)':enemy.unique?'0 0 20px rgba(255,215,0,.4)':'none';

  const esc=document.getElementById('c-enemy-canvas');
  drawToCanvas(esc,enemy.etype.sprite,b.bg,enemy.boss?5:enemy.unique?5:4,true);
  const psc=document.getElementById('c-player-canvas');
  drawToCanvas(psc,G.player.sprite,'#0a0a0a',4);
  drawToCanvas(document.getElementById('go-canvas'),G.player.sprite,'transparent',5);

  const log=document.getElementById('c-log');log.innerHTML='';
  if(enemy.unique) addLog(`üîë Guardian ${enemy.etype.name} blocks the boss!`,'#ffd700');
  else addLog(`‚öîÔ∏è Wild ${enemy.etype.name} appeared!`,'#ddd');

  refreshBars();setActions(true);
  document.getElementById('q-panel').style.display='none';
  show('combat');
  // Play battle music
  if(enemy.boss || enemy.unique) AudioEngine.playBoss();
  else AudioEngine.playBattle();
}

// Restore enemy positions from the pre-combat snapshot so they
// don't swarm the player while the battle screen was open.
function restoreEnemyPositions(){
  if(!G._enemySnapshot) return;
  G._enemySnapshot.forEach(snap=>{
    const e=G.enemies.find(e=>e.id===snap.id&&!e.dead);
    if(e){e.x=snap.x;e.y=snap.y;e.dx=snap.dx;e.dy=snap.dy;}
  });
  G._enemySnapshot=null;
}

function refreshBars(){
  const b=BIOMES[G.biomeIdx];
  const ep=Math.max(0,G.eHp/G.eMaxHp*100);
  const eb=document.getElementById('c-enemy-hp');
  eb.style.width=ep+'%';eb.style.background=ep>50?'#4caf50':ep>25?'#ff9800':'#f44336';
  document.getElementById('c-enemy-name').textContent=G.eBoss?b.boss.name:G.cEnemyType.name;
  document.getElementById('c-enemy-hptext').textContent=`${Math.round(G.eHp)}/${G.eMaxHp} HP`;
  const pp=Math.max(0,G.player.hp/G.player.maxHp*100);
  const pb=document.getElementById('c-player-hp');
  pb.style.width=pp+'%';pb.style.background=pp>50?'#4caf50':pp>25?'#ff9800':'#f44336';
  document.getElementById('c-player-name').textContent=G.player.name;
  document.getElementById('c-player-hptext').textContent=`${Math.round(G.player.hp)}/${G.player.maxHp} HP`;
}

function addLog(txt,col){
  const log=document.getElementById('c-log');
  const d=document.createElement('div');d.className='logline';d.style.color=col||'#ccc';d.textContent=txt;
  log.appendChild(d);log.scrollTop=log.scrollHeight;
}

function setActions(v){document.getElementById('c-actions').style.display=v?'flex':'none';}

function shakeCanvas(id){
  const el=document.getElementById(id);
  el.style.animation='none';void el.offsetWidth;
  el.style.animation='shake .35s ease-in-out';
  setTimeout(()=>el.style.animation='',400);
}

// Action buttons
document.getElementById('act-attack').onclick=()=>doAction('attack');
document.getElementById('act-heavy').onclick=()=>doAction('heavy');
document.getElementById('act-block').onclick=()=>doAction('block');
document.getElementById('act-dodge').onclick=()=>doAction('dodge');
document.getElementById('flee-btn').onclick=()=>{
  AudioEngine.sfxFlee();
  G.player.hp=Math.max(1,G.player.hp-Math.floor(G.player.hp*.15));
  stopTimer();
  const e=G.enemies.find(e=>e.id===G.eid);
  if(e){e.x=clamp(e.x+150,60,WW-60);e.y=clamp(e.y+100,60,WH-60);}
  restoreEnemyPositions();
  resetAggro();
  show('explore');startLoop();
};

function doAction(act){
  G.cAction=act;G.cAnswered=false;
  const b=BIOMES[G.biomeIdx];
  let w={...b.dw};
  if(act==='heavy'||act==='dodge')w={easy:.05,medium:.25,hard:.70};
  else if(act==='block')w={easy:.20,medium:.60,hard:.20};
  const roll=Math.random();let cum=0,diff='easy';
  for(const[d2,v]of Object.entries(w)){cum+=v;if(roll<cum){diff=d2;break;}}
  let pool=Q.map((q,i)=>({q,i})).filter(x=>x.q.d===diff&&!G.usedQ.has(x.i));
  if(!pool.length)pool=Q.map((q,i)=>({q,i})).filter(x=>!G.usedQ.has(x.i));
  if(!pool.length){G.usedQ=new Set();pool=Q.map((q,i)=>({q,i}));}
  const pick=pool[Math.floor(Math.random()*pool.length)];
  G.usedQ.add(pick.i);G.cQ=pick.q;
  const q=G.cQ,L='ABCD';
  document.getElementById('q-meta').textContent=`${q.c.toUpperCase()} ‚Ä¢ ${q.d.toUpperCase()}`;
  document.getElementById('q-text').textContent=q.q;
  ['qo0','qo1','qo2','qo3'].forEach((id,i)=>{
    const btn=document.getElementById(id);
    btn.textContent=`${L[i]}. ${q.o[i]}`;
    btn.className='qopt';btn.disabled=false;
  });
  document.getElementById('q-result').style.display='none';
  document.getElementById('q-panel').style.display='block';
  setActions(false);startTimer();
}

function startTimer(){stopTimer();G.cTimer=15;updateTimer();G.cTimerInt=setInterval(()=>{G.cTimer--;updateTimer();if(G.cTimer<=0){stopTimer();resolve2(-1);}},1000);}
function stopTimer(){if(G.cTimerInt){clearInterval(G.cTimerInt);G.cTimerInt=null;}}
function updateTimer(){
  const p=G.cTimer/15*100;
  const col=G.cTimer>8?'#4caf50':G.cTimer>4?'#ff9800':'#f44336';
  document.getElementById('timer-fill').style.width=p+'%';
  document.getElementById('timer-fill').style.background=col;
  document.getElementById('timer-num').textContent=G.cTimer;
  document.getElementById('timer-num').style.color=col;
}

['qo0','qo1','qo2','qo3'].forEach((id,i)=>{document.getElementById(id).onclick=()=>resolve2(i);});

function resolve2(idx){
  if(G.cAnswered)return;
  G.cAnswered=true;stopTimer();
  const q=G.cQ,correct=idx===q.a;
  G.cCorrect=correct;
  ['qo0','qo1','qo2','qo3'].forEach((id,i)=>{
    const btn=document.getElementById(id);btn.disabled=true;
    if(i===q.a)btn.classList.add('correct');
    else if(i===idx&&!correct)btn.classList.add('wrong');
  });
  const res=document.getElementById('q-result');
  res.style.display='block';res.style.color=correct?'#4caf50':'#f44336';
  res.textContent=correct?'‚úÖ CORRECT!':'‚ùå WRONG!';

  const etype=G.cEnemyType;
  const p=G.player;
  if(correct){
    if(G.cAction==='attack'){
      const dmg=Math.floor(p.atk*(0.85+Math.random()*.3));
      G.eHp=Math.max(0,G.eHp-dmg);
      AudioEngine.sfxHit();
      addLog(`‚úÖ Correct! ${dmg} damage!`,'#90ee90');shakeCanvas('c-enemy-canvas');
    }else if(G.cAction==='heavy'){
      const dmg=Math.floor(p.atk*2*(0.85+Math.random()*.3));
      G.eHp=Math.max(0,G.eHp-dmg);
      AudioEngine.sfxCritical();
      addLog(`üí• Critical! ${dmg} damage!`,'#ffd700');shakeCanvas('c-enemy-canvas');
    }else if(G.cAction==='block'){
      AudioEngine.sfxBlock();
      addLog('üõ°Ô∏è Blocking incoming hit!','#4fc3f7');
    }else{
      AudioEngine.sfxMiss();
      addLog('üí® Ready to dodge!','#ce93d8');
    }
  }else{
    const defReduction=Math.max(0.1, 1-(p.def*0.012)); // each DEF point reduces dmg by 1.2%, min 10%
    const pen=Math.floor(etype.baseAtk*(G.cAction==='heavy'?1.2:.6)*defReduction);
    p.hp=Math.max(0,p.hp-pen);
    AudioEngine.sfxHit();
    addLog(`‚ùå Wrong! ${pen} dmg taken! (DEF -${Math.round((1-defReduction)*100)}%)`, '#f44336');
    shakeCanvas('c-player-canvas');
  }

  refreshBars();
  if(G.player.hp<=0){AudioEngine.sfxCombatDefeat();addLog('üíÄ You have fallen...','#f44336');setTimeout(()=>show('gameover'),1800);return;}
  if(G.eHp<=0){addLog(`üèÜ ${G.eBoss?BIOMES[G.biomeIdx].boss.name:etype.name} defeated!`,'#ffd700');setTimeout(()=>endCombat(true),1500);return;}
  setTimeout(enemyTurn,1100);
}

function enemyTurn(){
  const etype=G.cEnemyType;
  const p=G.player;
  const acts=['attack','attack','attack','heavy','block','dodge'];
  const act=acts[Math.floor(Math.random()*acts.length)];
  const hit=Math.random()<etype.sc;
  const blocked=G.cAction==='block'&&G.cCorrect;
  const dodged=(G.cAction==='dodge'&&G.cCorrect)||Math.random()<(p.dodge||0);
  const defReduction=Math.max(0.1, 1-(p.def*0.012));
  if(act==='attack'){
    if(dodged){AudioEngine.sfxMiss();addLog(`üí® Dodged! (${Math.round((p.dodge||0)*100)}% chance)`,'#ce93d8');}
    else if(hit){
      const dmg=Math.floor(etype.baseAtk*(blocked?.4:1)*(0.8+Math.random()*.4)*defReduction);
      p.hp=Math.max(0,p.hp-dmg);
      if(blocked){AudioEngine.sfxBlock();}else{AudioEngine.sfxHit();}
      addLog(`üëä ${etype.name} hits ${dmg}${blocked?' (blocked)':''}!`,blocked?'#4fc3f7':'#f44336');
      shakeCanvas('c-player-canvas');
    }else{AudioEngine.sfxMiss();addLog(`${etype.name} misses!`,'#555');}
  }else if(act==='heavy'&&hit){
    if(dodged){AudioEngine.sfxMiss();addLog('üí® Dodged heavy attack!','#ce93d8');}
    else{
      const dmg=Math.floor(etype.baseAtk*1.8*(0.8+Math.random()*.4)*defReduction);
      p.hp=Math.max(0,p.hp-dmg);
      AudioEngine.sfxCritical();
      addLog(`üí¢ Heavy hit! ${dmg} damage!`,'#f44336');shakeCanvas('c-player-canvas');
    }
  }else if(act==='block'){AudioEngine.sfxBlock();addLog(`üõ°Ô∏è ${etype.name} guards!`,'#777');}
  else{AudioEngine.sfxMiss();addLog(`${etype.name} fumbles!`,'#555');}
  refreshBars();
  if(p.hp<=0){AudioEngine.sfxCombatDefeat();addLog('üíÄ You have fallen...','#f44336');setTimeout(()=>show('gameover'),1800);return;}
  setTimeout(()=>{document.getElementById('q-panel').style.display='none';setActions(true);G.cAnswered=false;},700);
}

function endCombat(won){
  const e=G.enemies.find(e=>e.id===G.eid);
  if(e) e.dead=true;

  // Track sentinel kills
  if(won && e && e.gatekeeper){
    G.gatekeepersKilled=(G.gatekeepersKilled||0)+1;
    const remaining=G.enemies.filter(en=>en.gatekeeper&&!en.dead).length;
    if(remaining===0){
      showItemDrop('‚öîÔ∏è All Sentinels defeated! Guardian can now be challenged!',3500);
    } else {
      showItemDrop(`‚öîÔ∏è Sentinel defeated! ${remaining} remaining!`,2500);
    }
  }

  if(won){
    // XP reward
    const xp=xpReward(G.cEnemyType, G.eBoss, G.eUnique);
    gainXP(xp);
    addLog(`+${xp} XP`,'#9c27b0');

    // Item drops
    const dropKey=G.eBoss?'boss':G.eUnique?'unique':(G.cEnemyType.type||'easy');
    const drops=rollDrops(dropKey);
    drops.forEach(itemId=>{
      const item=ITEMS.find(i=>i.id===itemId);
      if(!item) return;
      if(!G.player.inventory) G.player.inventory=[];
      G.player.inventory.push(itemId);
      G.pendingDrops.push(item);
    });
  }

  // If the unique guardian was just killed ‚Üí unlock the boss
  if(won && G.eUnique){
    AudioEngine.sfxWinUnique();
    G.uniqueKilled=true;
    const boss=G.enemies.find(e=>e.boss&&!e.dead);
    if(boss){
      boss.locked=false;
      boss.dx=(Math.random()-.5)*1.2;
      boss.dy=(Math.random()-.5)*1.2;
    }
    show('explore');
    G.bossUnlockFlash=180;
    restoreEnemyPositions();
    // Show drops then maybe level up
    _showPendingDrops(()=>{
      if(G.pendingLevelUp) showLevelUp();
      else startLoop();
    });
    return;
  }

  if(won && G.eBoss){
    AudioEngine.sfxWinBoss();
    G.defeated.add(G.biomeIdx);
    const advanceBiome = ()=>{
      if(G.defeated.size>=4){ show('victory'); initVictory(); }
      else{ G.biomeIdx++; initWorld(); show('explore'); layoutUI(); showIntro(); }
    };
    _showPendingDrops(()=>{
      if(G.pendingLevelUp){ G._postLevelUp=advanceBiome; showLevelUp(); return; }
      advanceBiome();
    });
  } else {
    if(won) AudioEngine.sfxWinNormal();
    show('explore');
    restoreEnemyPositions();
    _showPendingDrops(()=>{
      if(G.pendingLevelUp) showLevelUp();
      else startLoop();
    });
  }
}

function _showPendingDrops(cb){
  if(!G.pendingDrops||!G.pendingDrops.length){cb();return;}
  const drops=[...G.pendingDrops]; G.pendingDrops=[];
  let msg=drops.map(i=>`${i.icon} ${i.name}`).join('  ');
  showItemDrop('üéÅ LOOT: '+msg, 2500);
  setTimeout(cb, 2600);
}

// ================================================================
// GAME OVER / VICTORY
// ================================================================
document.getElementById('btn-go-menu').onclick=()=>show('menu');
document.getElementById('btn-v-menu').onclick=()=>show('menu');
function initVictory(){
  const vs=document.getElementById('v-stars');vs.innerHTML='';
  ['üåü','‚≠ê','‚ú®','üí´'].forEach((em,i)=>{
    for(let j=0;j<3;j++){
      const d=document.createElement('div');d.className='vstar';
      d.style.left=((i*3+j)*17)%100+'%';d.style.top=((i*3+j)*23)%80+'%';
      d.style.animationDuration=(.5+j*.3)+'s';d.style.animationDelay=(i*.15)+'s';
      d.textContent=em;vs.appendChild(d);
    }
  });
}
// ================================================================
// RESPONSIVE LAYOUT ‚Äî runs on load + every resize
// ================================================================
function isTouchDevice(){
  return ('ontouchstart' in window) || navigator.maxTouchPoints>0;
}

function layoutUI(){
  const W=window.innerWidth, H=window.innerHeight;
  const isPortrait = H > W;
  const isMobile = W < 768 || isTouchDevice();

  // ‚îÄ‚îÄ Joystick ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const joy=document.getElementById('joy');
  const knob=document.getElementById('joy-knob');

  if(isMobile){
    // Size: 16% of shorter dimension, min 80px, max 130px
    const jSize = Math.round(Math.min(Math.max(Math.min(W,H)*0.18, 80), 130));
    const knobSize = Math.round(jSize*0.36);
    const margin = Math.round(jSize*0.18);
    // Safe area bottom (handles iPhone notch etc)
    const safeBottom = Math.max(margin, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sab')||'0') + margin);

    joy.style.display='flex';
    joy.style.width  = jSize+'px';
    joy.style.height = jSize+'px';
    joy.style.left   = margin+'px';
    joy.style.bottom = safeBottom+'px';
    joy.style.top    = '';
    knob.style.width  = knobSize+'px';
    knob.style.height = knobSize+'px';

    // Pause btn ‚Äî opposite corner from joystick
    const pb=document.getElementById('pause-explore-btn');
    pb.style.bottom = safeBottom+'px';
    pb.style.right  = margin+'px';
    pb.style.top    = '';
    pb.style.left   = '';

    // Minimap ‚Äî above joystick on mobile
    const mm=document.getElementById('minimap');
    const mmH=Math.round(H*0.1);
    const mmW=Math.round(mmH*1.8);
    mm.style.width  = mmW+'px';
    mm.style.height = mmH+'px';
    mm.style.right  = margin+'px';
    mm.style.bottom = (safeBottom + jSize + margin)+'px';
    mm.style.top    = '';
    // Resize minimap canvas
    const mmc=document.getElementById('mm-canvas');
    mmc.width=mmW; mmc.height=mmH;

  } else {
    // Desktop ‚Äî hide joystick, fix positions
    joy.style.display='none';

    const pb=document.getElementById('pause-explore-btn');
    pb.style.bottom='14px'; pb.style.right='14px';
    pb.style.top=''; pb.style.left='';

    const mm=document.getElementById('minimap');
    mm.style.width='120px'; mm.style.height='70px';
    mm.style.right='14px';
    mm.style.bottom='60px';
    mm.style.top='';
    const mmc=document.getElementById('mm-canvas');
    mmc.width=120; mmc.height=70;
  }

  // ‚îÄ‚îÄ HUD font scaling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const hudFontScale = Math.max(0.65, Math.min(1.0, W/600));
  document.getElementById('hud').style.fontSize = (8*hudFontScale)+'px';

  // ‚îÄ‚îÄ Combat screen scaling on small phones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(W < 480){
    // Tighter padding on very small phones
    document.getElementById('combat').style.padding='6px';
    document.getElementById('c-log').style.height='80px';
    document.querySelectorAll('.abtn').forEach(b=>b.style.fontSize='6px');
    document.getElementById('q-text').style.fontSize='10px';
    document.querySelectorAll('.qopt').forEach(b=>b.style.fontSize='9px');
  } else {
    document.getElementById('combat').style.padding='10px';
    document.getElementById('c-log').style.height='120px';
    document.querySelectorAll('.abtn').forEach(b=>b.style.fontSize='7px');
    document.getElementById('q-text').style.fontSize='12px';
    document.querySelectorAll('.qopt').forEach(b=>b.style.fontSize='11px');
  }
}

// Apply CSS env() safe area variable for iOS notch
const safeStyle=document.createElement('style');
safeStyle.textContent=':root{--sab:env(safe-area-inset-bottom,0px);}';
document.head.appendChild(safeStyle);

// Run layout on load and on every resize/orientation change
layoutUI();
window.addEventListener('resize',()=>{layoutUI();if(G.screen==='explore')drawWorld();});
window.addEventListener('orientationchange',()=>{setTimeout(()=>{layoutUI();if(G.screen==='explore')drawWorld();},150);});

// ================================================================
// JOYSTICK (touch events ‚Äî updated to use dynamic knob size)
// ================================================================
const joy=document.getElementById('joy');
const knob=document.getElementById('joy-knob');
let jBase={x:0,y:0};

joy.addEventListener('touchstart',e=>{
  e.preventDefault();
  const r=joy.getBoundingClientRect();
  jBase={x:r.left+r.width/2, y:r.top+r.height/2};
},{passive:false});

joy.addEventListener('touchmove',e=>{
  e.preventDefault();
  const t=e.touches[0];
  const ddx=t.clientX-jBase.x, ddy=t.clientY-jBase.y;
  const len=Math.hypot(ddx,ddy)||1;
  if(len<5){G.jdx=0;G.jdy=0;return;}
  G.jdx=ddx/len; G.jdy=ddy/len;
  const r=joy.getBoundingClientRect();
  const maxMove=(r.width/2)*0.55;
  const mv=Math.min(len,maxMove);
  knob.style.transform=`translate(${ddx/len*mv}px,${ddy/len*mv}px)`;
},{passive:false});

joy.addEventListener('touchend',()=>{
  G.jdx=0; G.jdy=0;
  knob.style.transform='';
});

// ================================================================
// AUDIO ENGINE ‚Äî Procedural Music & SFX  (Web Audio API)
// ================================================================
const AudioEngine = (() => {
  let ctx = null, masterVol = null, musicVol = null, sfxVol = null;
  let am = null; // active music state

  function init() {
    if (ctx) { if (ctx.state === 'suspended') ctx.resume(); return; }
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    masterVol = ctx.createGain(); masterVol.gain.value = 0.7; masterVol.connect(ctx.destination);
    musicVol  = ctx.createGain(); musicVol.gain.value  = 0.38; musicVol.connect(masterVol);
    sfxVol    = ctx.createGain(); sfxVol.gain.value    = 0.55; sfxVol.connect(masterVol);
  }

  /* Frequency helper: hz('C',4) = middle C */
  function hz(n, oct) {
    const s={C:0,Cs:1,D:2,Ds:3,E:4,F:5,Fs:6,G:7,Gs:8,A:9,As:10,B:11};
    return 440 * Math.pow(2, (s[n] + (oct+1)*12 - 69) / 12);
  }

  /* Single oscillator note */
  function tone(f, t0, dur, type, vol, out) {
    if (!ctx) return null;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type = type; o.frequency.value = f;
    g.gain.setValueAtTime(0.001, t0);
    g.gain.linearRampToValueAtTime(vol, t0 + Math.min(0.016, dur*0.15));
    g.gain.setValueAtTime(vol, t0 + dur*0.72);
    g.gain.exponentialRampToValueAtTime(0.001, t0 + dur);
    o.connect(g); g.connect(out);
    o.start(t0); o.stop(t0 + dur + 0.05);
    return o;
  }

  /* Schedule array of [freq|null, beats] at bpm starting at t0 */
  function seq(notes, bpm, out, type, vol, t0) {
    const bt = 60/bpm; const nodes = []; let t = t0;
    notes.forEach(([f, b]) => {
      const d = b * bt;
      if (f) { const o = tone(f, t, d*0.86, type, vol, out); if (o) nodes.push(o); }
      t += d;
    });
    return { nodes, totalTime: t - t0 };
  }

  /* Loop a track ‚Äî fn(t0) returns {nodes, totalTime} */
  function loop(name, fn) {
    if (am && am.name === name) return;
    stop();
    const state = { name, alive:true, nodes:[], timeout:null };
    am = state;
    function go(t0) {
      if (!state.alive || !ctx) return;
      const r = fn(t0);
      state.nodes.push(...r.nodes);
      state.timeout = setTimeout(() => {
        if (state.nodes.length > 300) state.nodes = state.nodes.slice(-100);
        go(t0 + r.totalTime);
      }, Math.max(80, (r.totalTime - 0.4)*1000));
    }
    go(ctx.currentTime + 0.05);
  }

  function stop() {
    if (am) {
      am.alive = false; clearTimeout(am.timeout);
      am.nodes.forEach(n => { try { n.stop(ctx.currentTime + 0.05); } catch(e){} });
      am = null;
    }
  }

  // ‚îÄ‚îÄ Note data (shared ref) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const H = hz;

  /* MAIN MENU ‚Äî calm mysterious arpeggios, A minor 70 BPM */
  const MENU_MEL = [
    [H('A',3),1],[H('C',4),.5],[H('E',4),.5],[H('A',4),1],
    [H('G',4),.5],[H('E',4),.5],[H('C',4),.5],[H('A',3),.5],
    [H('F',3),1],[H('A',3),.5],[H('C',4),.5],[H('F',4),1],
    [H('E',4),.5],[H('C',4),.5],[H('A',3),.5],[H('G',3),.5],
    [H('E',3),1],[H('G',3),.5],[H('B',3),.5],[H('E',4),1],
    [H('D',4),.5],[H('B',3),.5],[H('G',3),.5],[H('E',3),.5],
    [H('D',3),1],[H('F',3),.5],[H('A',3),.5],[H('D',4),1],
    [H('C',4),.5],[H('A',3),.5],[H('F',3),.5],[H('E',3),.5],
  ];
  const MENU_BAS = [
    [H('A',2),2],[H('A',2),2],[H('F',2),2],[H('G',2),2],
    [H('E',2),2],[H('E',2),2],[H('D',2),2],[H('E',2),2],
  ];

  /* EXPLORE ‚Äî upbeat adventure, C major 125 BPM */
  const EXP_MEL = [
    [H('C',4),.5],[H('E',4),.25],[H('G',4),.25],[H('C',5),.5],[H('B',4),.5],
    [H('G',4),.5],[H('E',4),.5],[null,.5],
    [H('F',4),.5],[H('A',4),.25],[H('C',5),.25],[H('F',5),.5],[H('E',5),.5],
    [H('C',5),.5],[H('A',4),.5],[null,.5],
    [H('G',4),.5],[H('B',4),.25],[H('D',5),.25],[H('G',5),.5],
    [H('F',5),.25],[H('D',5),.25],[H('B',4),.5],[H('G',4),.5],[null,.5],
    [H('C',5),1],[null,.5],[H('G',4),.5],
    [H('E',4),.5],[H('G',4),.5],[H('C',5),1],
  ];
  const EXP_BAS = [
    [H('C',3),1],[H('G',2),1],[H('F',2),1],[H('G',2),1],
    [H('C',3),1],[H('G',2),1],[H('A',2),1],[H('G',2),1],
  ];
  const EXP_PAD = [
    [H('E',3),.5],[null,.5],[H('G',3),.5],[null,.5],
    [H('C',3),.5],[null,.5],[H('E',3),.5],[null,.5],
    [H('F',3),.5],[null,.5],[H('A',3),.5],[null,.5],
    [H('D',3),.5],[null,.5],[H('F',3),.5],[null,.5],
  ];

  /* BATTLE ‚Äî fast intense, D minor 165 BPM */
  const BAT_MEL = [
    [H('D',4),.25],[H('F',4),.25],[H('A',4),.25],[H('D',5),.25],
    [H('C',5),.25],[H('A',4),.25],[H('F',4),.25],[H('D',4),.25],
    [H('Ds',4),.25],[H('G',4),.25],[H('As',4),.25],[H('Ds',5),.25],
    [H('D',5),.25],[H('As',4),.25],[H('G',4),.25],[H('Ds',4),.25],
    [H('F',4),.5],[H('A',4),.25],[H('C',5),.25],
    [H('F',5),.5],[H('E',5),.25],[H('C',5),.25],
    [H('D',5),.5],[H('A',4),.5],[H('G',4),1],
    [H('As',4),.5],[H('D',5),.25],[H('F',5),.25],
    [H('E',5),.5],[H('C',5),.25],[H('A',4),.25],
    [H('Gs',4),.5],[H('F',4),.5],[H('D',4),1],
  ];
  const BAT_BAS = [
    [H('D',3),.5],[H('D',3),.5],[H('Ds',3),.5],[H('Ds',3),.5],
    [H('F',3),.5],[H('F',3),.5],[H('G',3),.5],[H('G',3),.5],
    [H('D',3),.5],[H('D',3),.5],[H('C',3),.5],[H('C',3),.5],
    [H('As',2),.5],[H('As',2),.5],[H('A',2),.5],[H('A',2),.5],
  ];
  const BAT_PRC = [ /* rhythmic pulse */
    [H('D',2),.25],[null,.25],[H('D',2),.25],[null,.25],
    [H('D',2),.25],[null,.25],[H('G',2),.25],[null,.25],
  ];

  /* BOSS BATTLE ‚Äî chromatic menace, 185 BPM */
  const BOSS_MEL = [
    [H('D',4),.125],[H('Ds',4),.125],[H('D',4),.25],[H('A',4),.25],[H('F',4),.25],
    [H('D',4),.125],[H('Cs',4),.125],[H('D',4),.25],[H('As',4),.25],[H('G',4),.25],
    [H('F',4),.5],[H('A',4),.25],[H('D',5),.25],
    [H('C',5),.25],[H('A',4),.25],[H('F',4),.25],[H('D',4),.25],
    [H('G',4),.125],[H('Gs',4),.125],[H('G',4),.25],[H('D',5),.25],[H('As',4),.25],
    [H('G',4),.125],[H('Fs',4),.125],[H('G',4),.25],[H('Ds',5),.25],[H('B',4),.25],
    [H('A',4),.5],[H('D',5),.25],[H('F',5),.25],
    [H('E',5),.25],[H('Cs',5),.25],[H('A',4),.25],[H('Fs',4),.25],
    [H('D',4),1],
  ];
  const BOSS_BAS = [
    [H('D',2),.25],[H('D',2),.25],[H('A',2),.25],[H('D',2),.25],
    [H('G',2),.25],[H('G',2),.25],[H('D',2),.25],[H('D',2),.25],
    [H('F',2),.25],[H('F',2),.25],[H('C',3),.25],[H('F',2),.25],
    [H('E',2),.25],[H('E',2),.25],[H('B',2),.25],[H('E',2),.25],
    [H('D',2),.25],[H('D',2),.25],[H('A',2),.25],[H('D',2),.25],
    [H('Cs',2),.25],[H('Cs',2),.25],[H('G',2),.25],[H('Cs',2),.25],
    [H('F',2),.25],[H('F',2),.25],[H('A',2),.25],[H('F',2),.25],
    [H('G',2),.5],[H('D',2),.5],
  ];

  /* VICTORY ‚Äî triumphant C major fanfare 130 BPM */
  const VIC_MEL = [
    [H('C',4),.5],[H('C',4),.5],[H('C',4),.5],[H('E',4),.5],
    [H('G',4),.75],[null,.25],[H('G',4),.5],[H('A',4),.5],
    [H('G',4),1],[null,.5],[H('F',4),.5],
    [H('E',4),.5],[H('F',4),.5],[H('E',4),.5],[H('D',4),.5],
    [H('C',5),1.5],[null,.5],
    [H('G',4),.5],[H('F',4),.5],[H('E',4),.5],[H('D',4),.5],
    [H('C',5),1.5],[null,.5],
    [H('E',5),.5],[H('D',5),.5],[H('C',5),1],[null,1],
  ];
  const VIC_HRM = [
    [H('E',4),.5],[H('G',4),.5],[H('C',5),.5],[H('G',4),.5],
    [H('D',5),.75],[null,.25],[H('D',5),.5],[H('E',5),.5],
    [H('D',5),1],[null,1],
    [H('G',4),.5],[H('A',4),.5],[H('G',4),.5],[H('F',4),.5],
    [H('E',5),1.5],[null,.5],
    [H('B',4),.5],[H('A',4),.5],[H('G',4),.5],[H('F',4),.5],
    [H('E',5),1.5],[null,.5],
    [H('G',5),.5],[H('F',5),.5],[H('E',5),1],[null,1],
  ];

  /* DEFEAT ‚Äî somber, A minor 55 BPM */
  const DEF_MEL = [
    [H('A',4),1.5],[H('G',4),1.5],[H('F',4),1.5],[H('E',4),1.5],
    [H('D',4),1.5],[H('C',4),1.5],[H('B',3),1.5],[H('A',3),3],
    [null,2],
  ];
  const DEF_BAS = [
    [H('A',2),2],[H('E',2),2],[H('D',2),2],[H('E',2),2],
    [H('D',2),2],[H('A',1),4],[null,3],
  ];

  // ‚îÄ‚îÄ Public Track Players ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function playMenu()   { loop('menu',   t => { const r=seq(MENU_MEL,70,musicVol,'sine',.17,t); const s=seq(MENU_BAS,70,musicVol,'sine',.11,t); return {nodes:[...r.nodes,...s.nodes],totalTime:r.totalTime}; }); }
  function playExplore(){ loop('explore',t => { const r=seq(EXP_MEL,125,musicVol,'triangle',.15,t); const s=seq(EXP_BAS,125,musicVol,'triangle',.12,t); const p=seq(EXP_PAD,125,musicVol,'sine',.08,t); return {nodes:[...r.nodes,...s.nodes,...p.nodes],totalTime:r.totalTime}; }); }
  function playBattle() { loop('battle', t => { const r=seq(BAT_MEL,165,musicVol,'sawtooth',.12,t); const s=seq(BAT_BAS,165,musicVol,'square',.10,t); const p=seq(BAT_PRC,165,musicVol,'square',.09,t); return {nodes:[...r.nodes,...s.nodes,...p.nodes],totalTime:r.totalTime}; }); }
  function playBoss()   { loop('boss',   t => { const r=seq(BOSS_MEL,185,musicVol,'sawtooth',.12,t); const s=seq(BOSS_BAS,185,musicVol,'square',.11,t); return {nodes:[...r.nodes,...s.nodes],totalTime:r.totalTime}; }); }
  function playVictory(){ loop('victory',t => { const r=seq(VIC_MEL,130,musicVol,'triangle',.19,t); const s=seq(VIC_HRM,130,musicVol,'sine',.14,t); return {nodes:[...r.nodes,...s.nodes],totalTime:r.totalTime}; }); }
  function playDefeat() { loop('defeat', t => { const r=seq(DEF_MEL,55,musicVol,'sine',.17,t); const s=seq(DEF_BAS,55,musicVol,'sine',.12,t); return {nodes:[...r.nodes,...s.nodes],totalTime:r.totalTime}; }); }

  // ‚îÄ‚îÄ SFX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function sfxEncounter() {
    if (!ctx) return;
    [[400,.1],[600,.1],[850,.14]].forEach(([f,d],i) => tone(f, ctx.currentTime+i*.13, d, 'square', .28, sfxVol));
  }
  function sfxLevelUp() {
    if (!ctx) return;
    const j=[[H('C',4),.2],[H('E',4),.2],[H('G',4),.2],[H('C',5),.3],[H('E',5),.3],[H('G',5),.55]];
    let t=ctx.currentTime; j.forEach(([f,d])=>{tone(f,t,d*.85,'triangle',.32,sfxVol);t+=d;});
  }
  function sfxItemUse() {
    if (!ctx) return;
    [523,659,784,1047,1319].forEach((f,i) => tone(f, ctx.currentTime+i*.065, .13, 'sine', .26, sfxVol));
  }
  function sfxFootstep() {
    if (!ctx) return;
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(85,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(38,ctx.currentTime+.07);
    g.gain.setValueAtTime(.1,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.07);
    o.connect(g); g.connect(sfxVol); o.start(); o.stop(ctx.currentTime+.09);
  }

  /* HIT ‚Äî solid thud + metallic clang */
  function sfxHit() {
    if (!ctx) return;
    const t = ctx.currentTime;
    // Low thud
    const o1=ctx.createOscillator(), g1=ctx.createGain();
    o1.type='sine'; o1.frequency.setValueAtTime(180,t); o1.frequency.exponentialRampToValueAtTime(55,t+.12);
    g1.gain.setValueAtTime(.36,t); g1.gain.exponentialRampToValueAtTime(.001,t+.14);
    o1.connect(g1); g1.connect(sfxVol); o1.start(t); o1.stop(t+.16);
    // Impact click (noise burst via high-freq osc)
    const o2=ctx.createOscillator(), g2=ctx.createGain();
    o2.type='square'; o2.frequency.setValueAtTime(620,t); o2.frequency.exponentialRampToValueAtTime(200,t+.06);
    g2.gain.setValueAtTime(.22,t); g2.gain.exponentialRampToValueAtTime(.001,t+.07);
    o2.connect(g2); g2.connect(sfxVol); o2.start(t); o2.stop(t+.08);
  }

  /* CRITICAL ‚Äî sharp crack + rising power surge */
  function sfxCritical() {
    if (!ctx) return;
    const t = ctx.currentTime;
    // Heavy crack
    [0, .04, .09].forEach((dt, i) => {
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type='sawtooth';
      o.frequency.setValueAtTime(350-i*60, t+dt);
      o.frequency.exponentialRampToValueAtTime(80, t+dt+.13);
      g.gain.setValueAtTime(.28-i*.05, t+dt);
      g.gain.exponentialRampToValueAtTime(.001, t+dt+.15);
      o.connect(g); g.connect(sfxVol); o.start(t+dt); o.stop(t+dt+.17);
    });
    // Power surge sweep up
    const os=ctx.createOscillator(), gs=ctx.createGain();
    os.type='square'; os.frequency.setValueAtTime(120,t+.05); os.frequency.exponentialRampToValueAtTime(900,t+.3);
    gs.gain.setValueAtTime(.001,t+.05); gs.gain.linearRampToValueAtTime(.18,t+.12); gs.gain.exponentialRampToValueAtTime(.001,t+.35);
    os.connect(gs); gs.connect(sfxVol); os.start(t+.05); os.stop(t+.38);
  }

  /* BLOCK ‚Äî heavy metallic clang with reverb tail */
  function sfxBlock() {
    if (!ctx) return;
    const t = ctx.currentTime;
    // Metal clang: two detuned square oscillators
    [[310, 318], [620, 630]].forEach(([f1, f2], layer) => {
      [f1, f2].forEach(f => {
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='square'; o.frequency.value=f;
        const vol = layer===0 ? .2 : .12;
        g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(.001,t+.45);
        o.connect(g); g.connect(sfxVol); o.start(t); o.stop(t+.5);
      });
    });
    // Low bash thud
    const ob=ctx.createOscillator(), gb=ctx.createGain();
    ob.type='sine'; ob.frequency.setValueAtTime(140,t); ob.frequency.exponentialRampToValueAtTime(60,t+.08);
    gb.gain.setValueAtTime(.3,t); gb.gain.exponentialRampToValueAtTime(.001,t+.1);
    ob.connect(gb); gb.connect(sfxVol); ob.start(t); ob.stop(t+.12);
  }

  /* MISS ‚Äî airy whoosh, no impact */
  function sfxMiss() {
    if (!ctx) return;
    const t = ctx.currentTime;
    // Whoosh: noise-like via detuned saws + fast filter sweep
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sawtooth'; o.frequency.setValueAtTime(800,t); o.frequency.exponentialRampToValueAtTime(180,t+.18);
    g.gain.setValueAtTime(.001,t); g.gain.linearRampToValueAtTime(.14,t+.04); g.gain.exponentialRampToValueAtTime(.001,t+.2);
    o.connect(g); g.connect(sfxVol); o.start(t); o.stop(t+.22);
    // Dry click at very start
    const oc=ctx.createOscillator(), gc=ctx.createGain();
    oc.type='sine'; oc.frequency.value=1200;
    gc.gain.setValueAtTime(.08,t); gc.gain.exponentialRampToValueAtTime(.001,t+.025);
    oc.connect(gc); gc.connect(sfxVol); oc.start(t); oc.stop(t+.03);
  }

  /* WIN (NORMAL) ‚Äî quick cheerful 4-note ding */
  function sfxWinNormal() {
    if (!ctx) return;
    const t = ctx.currentTime;
    [[H('C',4),.12],[H('E',4),.12],[H('G',4),.12],[H('C',5),.28]].forEach(([f,d],i) => {
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type='triangle'; o.frequency.value=f;
      const at=t+i*.1;
      g.gain.setValueAtTime(.001,at); g.gain.linearRampToValueAtTime(.3,at+.02);
      g.gain.setValueAtTime(.3,at+d*.7); g.gain.exponentialRampToValueAtTime(.001,at+d+.06);
      o.connect(g); g.connect(sfxVol); o.start(at); o.stop(at+d+.08);
    });
  }

  /* WIN (UNIQUE/GUARDIAN) ‚Äî 6-note ascending fanfare with harmonic */
  function sfxWinUnique() {
    if (!ctx) return;
    const t = ctx.currentTime;
    const mel=[[H('C',4),.1],[H('E',4),.1],[H('G',4),.1],[H('C',5),.1],[H('E',5),.1],[H('G',5),.35]];
    const hrm=[[H('E',4),.1],[H('G',4),.1],[H('C',5),.1],[H('E',5),.1],[H('G',5),.1],[H('C',6),.35]];
    mel.forEach(([f,d],i)=>{
      const at=t+i*.09;
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.type='triangle'; o.frequency.value=f;
      g.gain.setValueAtTime(.001,at); g.gain.linearRampToValueAtTime(.28,at+.02);
      g.gain.setValueAtTime(.28,at+d*.75); g.gain.exponentialRampToValueAtTime(.001,at+d+.07);
      o.connect(g); g.connect(sfxVol); o.start(at); o.stop(at+d+.09);
    });
    hrm.forEach(([f,d],i)=>{
      const at=t+i*.09;
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.type='sine'; o.frequency.value=f;
      g.gain.setValueAtTime(.001,at); g.gain.linearRampToValueAtTime(.15,at+.02);
      g.gain.setValueAtTime(.15,at+d*.75); g.gain.exponentialRampToValueAtTime(.001,at+d+.07);
      o.connect(g); g.connect(sfxVol); o.start(at); o.stop(at+d+.09);
    });
    // Gold shimmer tail ‚Äî high twinkling notes
    [H('C',6),H('E',6),H('G',6)].forEach((f,i)=>{
      const at=t+.55+i*.07;
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.type='sine'; o.frequency.value=f;
      g.gain.setValueAtTime(.12,at); g.gain.exponentialRampToValueAtTime(.001,at+.18);
      o.connect(g); g.connect(sfxVol); o.start(at); o.stop(at+.2);
    });
  }

  /* WIN (BOSS) ‚Äî epic 3-part triumphant fanfare */
  function sfxWinBoss() {
    if (!ctx) return;
    const t = ctx.currentTime;
    // Brass-like chord stabs
    const stabs=[[H('C',3),H('G',3),H('C',4)],[H('F',3),H('C',4),H('F',4)],[H('G',3),H('D',4),H('G',4)]];
    stabs.forEach((chord,si)=>{
      const at=t+si*.22;
      chord.forEach(f=>{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sawtooth'; o.frequency.value=f;
        g.gain.setValueAtTime(.001,at); g.gain.linearRampToValueAtTime(.18,at+.025);
        g.gain.setValueAtTime(.16,at+.12); g.gain.exponentialRampToValueAtTime(.001,at+.2);
        o.connect(g); g.connect(sfxVol); o.start(at); o.stop(at+.22);
      });
    });
    // Triumphant melody rise
    const mel2=[[H('C',4),.1],[H('E',4),.1],[H('G',4),.1],[H('C',5),.1],[H('E',5),.1],[H('G',5),.15],[H('C',6),.5]];
    mel2.forEach(([f,d],i)=>{
      const at=t+.68+i*.1;
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.type='triangle'; o.frequency.value=f;
      g.gain.setValueAtTime(.001,at); g.gain.linearRampToValueAtTime(.3,at+.02);
      g.gain.setValueAtTime(.3,at+d*.7); g.gain.exponentialRampToValueAtTime(.001,at+d+.1);
      o.connect(g); g.connect(sfxVol); o.start(at); o.stop(at+d+.12);
    });
    // Low bass boom at the end
    const at2=t+1.42;
    const ob=ctx.createOscillator(),gb=ctx.createGain();
    ob.type='sine'; ob.frequency.setValueAtTime(80,at2); ob.frequency.exponentialRampToValueAtTime(40,at2+.35);
    gb.gain.setValueAtTime(.4,at2); gb.gain.exponentialRampToValueAtTime(.001,at2+.38);
    ob.connect(gb); gb.connect(sfxVol); ob.start(at2); ob.stop(at2+.4);
    // Sparkling top twinkles
    [H('C',6),H('G',6),H('E',6),H('C',7)].forEach((f,i)=>{
      const at3=t+1.5+i*.08;
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.type='sine'; o.frequency.value=f;
      g.gain.setValueAtTime(.14,at3); g.gain.exponentialRampToValueAtTime(.001,at3+.22);
      o.connect(g); g.connect(sfxVol); o.start(at3); o.stop(at3+.24);
    });
  }

  /* COMBAT DEFEAT ‚Äî short downward death toll (separate from defeat music) */
  function sfxCombatDefeat() {
    if (!ctx) return;
    const t = ctx.currentTime;
    // Descending minor toll
    [[H('A',4),.25],[H('F',4),.25],[H('D',4),.25],[H('A',3),.5]].forEach(([f,d],i)=>{
      const at=t+i*.28;
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.type='sine'; o.frequency.value=f;
      g.gain.setValueAtTime(.001,at); g.gain.linearRampToValueAtTime(.28,at+.03);
      g.gain.setValueAtTime(.28,at+d*.6); g.gain.exponentialRampToValueAtTime(.001,at+d+.15);
      o.connect(g); g.connect(sfxVol); o.start(at); o.stop(at+d+.18);
    });
    // Low rumble
    const ob=ctx.createOscillator(),gb=ctx.createGain();
    ob.type='sine'; ob.frequency.setValueAtTime(55,t+.8); ob.frequency.exponentialRampToValueAtTime(28,t+1.4);
    gb.gain.setValueAtTime(.3,t+.8); gb.gain.exponentialRampToValueAtTime(.001,t+1.45);
    ob.connect(gb); gb.connect(sfxVol); ob.start(t+.8); ob.stop(t+1.48);
  }

  /* FLEE ‚Äî frantic ascending scramble */
  function sfxFlee() {
    if (!ctx) return;
    const t = ctx.currentTime;
    // Rapid rising notes like panicked footsteps
    [220,277,330,415,523,659,830].forEach((f,i) => {
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type='square'; o.frequency.value=f;
      g.gain.setValueAtTime(.18,t+i*.045); g.gain.exponentialRampToValueAtTime(.001,t+i*.045+.07);
      o.connect(g); g.connect(sfxVol); o.start(t+i*.045); o.stop(t+i*.045+.09);
    });
    // Descending "oh no" bass drop
    const ob=ctx.createOscillator(), gb=ctx.createGain();
    ob.type='sine'; ob.frequency.setValueAtTime(300,t+.32); ob.frequency.exponentialRampToValueAtTime(60,t+.62);
    gb.gain.setValueAtTime(.22,t+.32); gb.gain.exponentialRampToValueAtTime(.001,t+.65);
    ob.connect(gb); gb.connect(sfxVol); ob.start(t+.32); ob.stop(t+.67);
  }

  return { init, stop, playMenu, playExplore, playBattle, playBoss, playVictory, playDefeat, sfxEncounter, sfxLevelUp, sfxItemUse, sfxFootstep, sfxHit, sfxCritical, sfxBlock, sfxMiss, sfxFlee, sfxWinNormal, sfxWinUnique, sfxWinBoss, sfxCombatDefeat };
})();

// Footstep timer (frames between steps)
let _footstepTick = 0;

// ================================================================
// CHEAT CODE  ‚Äî  Keyboard: ‚Üë ‚Üë ‚Üì ‚Üì ‚Üê ‚Üí ‚Üê ‚Üí B
//                Mobile:   Tap game title 7√ó within 3 seconds
// ================================================================
const KONAMI = ['arrowup','arrowup','arrowdown','arrowdown',
                'arrowleft','arrowright','arrowleft','arrowright','b'];
let _konamiIdx = 0;

window.addEventListener('keydown', e => {
  const k = e.key.toLowerCase();
  if(k === KONAMI[_konamiIdx]){ _konamiIdx++; }
  else { _konamiIdx = (k === KONAMI[0]) ? 1 : 0; }
  if(_konamiIdx === KONAMI.length){ _konamiIdx = 0; openCheat(); }
  if(k === 'escape' && document.getElementById('cheat-panel').style.display !== 'none'){
    closeCheat();
  }
});

// Mobile: tap the title 7 times within 3 seconds
let _tapCount = 0, _tapTimer = null;
const TAP_TARGET = 7;
document.addEventListener('DOMContentLoaded', () => {
  const title = document.getElementById('menu-title');
  if(title){
    title.addEventListener('touchstart', e => {
      e.stopPropagation();
      _tapCount++;
      clearTimeout(_tapTimer);
      // Flash title slightly on each tap so user gets feedback
      title.style.opacity = '0.6';
      setTimeout(() => title.style.opacity = '', 80);
      if(_tapCount >= TAP_TARGET){
        _tapCount = 0; openCheat(); return;
      }
      _tapTimer = setTimeout(() => { _tapCount = 0; }, 3000);
    }, {passive:true});
  }
});

function openCheat(){
  // Update subtitle to show the right hint based on device
  const hint = document.getElementById('cheat-hint');
  if(hint){
    hint.textContent = isTouchDevice()
      ? 'Tap title √ó7 activated'
      : '‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíB activated';
  }
  const p = document.getElementById('cheat-panel');
  p.style.display = 'flex';
  cheatStatus('');
}
function closeCheat(){
  document.getElementById('cheat-panel').style.display = 'none';
  if(G.screen === 'explore') startLoop();
}
function cheatStatus(msg){ document.getElementById('cheat-status').textContent = msg; }

function cheatWarp(biomeIdx){
  stopLoop();
  // Mark all earlier biomes as defeated so the game won't revert
  for(let i = 0; i < biomeIdx; i++) G.defeated.add(i);
  G.biomeIdx = biomeIdx;
  G.player.hp = G.player.maxHp;  // heal on warp
  initWorld();
  closeCheat();
  show('explore');
  layoutUI();
  showIntro();
  cheatStatus('‚úî Warped to ' + BIOMES[biomeIdx].name);
}

function cheatMaxHP(){
  if(!G.player){ cheatStatus('‚ö† No player yet'); return; }
  G.player.hp = G.player.maxHp;
  updateHUD();
  cheatStatus('‚úî HP fully restored!');
}

function cheatKillAll(){
  if(!G.player){ cheatStatus('‚ö† No player yet'); return; }
  if(!G.enemies.length){ cheatStatus('‚ö† No enemies on map'); return; }

  // Close panel and stop the loop cleanly before touching game state
  document.getElementById('cheat-panel').style.display = 'none';
  stopLoop();

  let totalXP = 0;
  let hasBoss = false;

  // Kill every living enemy and accumulate rewards
  G.enemies.forEach(e => {
    if(e.dead) return;
    e.dead = true;

    const xp = xpReward(e.etype, e.boss, !!e.unique);
    totalXP += xp;

    const dropKey = e.boss ? 'boss' : e.unique ? 'unique' : e.gatekeeper ? 'hard' : (e.etype.type||'easy');
    const drops = rollDrops(dropKey);
    drops.forEach(itemId => {
      const item = ITEMS.find(i => i.id === itemId);
      if(!item) return;
      if(!G.player.inventory) G.player.inventory = [];
      G.player.inventory.push(itemId);
      G.pendingDrops.push(item);
    });

    if(e.boss) hasBoss = true;
  });

  // State flags
  G.uniqueKilled = true;
  G.gatekeepersKilled = G.gatekeepersNeeded;
  G._gkDialogueShown = false;
  G._bossDialogueShown = false;
  resetAggro();
  G.player.hp = G.player.maxHp;

  // Grant XP
  gainXP(totalXP);

  if(hasBoss){
    AudioEngine.sfxWinBoss();
    G.defeated.add(G.biomeIdx);

    const advanceBiome = ()=>{
      if(G.defeated.size >= 4){ show('victory'); initVictory(); }
      else{ G.biomeIdx++; initWorld(); show('explore'); layoutUI(); showIntro(); }
    };

    _showPendingDrops(()=>{
      if(G.pendingLevelUp){ G._postLevelUp = advanceBiome; showLevelUp(); return; }
      advanceBiome();
    });
  } else {
    AudioEngine.sfxWinNormal();
    show('explore');
    _showPendingDrops(()=>{
      if(G.pendingLevelUp){ G._postLevelUp = ()=>{ show('explore'); startLoop(); }; showLevelUp(); return; }
      startLoop();
    });
  }
}

function cheatUnlockBoss(){
  if(!G.player){ cheatStatus('‚ö† No player yet'); return; }
  // Kill all sentinels and mark unique as defeatable
  G.enemies.forEach(e => {
    if(e.gatekeeper && !e.dead){ e.dead = true; }
  });
  G.gatekeepersKilled = G.gatekeepersNeeded;
  G.uniqueKilled = true;
  G._gkDialogueShown = false;
  // Unlock the boss
  const boss = G.enemies.find(e => e.boss && !e.dead);
  if(boss){
    boss.locked = false;
    boss.dx = (Math.random()-.5)*1.2;
    boss.dy = (Math.random()-.5)*1.2;
    G.bossUnlockFlash = 180;
  }
  updateHUD();
  cheatStatus(boss ? '‚úî Boss unlocked + Sentinels cleared!' : '‚ö† No living boss found (already defeated?)');
}

function cheatLevelUp(){
  if(!G.player){ cheatStatus('‚ö† No player yet'); return; }
  G.player.level = Math.min((G.player.level||1)+1, 20);
  G.player.statPoints = (G.player.statPoints||0)+3;
  G.pendingLevelUp = true;
  closeCheat();
  showLevelUp();
}

</script>
</body>
</html>
